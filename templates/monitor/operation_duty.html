{% extends 'basic.html' %}

{% block page_name %}시스템점검 담당자 관리{% endblock %}

{% block content %}
<div class="flex flex-col gap-8 max-w-4xl mx-auto">
    <!-- Header/Filter Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex flex-col gap-1">
            <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">시스템점검 담당자 설정</h1>
            <p class="text-slate-500 font-medium text-sm">일자별 점검 담당자를 목록 형태로 일괄 설정합니다.</p>
        </div>
        <div class="bg-white px-6 py-3 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
            <form method="get" id="monthFilterForm" class="flex items-center gap-3">
                <label for="monthPicker" class="text-xs font-bold text-slate-400 uppercase tracking-wider">조회 월</label>
                <input type="month" id="monthPicker" name="month" value="{{ selected_month|default:'' }}" 
                       class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-1.5 text-sm font-bold text-slate-700 focus:ring-1 focus:ring-primary focus:border-primary outline-none transition-all">
            </form>
        </div>
    </div>

    <!-- Table Section -->
    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden text-slate-900">
        <div class="overflow-x-auto">
            <table id="manager_table" class="w-full text-center border-collapse">
                <thead class="bg-slate-50 text-slate-500 text-[10px] uppercase font-bold tracking-wider border-b border-slate-200">
                    <tr>
                        <th class="px-8 py-4 text-left">일자</th>
                        <th class="px-8 py-4">배정된 담당자</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-50 text-sm">
                    <!-- Dynamic -->
                </tbody>
            </table>
        </div>
        <div class="px-8 py-6 bg-slate-50/50 border-t border-slate-100 flex justify-end">
            <button id="save-btn" class="flex items-center gap-2 px-8 py-3 rounded-full bg-slate-900 text-white font-extrabold shadow-xl shadow-slate-200 hover:bg-slate-800 transition-all text-sm">
                <span class="material-symbols-outlined text-[18px]">save</span>
                설정 저장하기
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let options = [];

    function loadData(month) {
        fetch("{% url 'get_duty_data' %}?month=" + month)
            .then(response => response.json())
            .then(data => {
                options = data.options;
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';

                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50/50 transition-colors";

                    const tdDate = document.createElement('td');
                    tdDate.className = "px-8 py-4 text-left font-bold text-slate-700";
                    tdDate.textContent = row[0];
                    tr.appendChild(tdDate);

                    const tdSelect = document.createElement('td');
                    tdSelect.className = "px-8 py-3";
                    
                    const select = document.createElement('select');
                    select.className = 'w-full max-w-xs bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm font-medium text-slate-600 focus:ring-1 focus:ring-primary outline-none transition-all cursor-pointer';
                    
                    const emptyOpt = document.createElement('option');
                    emptyOpt.value = '';
                    emptyOpt.textContent = '담당자 미배정';
                    select.appendChild(emptyOpt);

                    options.forEach(opt => {
                        const optEl = document.createElement('option');
                        optEl.value = opt.value;
                        optEl.textContent = opt.label;
                        if (String(opt.value) === String(row[1])) {
                            optEl.selected = true;
                        }
                        select.appendChild(optEl);
                    });

                    tdSelect.appendChild(select);
                    tr.appendChild(tdSelect);
                    tbody.appendChild(tr);
                });
            });
    }

    document.getElementById('monthPicker').addEventListener('change', function () {
        if (this.value) loadData(this.value);
    });

    document.addEventListener('DOMContentLoaded', function () {
        const monthPicker = document.getElementById('monthPicker');
        if (monthPicker.value) loadData(monthPicker.value);

        document.getElementById('save-btn').addEventListener('click', function () {
            const rows = Array.from(document.querySelectorAll('#table-body tr'));
            const data = rows.map(row => {
                const date = row.children[0].textContent.trim();
                const userId = row.children[1].querySelector('select').value;
                return [date, userId];
            });

            fetch('{% url "save_duty_data" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({month: monthPicker.value, data: data})
            })
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') alert('성공적으로 저장되었습니다.');
                else alert('저장에 실패했습니다.');
            })
            .catch(error => alert('오류가 발생했습니다: ' + error));
        });
    });
</script>
{% endblock %}
