{% extends 'base.html' %}
{% load static %}

{% block page_name %}
ì¼ê´„ì‘ì—…
{% endblock %}
{% block content %}
<style>
    .operation-card {
        background-color: #fdfdfe;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 20px;
        transition: box-shadow .3s ease-in-out;
    }
    .operation-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
    }
    .operation-card h5 {
        color: #0056b3;
        font-weight: 600;
    }
    .operation-card p {
        color: #555;
    }
    #resultArea pre {
        background-color: #282c34;
        color: #abb2bf;
        padding: 15px;
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>

<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    
                    <div class="operation-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5>ğŸ“§ ë¦¬ë·°ê²°ê³¼ ë©”ì¼ ë°œì†¡</h5>
                                <p class="mb-0">ë°œì†¡ ëŒ€ê¸° ì¤‘ì¸ AI ë¦¬ë·° ê²°ê³¼ë¥¼ ì´ë©”ì¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                            </div>
                            <button id="sendNotificationsBtn" class="btn btn-primary ml-3">
                                ë°œì†¡í•˜ê¸°
                            </button>
                        </div>
                    </div>

                    <div class="operation-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5>ğŸ¤– AI ë¦¬ë·° ìƒì„±</h5>
                                <p class="mb-0">ì›Œí¬ë¡œê·¸ëŠ” ìˆì§€ë§Œ ë¦¬ë·°ê°€ ì—†ëŠ” ì‚¬ìš©ìì˜ AI ë¦¬ë·°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                            </div>
                            <button id="generateReviewsBtn" class="btn btn-success ml-3">
                                 ìƒì„±í•˜ê¸°
                            </button>
                        </div>
                    </div>

                    <div class="operation-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5>ğŸ”” ëª¨ë‹ˆí„°ë§ ë¯¸ì‹¤ì‹œì ì•Œë¦¼</h5>
                                <p class="mb-0">ëª¨ë‹ˆí„°ë§ ì‹¤ì‹œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  í™•ì¸í•˜ê³  ë¯¸ì‹¤ì‹œëœ ê²½ìš° ì¹´ì¹´ì˜¤ ì•Œë¦¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                            </div>
                            <button id="checkMonitorNotificationsBtn" class="btn btn-warning ml-3">
                                 ì•Œë¦¼ì‹¤í–‰
                            </button>
                        </div>
                    </div>

                </div>
            </div>
            
            <!-- ì‹¤í–‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            <div id="resultArea" class="mt-4" style="display: none;">
                <div class="row">
                    <div class="col-lg-8 offset-lg-2">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">ğŸ“Š ì‹¤í–‰ ê²°ê³¼</h5>
                            </div>
                            <div class="card-body">
                                <div id="resultContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sendBtn = document.getElementById('sendNotificationsBtn');
    const generateBtn = document.getElementById('generateReviewsBtn');
    const checkMonitorBtn = document.getElementById('checkMonitorNotificationsBtn');
    const resultArea = document.getElementById('resultArea');
    const resultContent = document.getElementById('resultContent');

    function showLoading(button, text) {
        button.disabled = true;
        const icon = button.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-spinner fa-spin';
        }
        button.querySelector('span').textContent = ` ${text}`;
    }

    function hideLoading(button, originalText, iconClass) {
        button.disabled = false;
        const icon = button.querySelector('i');
        if (icon) {
            icon.className = iconClass;
        }
        button.querySelector('span').textContent = ` ${originalText}`;
    }

    function showResult(success, stdout, stderr, error) {
        resultArea.style.display = 'block';
        
        let html = '';
        if (success) {
            html = `<div class="alert alert-success"><h6>âœ… ì‹¤í–‰ ì„±ê³µ</h6><pre>${stdout || '(ì¶œë ¥ ì—†ìŒ)'}</pre></div>`;
        } else {
            html = `<div class="alert alert-danger"><h6>âŒ ì‹¤í–‰ ì‹¤íŒ¨</h6>`;
            if (error) {
                html += `<p><strong>ì˜¤ë¥˜:</strong> ${error}</p>`;
            }
            if (stderr) {
                html += `<p><strong>ì—ëŸ¬ ì¶œë ¥:</strong></p><pre>${stderr}</pre>`;
            }
            if (stdout && stdout.trim()) {
                html += `<p><strong>í‘œì¤€ ì¶œë ¥:</strong></p><pre>${stdout}</pre>`;
            }
            html += `</div>`;
        }
        
        resultContent.innerHTML = html;
        resultArea.scrollIntoView({ behavior: 'smooth' });
    }

    sendBtn.addEventListener('click', function() {
        showLoading(sendBtn, 'ì•Œë¦¼ ë°œì†¡ ì¤‘...');
        
        fetch('{% url "batch:send_review_notifications" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(sendBtn, 'ì•Œë¦¼ ë°œì†¡ ì‹¤í–‰', 'fas fa-paper-plane');
            showResult(data.success, data.stdout, data.stderr, data.error);
        })
        .catch(error => {
            hideLoading(sendBtn, 'ì•Œë¦¼ ë°œì†¡ ì‹¤í–‰', 'fas fa-paper-plane');
            showResult(false, '', '', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
        });
    });

    generateBtn.addEventListener('click', function() {
        showLoading(generateBtn, 'ë¦¬ë·° ìƒì„± ì¤‘...');
        
        fetch('{% url "batch:generate_missing_reviews" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(generateBtn, 'ë¦¬ë·° ìƒì„± ì‹¤í–‰', 'fas fa-robot');
            showResult(data.success, data.stdout, data.stderr, data.error);
        })
        .catch(error => {
            hideLoading(generateBtn, 'ë¦¬ë·° ìƒì„± ì‹¤í–‰', 'fas fa-robot');
            showResult(false, '', '', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
        });
    });

    checkMonitorBtn.addEventListener('click', function() {
        showLoading(checkMonitorBtn, 'ì•Œë¦¼ í™•ì¸ ì¤‘...');
        
        fetch('{% url "batch:check_monitor_notifications" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(checkMonitorBtn, 'ì•Œë¦¼ í™•ì¸ ì‹¤í–‰', 'fas fa-bell');
            showResult(data.success, data.stdout, data.stderr, data.error);
        })
        .catch(error => {
            hideLoading(checkMonitorBtn, 'ì•Œë¦¼ í™•ì¸ ì‹¤í–‰', 'fas fa-bell');
            showResult(false, '', '', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
        });
    });

    // Add spans for button text manipulation
    sendBtn.innerHTML = `<i class="fas fa-paper-plane"></i><span> ì•Œë¦¼ ë°œì†¡ ì‹¤í–‰</span>`;
    generateBtn.innerHTML = `<i class="fas fa-robot"></i><span> ë¦¬ë·° ìƒì„± ì‹¤í–‰</span>`;
    checkMonitorBtn.innerHTML = `<i class="fas fa-bell"></i><span> ì•Œë¦¼ í™•ì¸ ì‹¤í–‰</span>`;
});
</script>
{% endblock %}