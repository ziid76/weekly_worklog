{% extends 'base.html' %}
{% load static %}

{% block title %}ì¼ê´„ì‘ì—…{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“‹ ì¼ê´„ì‘ì—…</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">ğŸ“§ ë¦¬ë·° ì•Œë¦¼ ë°œì†¡</h5>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">ë°œì†¡ ëŒ€ê¸° ì¤‘ì¸ AI ë¦¬ë·° ê²°ê³¼ë¥¼ ì´ë©”ì¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                                    <button id="sendNotificationsBtn" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> ì•Œë¦¼ ë°œì†¡ ì‹¤í–‰
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">ğŸ¤– ëˆ„ë½ ë¦¬ë·° ìƒì„±</h5>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">ì›Œí¬ë¡œê·¸ëŠ” ìˆì§€ë§Œ ë¦¬ë·°ê°€ ì—†ëŠ” ì‚¬ìš©ìì˜ AI ë¦¬ë·°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                                    <button id="generateReviewsBtn" class="btn btn-success">
                                        <i class="fas fa-robot"></i> ë¦¬ë·° ìƒì„± ì‹¤í–‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì‹¤í–‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
                    <div id="resultArea" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">ğŸ“Š ì‹¤í–‰ ê²°ê³¼</h5>
                            </div>
                            <div class="card-body">
                                <div id="resultContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sendBtn = document.getElementById('sendNotificationsBtn');
    const generateBtn = document.getElementById('generateReviewsBtn');
    const resultArea = document.getElementById('resultArea');
    const resultContent = document.getElementById('resultContent');

    function showLoading(button, text) {
        button.disabled = true;
        button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
    }

    function hideLoading(button, originalText, icon) {
        button.disabled = false;
        button.innerHTML = `<i class="${icon}"></i> ${originalText}`;
    }

    function showResult(success, stdout, stderr, error) {
        resultArea.style.display = 'block';
        
        let html = '';
        if (success) {
            html = `<div class="alert alert-success"><h6>âœ… ì‹¤í–‰ ì„±ê³µ</h6><pre>${stdout}</pre></div>`;
        } else {
            html = `<div class="alert alert-danger"><h6>âŒ ì‹¤í–‰ ì‹¤íŒ¨</h6>`;
            if (error) {
                html += `<p><strong>ì˜¤ë¥˜:</strong> ${error}</p>`;
            }
            if (stderr) {
                html += `<p><strong>ì—ëŸ¬ ì¶œë ¥:</strong></p><pre>${stderr}</pre>`;
            }
            if (stdout) {
                html += `<p><strong>í‘œì¤€ ì¶œë ¥:</strong></p><pre>${stdout}</pre>`;
            }
            html += `</div>`;
        }
        
        resultContent.innerHTML = html;
        resultArea.scrollIntoView({ behavior: 'smooth' });
    }

    sendBtn.addEventListener('click', function() {
        showLoading(sendBtn, 'ì•Œë¦¼ ë°œì†¡ ì¤‘...');
        
        fetch('{% url "batch:send_review_notifications" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(sendBtn, 'ì•Œë¦¼ ë°œì†¡ ì‹¤í–‰', 'fas fa-paper-plane');
            showResult(data.success, data.stdout, data.stderr, data.error);
        })
        .catch(error => {
            hideLoading(sendBtn, 'ì•Œë¦¼ ë°œì†¡ ì‹¤í–‰', 'fas fa-paper-plane');
            showResult(false, '', '', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
        });
    });

    generateBtn.addEventListener('click', function() {
        showLoading(generateBtn, 'ë¦¬ë·° ìƒì„± ì¤‘...');
        
        fetch('{% url "batch:generate_missing_reviews" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(generateBtn, 'ë¦¬ë·° ìƒì„± ì‹¤í–‰', 'fas fa-robot');
            showResult(data.success, data.stdout, data.stderr, data.error);
        })
        .catch(error => {
            hideLoading(generateBtn, 'ë¦¬ë·° ìƒì„± ì‹¤í–‰', 'fas fa-robot');
            showResult(false, '', '', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
        });
    });
});
</script>
{% endblock %}
