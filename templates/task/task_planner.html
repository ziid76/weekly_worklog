{% extends 'basic.html' %}
{% load static %}

{% block title %}업무일정관리 - ITMS{% endblock %}

{% block content %}
<main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
    <div class="flex-1 flex flex-col gap-6 px-4 md:px-8 py-8 transition-all duration-300" id="main-content">
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
            <div class="flex flex-col gap-1">
                <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">{{ today|date:"Y" }}년 Roadmap</h1>
                <p class="text-slate-500 font-medium">연간 업무 계획을 관리합니다.</p>
            </div>
            <form id="filterForm" method="get" class="flex flex-col md:flex-row items-center gap-4">
                <!-- Status Filter -->
                <div class="flex items-center gap-1 p-1 bg-slate-100 rounded-2xl border border-slate-200 shadow-inner">
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if not current_statuses %}bg-white shadow-sm text-slate-900{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="" class="hidden" onchange="toggleAllStatuses(this)" {% if not current_statuses %}checked{% endif %}>
                        <span class="text-[11px] font-black uppercase">전체 <span class="ml-1 opacity-50">{{ status_counts.total|default:0 }}</span></span>
                    </label>
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if 'in_progress' in current_statuses %}bg-white shadow-sm text-primary{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="in_progress" class="hidden" onchange="this.form.submit()" {% if 'in_progress' in current_statuses %}checked{% endif %}>
                        <div class="size-2 rounded-full bg-primary"></div>
                        <span class="text-[11px] font-black uppercase">진행중 <span class="ml-1 opacity-50">{{ status_counts.in_progress|default:0 }}</span></span>
                    </label>
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if 'todo' in current_statuses %}bg-white shadow-sm text-amber-500{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="todo" class="hidden" onchange="this.form.submit()" {% if 'todo' in current_statuses %}checked{% endif %}>
                        <div class="size-2 rounded-full bg-amber-400"></div>
                        <span class="text-[11px] font-black uppercase">예정 <span class="ml-1 opacity-50">{{ status_counts.todo|default:0 }}</span></span>
                    </label>
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if 'done' in current_statuses %}bg-white shadow-sm text-green-500{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="done" class="hidden" onchange="this.form.submit()" {% if 'done' in current_statuses %}checked{% endif %}>
                        <div class="size-2 rounded-full bg-green-500"></div>
                        <span class="text-[11px] font-black uppercase">완료 <span class="ml-1 opacity-50">{{ status_counts.done|default:0 }}</span></span>
                    </label>
                </div>
                {% if not roadmap_mode %}
                <!-- Category Filter -->
                <div class="relative group" id="categoryDropdown">
                    <button type="button" onclick="toggleCategoryDropdown()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-2xl shadow-sm text-[11px] font-bold text-slate-600 hover:border-primary transition-all">
                        <span class="material-symbols-outlined text-[16px]">category</span>
                        <span>카테고리: {% if not current_categories %}전체{% else %}{{ current_categories|length }}개{% endif %}</span>
                        <span id="categoryChevron" class="material-symbols-outlined text-[16px] transition-transform">expand_more</span>
                    </button>
                    <div id="categoryMenu" class="absolute top-full left-0 mt-2 w-56 bg-white border border-slate-200 rounded-md shadow-xl z-50 hidden py-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <div class="px-3 py-1 mb-1 border-b border-slate-50">
                            <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors group">
                                <input type="checkbox" name="category" value="" class="rounded border-slate-300 text-primary focus:ring-primary size-3.5" onchange="toggleAllCategories(this)" {% if not current_categories %}checked{% endif %}>
                                <span class="text-[11px] font-bold text-slate-700 group-hover:text-primary transition-colors">전체</span>
                            </label>
                        </div>
                        <div class="px-3">
                            {% for cat in categories %}
                            <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors group">
                                <input type="checkbox" name="category" value="{{ cat.pk }}" class="category-checkbox rounded border-slate-300 text-primary focus:ring-primary size-3.5" onchange="updateCategorySelection(this)" {% if cat.pk|stringformat:"i" in current_categories %}checked{% endif %}>
                                <span class="text-[11px] font-bold text-slate-700 group-hover:text-primary transition-colors">{{ cat.name }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <div class="px-3 pt-2 mt-2 border-t border-slate-100 flex justify-end">
                            <button type="button" onclick="submitFilters()" class="w-full py-1.5 bg-slate-900 text-white rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition-all">적용하기</button>
                        </div>
                    </div>
                </div>
                {% endif %}
                <!-- Date Filter -->
                <div class="flex items-center gap-2 px-4 py-1.5 bg-white border border-slate-200 rounded-2xl shadow-sm">
                    <select name="date_type" onchange="this.form.submit()" class="text-[11px] font-bold text-slate-600 bg-transparent border-none outline-none focus:ring-0 cursor-pointer">
                        <option value="start_date" {% if date_type == 'start_date' %}selected{% endif %}>시작일자 기준</option>
                        <option value="created_at" {% if date_type == 'created_at' %}selected{% endif %}>등록일자 기준</option>
                    </select>
                    <div class="w-px h-3 bg-slate-200 mx-1"></div>
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" name="include_prev_year" value="true" onchange="this.form.submit()" {% if include_prev_year %}checked{% endif %} class="rounded border-slate-300 text-primary focus:ring-primary size-3.5">
                        <span class="text-[11px] font-bold text-slate-600 group-hover:text-primary transition-colors">전년 데이터 포함</span>
                    </label>
                </div>

                <a href="{% url 'task_create' %}" class="ml-auto px-6 py-2.5 bg-slate-900 text-white rounded-2xl text-sm font-bold shadow-xl shadow-slate-200 hover:bg-slate-800 hover:-translate-y-0.5 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">add</span>
                    업무 등록
                </a>
            </form>
        </div>

        <!-- Planner Container -->
        <div class="flex-1 flex flex-col bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden min-h-0">
            <!-- Gantt Chart View -->
            <div class="flex-1 overflow-x-auto relative bg-white custom-scrollbar min-h-0" id="gantt-scroll-container">
                {% if tasks %}
                    <!-- Data for JS -->
                    <script id="gantt-data" type="application/json">
                    [
                        {% for task in tasks %}
                        {
                            "id": "{{ task.pk }}",
                            "name": "{{ task.title|escapejs }}",
                            "status": "{{ task.status }}",
                            "status_display": "{{ task.get_status_display }}",
                            "start": "{% if task.start_date %}{{ task.start_date|date:'Y-m-d' }}{% else %}{{ task.created_at|date:'Y-m-d' }}{% endif %}",
                            "end": "{% if task.due_date %}{{ task.due_date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}",
                            "progress": {{ task.progress|default:0 }},
                            "author_name": "{{ task.author.profile.display_name|escapejs }}",
                            "author_avatar": "{% if task.author.profile.avatar %}{{ task.author.profile.avatar.url }}{% endif %}",
                            "author_initial": "{{ task.author.username|slice:':1'|upper }}"
                        }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]
                    </script>

                    <div class="min-w-[{% if years|length > 1 %}2800{% else %}1400{% endif %}px] flex flex-col relative h-full">
                        <!-- Timeline Header -->
                        <div class="flex border-b border-slate-200 sticky top-0 z-40">
                            <div class="w-80 shrink-0 px-8 py-2.5 border-r border-slate-200 font-extrabold text-[12px] uppercase tracking-widest text-slate-400 flex items-center gap-2 text-center bg-white sticky left-0 z-50">
                                Task 
                            </div>
                            <div class="flex-1 grid grid-cols-[repeat({{ total_months }},minmax(0,1fr))] divide-x divide-slate-100 bg-white/90 backdrop-blur-md">
                                {% for year in years %}
                                    {% for m in "123456789012" %}
                                    <div class="text-center py-2.5 text-[12px] font-black text-slate-400 uppercase tracking-tighter">
                                        <span class="block text-[9px] opacity-40">{{ year }}</span>
                                        {{ forloop.counter }}월
                                    </div>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Today Vertical Line (Moved up to cover header) -->
                        <div id="today-indicator" class="absolute top-0 bottom-0 w-[3px] bg-rose-500 z-[45] pointer-events-none hidden transition-opacity duration-500">
                            <!-- Today Marker -->
                            <div class="bg-rose-500 text-white text-[10px] font-black px-3 py-1 rounded-full shadow-[0_4px_20px_rgba(244,63,94,0.5)] absolute top-4 left-1/2 -translate-x-1/2 whitespace-nowrap ring-4 ring-white border border-rose-400">TODAY</div>
                        </div>

                        <!-- Timeline Body -->
                        <div class="relative" id="gantt-rows">
                            <!-- Background Grid -->
                            <div class="absolute inset-0 flex pointer-events-none">
                                <div class="w-80 shrink-0 border-r border-slate-200 bg-slate-50/20"></div>
                                <div class="flex-1 grid grid-cols-[repeat({{ total_months }},minmax(0,1fr))] divide-x divide-slate-100">
                                    {% for i in "123456789012345678901234" %}
                                        {% if forloop.counter <= total_months %}
                                            <div class="h-full"></div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Task List -->
                            <div class="relative z-10 divide-y divide-slate-100" id="gantt-task-list">
                                <!-- Tasks will be rendered by JavaScript -->
                            </div>

                            <!-- Chart Footer -->
                            <div class="relative z-10 flex border-t border-slate-200 bg-slate-50 h-10">
                                <div class="w-80 shrink-0 border-r border-slate-200"></div>
                                <div class="flex-1"></div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="flex flex-col items-center justify-center h-full py-32 px-10 text-center space-y-6">
                        <div class="size-24 bg-slate-50 rounded-[2rem] flex items-center justify-center text-slate-200 border border-slate-100">
                            <span class="material-symbols-outlined text-5xl">event_busy</span>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-slate-900">등록된 업무가 없습니다</h4>
                            <p class="text-slate-400 text-sm mt-1">업무를 등록하여 시각화된 일정을 확인해보세요.</p>
                        </div>
                        <a href="{% url 'task_create' %}" class="px-8 py-3 bg-primary text-white rounded-2xl text-sm font-extrabold shadow-lg shadow-primary/20 hover:scale-105 transition-all">첫 업무 등록하기</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Detail Overlay -->
    <div id="task-overlay" class="fixed top-0 right-0 w-[650px] h-full bg-white shadow-[-20px_0_50px_rgba(0,0,0,0.1)] z-[100] translate-x-full transition-transform duration-500 linear border-l border-slate-200 flex flex-col">
        <div class="px-8 py-6 border-b border-slate-100 flex items-center justify-between bg-slate-50/50 shrink-0">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-primary/10 text-primary flex items-center justify-center">
                    <span class="material-symbols-outlined text-[24px]">description</span>
                </div>
                <h3 class="text-lg font-black text-slate-900 tracking-tight">업무 정보 상세</h3>
            </div>
            <button onclick="closeOverlay()" class="size-12 flex items-center justify-center rounded-2xl bg-white border border-slate-200 text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition-all group">
                <span class="material-symbols-outlined text-[24px] group-hover:rotate-90 transition-transform">close</span>
            </button>
        </div>
        <div id="overlay-content" class="flex-1 overflow-y-auto custom-scrollbar">
            <!-- Content loaded via AJAX from TaskBoardView's partial -->
            <div class="flex flex-col items-center justify-center h-full p-12 text-center text-slate-400 gap-6">
                <div class="relative size-16">
                    <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                </div>
                <div>
                    <p class="text-base font-bold text-slate-600">업무 데이터를 불러오는 중입니다</p>
                    <p class="text-sm font-medium opacity-60 mt-1">네트워크 상태에 따라 시간이 걸릴 수 있습니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay Backdrop -->
    <div id="overlay-backdrop" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[90] hidden opacity-0 transition-opacity duration-300" onclick="closeOverlay()"></div>
</main>
{% endblock %}

{% block extra_js %}
<script>
function toggleAllStatuses(allCheckbox) {
    const checkboxes = document.querySelectorAll('input[name="status"]');
    if (allCheckbox.checked) {
        // '전체'를 선택하면 다른 모든 상태 체크 해제
        checkboxes.forEach(cb => {
            if (cb !== allCheckbox) cb.checked = false;
        });
    } else {
        // '전체'가 이미 체크된 상태에서 클릭하여 해제하려고 하면, 
        // 전체 상태 유지를 위해 다시 체크 상태로 만듬 (전체는 항상 하나 이상의 필터가 있거나 아예 없어야 함)
        allCheckbox.checked = true;
        return; // 변화가 없으므로 제출하지 않음
    }
    allCheckbox.form.submit();
}

function toggleCategoryDropdown() {
    const menu = document.getElementById('categoryMenu');
    const chevron = document.getElementById('categoryChevron');
    const isHidden = menu.classList.contains('hidden');
    
    // Close all other dropdowns if any (not present here yet, but good practice)
    
    if (isHidden) {
        menu.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    } else {
        menu.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

function toggleAllCategories(allCheckbox) {
    const checkboxes = document.querySelectorAll('.category-checkbox');
    if (allCheckbox.checked) {
        checkboxes.forEach(cb => cb.checked = false);
    } else {
        // At least one should be selected or 'All'
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        if (!anyChecked) {
            allCheckbox.checked = true;
        }
    }
}

function updateCategorySelection(cb) {
    const allCheckbox = document.querySelector('input[name="category"][value=""]');
    if (cb.checked) {
        allCheckbox.checked = false;
    } else {
        const checkboxes = document.querySelectorAll('.category-checkbox');
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        if (!anyChecked) {
            allCheckbox.checked = true;
        }
    }
}

function submitFilters() {
    document.getElementById('filterForm').submit();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('categoryDropdown');
    const menu = document.getElementById('categoryMenu');
    const chevron = document.getElementById('categoryChevron');
    
    if (dropdown && !dropdown.contains(event.target)) {
        menu.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
});

$(document).ready(function() {
    if ($('#gantt-data').length) {
        const rawData = JSON.parse(document.getElementById('gantt-data').textContent);
        const roadmapMode = {{ roadmap_mode|yesno:"true,false" }};
        const plannerYears = JSON.parse('{{ years|safe }}');
        const currentYear = parseInt('{{ today.year }}');
        const $taskList = $('#gantt-task-list');
        const $indicator = $('#today-indicator');
        const $scrollContainer = $('#gantt-scroll-container');
        
        const isLeap = (year) => (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        const dayOfYear = (date) => {
            const start = new Date(date.getFullYear(), 0, 0);
            return Math.floor((date - start) / (1000 * 60 * 60 * 24));
        };
        
        const daysInYears = plannerYears.map(y => isLeap(y) ? 366 : 365);
        const totalDaysCount = daysInYears.reduce((a, b) => a + b, 0);

        function getLeftPos(dateStr) {
            // Split YYYY-MM-DD or parse ISO
            let date;
            if (dateStr.includes('T')) {
                date = new Date(dateStr);
            } else {
                const parts = dateStr.split('-');
                date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
            
            const year = date.getFullYear();
            const idx = plannerYears.indexOf(year);
            
            if (idx === -1) {
                if (year < plannerYears[0]) return 0;
                if (year > plannerYears[plannerYears.length - 1]) return 100;
            }
            
            let daysBefore = 0;
            for (let i = 0; i < idx; i++) {
                daysBefore += daysInYears[i];
            }
            
            // local day of year to be consistent
            const startOfYear = new Date(year, 0, 0);
            const diffInMs = date.getTime() - startOfYear.getTime();
            const dayOfYr = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            
            return ((daysBefore + dayOfYr) / totalDaysCount) * 100;
        }

        function renderPlanner() {
            $taskList.empty();
            rawData.forEach(task => {
                const startPos = getLeftPos(task.start);
                const endPos = getLeftPos(task.end);
                let width = endPos - startPos;
                if (width < 0.2) width = 0.2; // Min width for 2-year view

                const statusColors = {
                    'in_progress': { 
                        bar: 'bg-primary shadow-lg shadow-primary/20', 
                        text: 'text-primary', 
                        label: 'In Progress', 
                        bg: 'bg-primary/5 hover:bg-primary/10 border-primary/20' 
                    },
                    'todo': { 
                        bar: 'bg-amber-400 shadow-lg shadow-amber-400/20', 
                        text: 'text-amber-700', 
                        label: 'Scheduled', 
                        bg: 'bg-amber-50 hover:bg-amber-100/50 border-amber-200/50' 
                    },
                    'done': { 
                        bar: 'bg-green-500 shadow-lg shadow-green-500/20', 
                        text: 'text-green-700', 
                        label: 'Completed', 
                        bg: 'bg-green-50 hover:bg-green-100/50 border-green-200/50' 
                    },
                    'dropped': { 
                        bar: 'bg-rose-500 shadow-lg shadow-rose-500/20', 
                        text: 'text-rose-700', 
                        label: 'Dropped', 
                        bg: 'bg-rose-50 hover:bg-rose-100/50 border-rose-200/50' 
                    }
                };
                const config = statusColors[task.status] || { bar: 'bg-slate-300', text: 'text-slate-500', label: 'Waiting', bg: 'bg-slate-50 border-slate-200' };

                const rowHtml = `
                    <div class="flex hover:bg-slate-50 transition-all group h-16 relative cursor-pointer" onclick="openOverlay('${task.id}')">
                        <div class="w-80 shrink-0 px-8 border-r border-slate-200 flex items-center gap-4 bg-white sticky left-0 z-50 group-hover:bg-slate-50 transition-colors shadow-[8px_0_15px_-5px_rgba(0,0,0,0.03)] focus:z-51">
                            <div class="size-3 rounded-full ${config.bar} ring-4 ring-white shadow-md"></div>
                            <div class="min-w-0">
                                <p class="text-[13px] font-extrabold text-slate-800 truncate group-hover:text-primary transition-colors">${task.name}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[9px] font-black uppercase tracking-tighter text-slate-400 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-[12px]">calendar_today</span>
                                        ${task.start.split('-').join('.')} ~ ${task.end.split('-').join('.')}
                                    </span>
                                    ${roadmapMode ? `
                                        <div class="flex items-center gap-1.5 ml-1 pl-2 border-l border-slate-200">
                                            <div class="w-4 h-4 rounded-full bg-slate-100 flex items-center justify-center text-[8px] font-bold text-slate-500 uppercase overflow-hidden ring-1 ring-slate-100" title="${task.author_name}">
                                                ${task.author_avatar ? `<img src="${task.author_avatar}" class="w-full h-full object-cover">` : task.author_initial}
                                            </div>
                                            <span class="text-[10px] font-bold text-slate-500 truncate max-w-[60px]">${task.author_name}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 relative px-0 py-4">
                            <div class="absolute h-8 rounded-xl border flex items-center px-4 transition-all duration-300 ${config.bg} hover:shadow-xl hover:shadow-slate-200/50 hover:scale-[1.01]" 
                                 style="left: ${startPos}%; width: ${width}%;">
                                <div class="absolute left-1.5 top-1.5 bottom-1.5 w-1.5 ${config.bar} rounded-full"></div>
                                <div class="flex items-center gap-2 overflow-hidden pl-2">
                                    <span class="text-[10px] font-black uppercase tracking-widest truncate ${config.text}">${config.label}</span>
                                    <span class="text-[9px] font-bold opacity-60 ${config.text}">${task.progress}%</span>
                                </div>
                                <div class="absolute bottom-0 left-0 h-[2px] bg-white/60 rounded-full mb-[1px]" style="width: ${task.progress}%; margin-left: 10px; width: calc(${task.progress}% - 20px);"></div>
                            </div>
                        </div>
                    </div>
                `;
                $taskList.append(rowHtml);
            });

            // Adjust Today Indicator
            const now = new Date();
            const todayYear = now.getFullYear();
            if (plannerYears.includes(todayYear)) {
                const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                const perc = getLeftPos(todayStr);
                $indicator.css({
                    'left': `calc(20rem + ((${perc} / 100) * (100% - 20rem)))`,
                }).show().css('opacity', 1);
            }
            
            // Auto-scroll to current year
            setTimeout(() => {
                const currentYearIdx = plannerYears.indexOf(currentYear);
                if (currentYearIdx !== -1) {
                    const timelineWidth = $scrollContainer[0].scrollWidth - 320; // total - sidebar
                    const scrollTarget = (daysInYears.slice(0, currentYearIdx).reduce((a,b)=>a+b, 0) / totalDaysCount) * timelineWidth;
                    $scrollContainer.animate({ scrollLeft: scrollTarget }, 800);
                }
            }, 100);
        }

        renderPlanner();
        $(window).on('resize', renderPlanner);
    }
});

function openOverlay(taskId) {
    const $overlay = $('#task-overlay');
    const $backdrop = $('#overlay-backdrop');
    const $content = $('#overlay-content');
    const $mainContent = $('#main-content');

    // Loading State
    $content.html(`
        <div class="flex flex-col items-center justify-center h-full p-12 text-center text-slate-400 gap-6">
            <div class="relative size-16">
                <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
            </div>
            <div>
                <p class="text-base font-bold text-slate-600">업무 데이터를 불러오는 중입니다</p>
                <p class="text-sm font-medium opacity-60 mt-1">잠시만 기다려주세요.</p>
            </div>
        </div>
    `);
    
    $overlay.removeClass('translate-x-full');
    $backdrop.removeClass('hidden').addClass('opacity-100');
    // For smaller screens we might not push content, but on large scale we do
    if (window.innerWidth > 1400) {
        $mainContent.addClass('md:mr-[550px]');
    }

    // Load Task Detail Part
    fetch(`/task/board/partial/${taskId}/`)
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            $content.html(html);
        })
        .catch(err => {
            $content.html(`
                <div class="flex flex-col items-center justify-center h-full p-12 text-center gap-6">
                    <span class="material-symbols-outlined text-red-500 text-6xl">error</span>
                    <p class="text-lg font-bold text-slate-800">데이터를 불러오지 못했습니다</p>
                    <button onclick="openOverlay('${taskId}')" class="px-6 py-2 bg-slate-100 rounded-xl text-sm font-bold hover:bg-slate-200 transition-all">다시 시도</button>
                </div>
            `);
        });
}

function closeOverlay() {
    const $overlay = $('#task-overlay');
    const $backdrop = $('#overlay-backdrop');
    const $mainContent = $('#main-content');

    $overlay.addClass('translate-x-full');
    $backdrop.removeClass('opacity-100');
    $mainContent.removeClass('md:mr-[550px]');
    
    setTimeout(() => {
        $backdrop.addClass('hidden');
    }, 500);
}

// Handle ESC key to close overlay
$(document).on('keyup', function(e) {
    if (e.key === "Escape") closeOverlay();
});
</script>

<style>
/* Custom Scrollbar */
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #e2e8f0;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #cbd5e1;
}

/* Transitions */
#task-overlay {
    transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}
#main-content {
    transition: margin-right 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}
</style>
{% endblock %}
