{% extends 'basic.html' %}
{% load static %}

{% block page_name %}업무 {% if object %}수정{% else %}등록{% endif %}{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">업무 {% if object %}수정{% else %}등록{% endif %}</h1>
            <p class="text-slate-500">업무의 상세 정보를 입력하고 담당자 및 일정을 관리합니다.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-200 flex items-center gap-2">
            <span class="material-symbols-outlined text-slate-400">assignment</span>
            <h3 class="font-bold text-slate-900 text-sm">업무 정보 입력</h3>
        </div>

        <form method="post" enctype="multipart/form-data" id="taskForm" class="p-8 space-y-8">
            {% csrf_token %}

            <!-- Title -->
            <div class="space-y-1.5">
                <label for="{{ form.title.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">업무명</label>
                <div class="relative">
                    {{ form.title }}
                    {% if form.title.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.title.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- Description -->
            <div class="space-y-1.5">
                <label for="{{ form.description.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">업무 상세 내용</label>
                <div class="relative">
                    {{ form.description }}
                    {% if form.description.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.description.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Status -->
                <div class="space-y-1.5">
                    <label for="{{ form.status.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">상태</label>
                    <div class="relative">
                        {{ form.status }}
                        {% if form.status.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.status.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                <!-- Priority -->
                <div class="space-y-1.5">
                    <label for="{{ form.priority.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">우선순위</label>
                    <div class="relative">
                        {{ form.priority }}
                        {% if form.priority.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.priority.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                <!-- Category -->
                <div class="space-y-1.5">
                    <label for="{{ form.category.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">카테고리</label>
                    <div class="relative">
                        {{ form.category }}
                        {% if form.category.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.category.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Start Date -->
                <div class="space-y-1.5">
                    <label for="{{ form.start_date.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">시작일</label>
                    <div class="relative">
                        {{ form.start_date }}
                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-[20px]">calendar_today</span>
                        {% if form.start_date.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.start_date.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                <!-- Due Date -->
                <div class="space-y-1.5">
                    <label for="{{ form.due_date.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">마감일</label>
                    <div class="relative">
                        {{ form.due_date }}
                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-[20px]">event_available</span>
                        {% if form.due_date.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.due_date.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Team -->
                <div class="space-y-1.5">
                    <label for="{{ form.team.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">담당 팀</label>
                    <div class="relative">
                        {{ form.team }}
                        {% if form.team.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.team.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                <!-- Progress -->
                <div class="space-y-1.5">
                    <label for="{{ form.progress.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">진행률 (%)</label>
                    <div class="relative">
                        {{ form.progress }}
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">%</span>
                        {% if form.progress.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.progress.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Assigned To Selection -->
            <div class="space-y-4 pt-6 border-t border-slate-100">
                <div class="flex justify-between items-center">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">담당자</label>
                        <p class="text-xs text-slate-400 font-medium">이 업무를 수행할 담당자들을 선택하세요.</p>
                    </div>
                    <button type="button" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition-all font-bold text-xs shadow-sm" 
                            onclick="openUserSelectorModal()">
                        <span class="material-symbols-outlined text-sm text-white">person_add</span>
                        담당자 추가
                    </button>
                    <!-- Hidden multiselect for Django form -->
                    <select id="id_assigned_to" name="assigned_to" multiple class="hidden">
                        {% if object %}
                        {% for user in object.assigned_to.all %}
                        <option value="{{ user.id }}" selected>{{ user.profile.get_korean_name }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div id="selectedUsersDisplay" class="flex flex-wrap gap-2 min-h-[48px] p-4 rounded-xl bg-slate-50 border border-slate-100 border-dashed">
                    <!-- Dynamic -->
                </div>
                {% if form.assigned_to.errors %}
                <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                    <span class="material-symbols-outlined text-[14px]">error</span>
                    {{ form.assigned_to.errors.0 }}
                </p>
                {% endif %}
            </div>

            <!-- Attachments Section -->
            <div class="space-y-4 pt-4 border-t border-slate-100">
                <div class="flex items-center justify-between">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">첨부파일</label>
                        <p class="text-xs text-slate-400 font-medium">업무 관련 참조 파일을 업로드하세요.</p>
                    </div>
                    <button type="button" id="addFileBtn" 
                            class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all">
                        <span class="material-symbols-outlined text-[16px]">add</span>
                        파일 추가
                    </button>
                </div>
                <input type="file" id="fileInput" name="files" multiple class="hidden">
                <div id="fileList" class="flex flex-wrap gap-2">
                    <!-- New Files (Dynamic Tags) -->
                </div>

                <!-- Existing Files -->
                {% if object and object.files.all %}
                <div class="mt-4 space-y-2">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">기존 첨부파일</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {% for file in object.files.all %}
                        <div class="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl shadow-sm group">
                            <div class="flex items-center gap-3 min-w-0">
                                <span class="material-symbols-outlined text-primary text-[20px]">description</span>
                                <span class="text-xs font-medium text-slate-700 truncate" title="{{ file.original_name }}">{{ file.original_name }}</span>
                            </div>
                            <a href="{% url 'delete_file' file.id %}" onclick="return confirm('파일을 삭제하시겠습니까?')" class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="삭제">
                                <span class="material-symbols-outlined text-sm">close</span>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Form Actions -->
            <div class="pt-8 border-t border-slate-100 flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" onclick="window.history.back()" class="px-8 py-2.5 rounded-full border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                    취소하기
                </button>
                <button type="submit" class="px-8 py-2.5 rounded-full bg-primary text-white font-bold text-sm hover:bg-[#0062a3] transition-all shadow-xl shadow-primary/25 flex items-center justify-center gap-2 transform hover:-translate-y-0.5 active:translate-y-0">
                    <span class="material-symbols-outlined text-lg font-bold">check</span>
                    {% if object %}변경사항 저장{% else %}새로운 업무 생성{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Force styling on Django widgets */
    #taskForm input[type="text"], 
    #taskForm input[type="date"], 
    #taskForm input[type="number"], 
    #taskForm select, 
    #taskForm textarea {
        width: 100%;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem; /* rounded-xl */
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #0f172a;
        transition: all 0.2s;
        outline: none;
    }
    #taskForm input[type="text"]:focus, 
    #taskForm input[type="date"]:focus, 
    #taskForm input[type="number"]:focus, 
    #taskForm select:focus, 
    #taskForm textarea:focus {
        border-color: #3b82f6; /* primary */
        box-shadow: 0 0 0 1px #3b82f6;
    }
    #taskForm textarea {
        min-height: 150px;
    }
    
    /* Remove default arrow for date icon positioning */
    #taskForm input[type="date"]::-webkit-calendar-picker-indicator {
        opacity: 0;
        cursor: pointer;
    }
</style>

<!-- Include User Selector Modal -->
{% include 'task/partials/user_selector_modal.html' with multi_select=True %}

<script id="assigned-users-data" type="application/json">
[
    {% if object %}
    {% for user in object.assigned_to.all %}
    {
        "id": "{{ user.id }}",
        "name": "{{ user.profile.get_korean_name }}",
        "position": "{{ user.profile.position }}",
        "avatar_url": "{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% endif %}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
    {% endif %}
]
</script>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize User Selector
        const assignedUsersDataElement = document.getElementById('assigned-users-data');
        if (assignedUsersDataElement) {
            initializeUserSelector(JSON.parse(assignedUsersDataElement.textContent));
        }

        // File Attachment Handling
        const fileInput = document.getElementById('fileInput');
        const fileListDisplay = document.getElementById('fileList');
        const addFileBtn = document.getElementById('addFileBtn');
        const form = document.getElementById('taskForm');
        let selectedFiles = [];

        addFileBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', () => {
            const files = Array.from(fileInput.files);
            files.forEach(file => {
                if (selectedFiles.some(f => f.name === file.name)) {
                    alert(`${file.name}은(는) 이미 추가되었습니다.`);
                    return;
                }
                selectedFiles.push(file);
                renderFileList();
            });
            fileInput.value = '';
        });

        function renderFileList() {
            fileListDisplay.innerHTML = selectedFiles.map((file, index) => `
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-50 border border-blue-100 text-xs font-bold text-blue-600 shadow-sm group">
                    <span class="max-w-[150px] truncate text-[11px]">${file.name}</span>
                    <button type="button" class="remove-file text-blue-300 hover:text-rose-500 transition-colors" data-index="${index}">
                        <span class="material-symbols-outlined text-[16px]">close</span>
                    </button>
                </div>
            `).join('');

            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = e.currentTarget.dataset.index;
                    selectedFiles.splice(idx, 1);
                    renderFileList();
                });
            });
        }

        // Form Submit Handling (to include dynamically added files)
        form.addEventListener('submit', (e) => {
            // Check if there are dynamically added files to include
            if (selectedFiles.length > 0) {
                e.preventDefault();
                const formData = new FormData(form);
                
                // Add dynamically selected files
                selectedFiles.forEach(file => {
                    formData.append('files', file); // 'files' is the field name in task_form
                });

                // Submit via Fetch
                let submitBtn = form.querySelector('button[type="submit"]');
                if (!submitBtn) {
                    submitBtn = document.querySelector(`button[type="submit"][form="${form.id}"]`);
                }
                const originalBtnContent = submitBtn ? submitBtn.innerHTML : '';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">refresh</span> 저장 중...';
                }

                fetch(form.action || window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (response.ok) {
                        window.location.reload();
                    } else {
                        return response.text().then(text => {
                            document.documentElement.innerHTML = text;
                        });
                    }
                })
                .catch(error => {
                    console.error('Save error:', error);
                    alert("저장 중 오류가 발생했습니다.");
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnContent;
                    }
                });
            }
            // If no dynamic files, regular form submission works fine
        });
    });
</script>
{% endblock %}
