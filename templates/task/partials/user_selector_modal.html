<!-- User Selector Modal -->
<div id="userSelectorModal" class="hidden relative z-50" aria-labelledby="userSelectorModalLabel" role="dialog" aria-modal="true" data-multi-select="{{ multi_select|default:'false'|lower }}">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity" onclick="closeUserSelectorModal()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                    <h3 class="text-lg font-bold text-slate-900" id="userSelectorModalLabel">담당자 선택</h3>
                    <button type="button" class="text-slate-400 hover:text-slate-500 transition-colors" onclick="closeUserSelectorModal()">
                        <span class="material-symbols-outlined text-[24px]">close</span>
                    </button>
                </div>
                
                <div class="p-6">
                    <!-- Search Input -->
                    <div class="mb-6">
                        <div class="relative group">
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">search</span>
                            <input type="text" id="userSearchInput" 
                                   class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3 pl-12 pr-4 text-sm text-slate-900 focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-slate-400 outline-none transition-all shadow-sm" 
                                   placeholder="이름, 아이디, 직급 검색...">
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm min-h-[300px]">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-slate-500 text-[10px] uppercase font-bold tracking-wider border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3">사용자</th>
                                        <th class="px-6 py-3 text-center">아이디</th>
                                        <th class="px-6 py-3 text-center">직급</th>
                                        <th class="px-6 py-3 text-right">선택</th>
                                    </tr>
                                </thead>
                                <tbody id="userSearchResults" class="divide-y divide-slate-100 text-sm text-slate-700">
                                    <tr>
                                        <td colspan="4" class="px-6 py-12 text-center text-slate-400">
                                            <div class="flex flex-col items-center gap-2">
                                                <span class="material-symbols-outlined">person_search</span>
                                                <p>검색 키워드를 입력하세요.</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="mt-6 flex justify-center">
                        <nav aria-label="User pagination" id="userPagination" class="flex items-center gap-1">
                            <!-- Dynamic -->
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        let currentPage = 1;
        let searchQuery = '';
        let selectedUsers = [];

        const modal = document.getElementById('userSelectorModal');
        const multiSelect = modal.dataset.multiSelect === 'true';
        const searchInput = document.getElementById('userSearchInput');
        const searchResults = document.getElementById('userSearchResults');
        const pagination = document.getElementById('userPagination');

        // Open Modal Function
        window.openUserSelectorModal = function() {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            currentPage = 1;
            searchQuery = '';
            searchInput.value = '';
            loadUsers(); // Initial load
        };

        // Close Modal Function
        window.closeUserSelectorModal = function() {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        };

        // Search with debouncing
        let searchTimeout;
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function () {
                searchQuery = searchInput.value.trim();
                currentPage = 1;
                loadUsers();
            }, 300);
        });

        // Load users via AJAX
        function loadUsers() {
            if (searchResults) {
                searchResults.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400"><div class="flex flex-col items-center gap-2"><span class="material-symbols-outlined animate-spin text-primary">loading</span><p>사용자를 찾는 중...</p></div></td></tr>`;
            }
            
            const teamId = document.getElementById('id_team')?.value || '';
            const url = `/useraccounts/ajax/users/search/?q=${encodeURIComponent(searchQuery)}&team_id=${teamId}&page=${currentPage}&page_size=10`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    renderUsers(data.users);
                    renderPagination(data.pagination);
                })
                .catch(error => {
                    console.error('User search error:', error);
                    if (searchResults) {
                        searchResults.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-red-400">오류가 발생했습니다.</td></tr>';
                    }
                });
        }

        function renderUsers(users) {
            if (!searchResults) return;
            if (users.length === 0) {
                searchResults.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400 font-medium">검색 결과가 없습니다.</td></tr>';
                return;
            }

            searchResults.innerHTML = users.map(user => `
                <tr class="hover:bg-slate-50 transition-colors group cursor-pointer" onclick="selectUserFromRow('${user.id}', '${user.name}', '${user.position}', '${user.avatar_url || ''}')">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded-full overflow-hidden bg-slate-100 flex items-center justify-center border border-slate-200">
                                ${user.avatar_url ? `<img src="${user.avatar_url}" class="w-full h-full object-cover">` : `<span class="text-xs font-bold text-slate-400">${user.name[0]}</span>`}
                            </div>
                            <span class="font-bold text-slate-900">${user.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center text-slate-500 font-medium">${user.username}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-600">${user.position || '-'}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button type="button" class="p-2 text-slate-300 group-hover:text-primary group-hover:bg-blue-50 rounded-full transition-all flex items-center justify-center ml-auto">
                            <span class="material-symbols-outlined text-[20px]">add_circle</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.selectUserFromRow = function(id, name, position, avatar_url) {
            selectUser(id, name, position, avatar_url);
        };

        function renderPagination(paginationData) {
            if (!pagination) return;
            if (paginationData.total_pages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            if (paginationData.has_previous) {
                html += `<button type="button" onclick="goToUserPage(${paginationData.previous_page})" class="p-2 rounded-lg bg-white border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all flex items-center justify-center"><span class="material-symbols-outlined text-sm">chevron_left</span></button>`;
            }

            for (let i = 1; i <= paginationData.total_pages; i++) {
                if (i === paginationData.current_page) {
                    html += `<span class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary text-white font-bold text-sm shadow-lg shadow-primary/20">${i}</span>`;
                } else if (i === 1 || i === paginationData.total_pages || (i >= paginationData.current_page - 1 && i <= paginationData.current_page + 1)) {
                    html += `<button type="button" onclick="goToUserPage(${i})" class="w-10 h-10 flex items-center justify-center rounded-lg bg-white border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 transition-all">${i}</button>`;
                } else if (i === paginationData.current_page - 2 || i === paginationData.current_page + 2) {
                    html += `<span class="text-slate-300">...</span>`;
                }
            }

            if (paginationData.has_next) {
                html += `<button type="button" onclick="goToUserPage(${paginationData.next_page})" class="p-2 rounded-lg bg-white border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all flex items-center justify-center"><span class="material-symbols-outlined text-sm">chevron_right</span></button>`;
            }

            pagination.innerHTML = html;
        }

        window.goToUserPage = function(page) {
            currentPage = page;
            loadUsers();
        };

        function selectUser(id, name, position, avatar_url) {
            if (multiSelect) {
                if (!selectedUsers.find(u => u.id == id)) {
                    selectedUsers.push({ id, name, position, avatar_url });
                    updateSelectedUsersDisplay();
                }
            } else {
                selectedUsers = [{ id, name, position, avatar_url }];
                updateSelectedUsersDisplay();
                closeUserSelectorModal();
            }
        }

        function updateSelectedUsersDisplay() {
            const displayContainer = document.getElementById('selectedUsersDisplay');
            const hiddenSelect = document.getElementById('id_assigned_to');
            
            if (hiddenSelect) {
                hiddenSelect.innerHTML = selectedUsers.map(u => `<option value="${u.id}" selected>${u.name}</option>`).join('');
            }

            if (displayContainer) {
                if (selectedUsers.length > 0) {
                    displayContainer.innerHTML = selectedUsers.map((u, index) => `
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 text-white text-xs font-bold shadow-sm group">
                            <div class="size-5 rounded-full overflow-hidden bg-white/20 flex items-center justify-center">
                                ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full object-cover">` : `<span class="text-[10px]">${u.name[0]}</span>`}
                            </div>
                            <span>${u.name} ${u.position ? `(${u.position})` : ''}</span>
                            <button type="button" onclick="removeSelectedUser(${index})" class="text-white/50 hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-sm">close</span>
                            </button>
                        </div>
                    `).join('');
                } else {
                    displayContainer.innerHTML = '<p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">담당자가 선택되지 않았습니다.</p>';
                }
            }
        }

        window.removeSelectedUser = function (index) {
            selectedUsers.splice(index, 1);
            updateSelectedUsersDisplay();
        };

        window.initializeUserSelector = function (initialUsers) {
            selectedUsers = initialUsers || [];
            updateSelectedUsersDisplay();
        };
    })();
</script>
