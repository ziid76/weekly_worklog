{% extends "basic.html" %}
{% load static %}
{% load markdown_extras %}

{% block page_name %}주간업무 개인별 조회{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex flex-col gap-1">
            <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">주간업무 개인별 조회</h1>
            <p class="text-slate-500 font-medium text-sm">팀원별 주간업무 이력을 조회하고 AI 분석을 수행합니다.</p>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="bg-white rounded-[32px] border border-slate-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-200 flex items-center gap-2">
            <span class="material-symbols-outlined text-slate-400 text-[20px]">filter_list</span>
            <h2 class="text-sm font-bold text-slate-900">조회 조건 설정</h2>
        </div>
        <div class="p-6">
            <form method="get" action="{% url 'personal_report_history' %}" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                <div class="md:col-span-2 flex flex-col gap-1.5">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">팀원</label>
                    <select name="user_id" id="user_id" class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl px-4 py-3 text-slate-900 font-medium focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none appearance-none">
                        <option value="">담당자선택</option>
                        {% for member in team_members %}
                        <option value="{{ member.id }}" {% if selected_user_id|stringformat:"s" == member.id|stringformat:"s" %}selected{% endif %}>
                            {{ member.profile.display_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="md:col-span-7 grid grid-cols-1 sm:grid-cols-5 gap-2 items-end">
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">시작년도</label>
                        <select name="start_year" id="start_year" class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl px-4 py-3 text-slate-900 font-medium focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none appearance-none">
                            {% for year in year_choices %}
                            <option value="{{ year }}" {% if start_year|stringformat:"s" == year|stringformat:"s" %}selected{% endif %}>{{ year }}년</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">시작주차</label>
                        <select name="start_week" id="start_week" class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl px-4 py-3 text-slate-900 font-medium focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none appearance-none">
                        </select>
                    </div>
                    
                    <div class="flex items-center justify-center">
                        <span class="text-slate-400 font-bold">~</span>
                    </div>
                    
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">종료년도</label>
                        <select name="end_year" id="end_year" class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl px-4 py-3 text-slate-900 font-medium focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none appearance-none">
                            {% for year in year_choices %}
                            <option value="{{ year }}" {% if end_year|stringformat:"s" == year|stringformat:"s" %}selected{% endif %}>{{ year }}년</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">종료주차</label>
                        <select name="end_week" id="end_week" class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl px-4 py-3 text-slate-900 font-medium focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none appearance-none">
                        </select>
                    </div>
                </div>

                <div class="md:col-span-3 flex gap-2">
                    <button type="submit" class="flex-1 h-[50px] rounded-2xl bg-slate-900 text-white font-bold text-sm shadow-lg shadow-slate-200 hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">search</span>
                        조회
                    </button>
                    <button type="button" id="ai-analysis-btn" class="flex-1 h-[50px] rounded-2xl bg-amber-500 text-white font-bold text-sm shadow-lg shadow-amber-200 hover:bg-amber-600 transition-all flex items-center justify-center gap-2 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none" {% if not selected_user_id %}disabled{% endif %}>
                        <span class="material-symbols-outlined text-[18px]">psychology</span>
                        AI 분석
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if selected_user_id and worklogs_data %}
    <!-- Report Content -->
    <div class="bg-white rounded-[32px] border border-slate-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-200 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-slate-400 text-[20px]">analytics</span>
                <h2 class="text-sm font-bold text-slate-900">조회 결과</h2>
            </div>
            <div class="flex gap-1">
                <button id="btn-format1" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-xs font-bold transition-all">금주/차주</button>
                <button id="btn-format2" class="px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 text-xs font-bold hover:bg-slate-50 transition-all">전주/금주</button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Format 1: This Week / Next Week -->
            <div id="format1-table">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="py-4 px-6 text-[10px] uppercase tracking-wider font-bold text-slate-400 w-32">주차</th>
                                <th class="py-4 px-6 text-[10px] uppercase tracking-wider font-bold text-slate-400">금주 실적</th>
                                <th class="py-4 px-6 text-[10px] uppercase tracking-wider font-bold text-slate-400">차주 계획</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">
                            {% for data in worklogs_data %}
                            <tr class="hover:bg-slate-50/50 transition-colors">
                                <td class="py-4 px-6">
                                    <span class="text-sm font-bold text-slate-900">{{ data.worklog.year }}년 {{ data.worklog.week_number }}주차</span>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="markdown-content prose prose-slate prose-sm max-w-none">
                                        {% if data.worklog.this_week_work %}
                                            {{ data.worklog.this_week_work|markdown }}
                                        {% else %}
                                            <p class="text-slate-400 italic">작성된 내용이 없습니다.</p>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="markdown-content prose prose-slate prose-sm max-w-none">
                                        {% if data.worklog.next_week_plan %}
                                            {{ data.worklog.next_week_plan|markdown }}
                                        {% else %}
                                            <p class="text-slate-400 italic">작성된 계획이 없습니다.</p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Format 2: Previous Week Plan / This Week -->
            <div id="format2-table" style="display: none;">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="py-4 px-6 text-[10px] uppercase tracking-wider font-bold text-slate-400 w-32">주차</th>
                                <th class="py-4 px-6 text-[10px] uppercase tracking-wider font-bold text-slate-400">전주 계획</th>
                                <th class="py-4 px-6 text-[10px] uppercase tracking-wider font-bold text-slate-400">금주 실적</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">
                            {% for data in worklogs_data %}
                            <tr class="hover:bg-slate-50/50 transition-colors">
                                <td class="py-4 px-6">
                                    <span class="text-sm font-bold text-slate-900">{{ data.worklog.year }}년 {{ data.worklog.week_number }}주차</span>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="markdown-content prose prose-slate prose-sm max-w-none">
                                        {% if data.previous_week_plan %}
                                            {{ data.previous_week_plan|markdown }}
                                        {% else %}
                                            <p class="text-slate-400 italic">작성된 내용이 없습니다.</p>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="markdown-content prose prose-slate prose-sm max-w-none">
                                        {% if data.worklog.this_week_work %}
                                            {{ data.worklog.this_week_work|markdown }}
                                        {% else %}
                                            <p class="text-slate-400 italic">작성된 계획이 없습니다.</p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% elif selected_user_id %}
    <div class="bg-amber-50 border border-amber-200 rounded-[24px] p-6 flex items-center gap-3">
        <span class="material-symbols-outlined text-amber-600 text-[24px]">warning</span>
        <p class="text-amber-800 font-medium">선택된 기간에 해당하는 주간업무 데이터가 없습니다.</p>
    </div>
    {% endif %}
</div>

<!-- AI Analysis Modal -->
<div id="ai-analysis-modal" class="hidden relative z-50" aria-labelledby="aiAnalysisModalLabel" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="relative transform overflow-hidden rounded-[32px] bg-white text-left shadow-2xl transition-all w-full max-w-5xl h-[80vh] flex flex-col border border-slate-100">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">psychology</span>
                        AI 주간업무 분석 결과
                    </h3>
                    <button type="button" class="w-8 h-8 rounded-full flex items-center justify-center bg-white border border-slate-200 text-slate-400 hover:text-slate-600 hover:shadow-sm transition-all" onclick="closeAiAnalysisModal()">
                        <span class="material-symbols-outlined text-[20px]">close</span>
                    </button>
                </div>
                <div class="flex-1 p-6 overflow-y-auto">
                    <div id="ai-analysis-loading" class="flex flex-col items-center justify-center h-full text-slate-400">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
                        <p class="text-sm font-medium">Gemini가 주간업무를 분석하고 있습니다. 잠시만 기다려주세요...</p>
                    </div>
                    <div id="ai-analysis-result" style="display: none;">
                        <!-- Results will be populated here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Format toggle buttons
    const btnFormat1 = document.getElementById('btn-format1');
    const btnFormat2 = document.getElementById('btn-format2');
    const tableFormat1 = document.getElementById('format1-table');
    const tableFormat2 = document.getElementById('format2-table');

    if (btnFormat1 && btnFormat2 && tableFormat1 && tableFormat2) {
        btnFormat1.addEventListener('click', function() {
            tableFormat1.style.display = 'block';
            tableFormat2.style.display = 'none';
            btnFormat1.className = 'px-4 py-2 rounded-xl bg-slate-900 text-white text-xs font-bold transition-all';
            btnFormat2.className = 'px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 text-xs font-bold hover:bg-slate-50 transition-all';
        });

        btnFormat2.addEventListener('click', function() {
            tableFormat1.style.display = 'none';
            tableFormat2.style.display = 'block';
            btnFormat2.className = 'px-4 py-2 rounded-xl bg-slate-900 text-white text-xs font-bold transition-all';
            btnFormat1.className = 'px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 text-xs font-bold hover:bg-slate-50 transition-all';
        });
    }

    // Dynamic week dropdowns
    const weekData = JSON.parse('{{ week_data_json|escapejs }}');
    const startYearSelect = document.getElementById('start_year');
    const startWeekSelect = document.getElementById('start_week');
    const endYearSelect = document.getElementById('end_year');
    const endWeekSelect = document.getElementById('end_week');

    const selectedStartWeek = '{{ start_week }}';
    const selectedEndWeek = '{{ end_week }}';

    function updateWeekOptions(yearSelect, weekSelect, selectedWeek) {
        const selectedYear = yearSelect.value;
        const weeks = weekData[selectedYear] || [];
        
        weekSelect.innerHTML = '';

        weeks.forEach(function(weekInfo) {
            const option = document.createElement('option');
            option.value = weekInfo.week;
            option.textContent = weekInfo.display;
            if (String(weekInfo.week) === selectedWeek) {
                option.selected = true;
            }
            weekSelect.appendChild(option);
        });
    }

    startYearSelect.addEventListener('change', function() { updateWeekOptions(startYearSelect, startWeekSelect, null); });
    endYearSelect.addEventListener('change', function() { updateWeekOptions(endYearSelect, endWeekSelect, null); });

    updateWeekOptions(startYearSelect, startWeekSelect, selectedStartWeek);
    updateWeekOptions(endYearSelect, endWeekSelect, selectedEndWeek);

    // AI Analysis
    const aiAnalysisBtn = document.getElementById('ai-analysis-btn');
    const aiAnalysisModal = document.getElementById('ai-analysis-modal');
    const analysisResultDiv = document.getElementById('ai-analysis-result');
    const analysisLoadingDiv = document.getElementById('ai-analysis-loading');

    function openAiAnalysisModal() {
        aiAnalysisModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeAiAnalysisModal() {
        aiAnalysisModal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    window.closeAiAnalysisModal = closeAiAnalysisModal;

    function getIsoWeekDate(y, w, d) {
        var simple = new Date(Date.UTC(y, 0, 1 + (w - 1) * 7));
        var dow = simple.getUTCDay();
        var ISOweekStart = simple;
        if (dow <= 4)
            ISOweekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
        else
            ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
        ISOweekStart.setUTCDate(ISOweekStart.getUTCDate() + d - 1);
        return ISOweekStart;
    }

    if (aiAnalysisBtn) {
        aiAnalysisBtn.addEventListener('click', function() {
            const selectedUserId = document.getElementById('user_id').value;
            if (!selectedUserId) {
                alert('분석할 팀원을 선택해주세요.');
                return;
            }

            const endYear = document.getElementById('end_year').value;
            const endWeek = document.getElementById('end_week').value;

            analysisResultDiv.style.display = 'none';
            analysisLoadingDiv.style.display = 'flex';
            openAiAnalysisModal();

            const asOfDate = getIsoWeekDate(parseInt(endYear), parseInt(endWeek), 7);
            const asOfDateString = asOfDate.toISOString().split('T')[0];

            fetch(`/me/review?user_id=${selectedUserId}&as_of=${asOfDateString}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                    }
                    return response.json();
                })
                .then(data => {
                    analysisLoadingDiv.style.display = 'none';
                    analysisResultDiv.innerHTML = formatAnalysisResult(data);
                    analysisResultDiv.style.display = 'block';
                })
                .catch(error => {
                    analysisLoadingDiv.style.display = 'none';
                    analysisResultDiv.innerHTML = `<div class="bg-rose-50 border border-rose-200 rounded-2xl p-4 text-rose-800">분석 중 오류가 발생했습니다: ${error.message}</div>`;
                    analysisResultDiv.style.display = 'block';
                });
        });
    }

    function formatMonthWeek(isoDate) {
        if (!isoDate) return '';
        try {
            const d = new Date(isoDate);
            const month = d.getUTCMonth() + 1;
            const date = d.getUTCDate();
            const weekOfMonth = Math.ceil(date / 7);
            return `${month}월 ${weekOfMonth}주차`;
        } catch (e) {
            return isoDate;
        }
    }

    function formatAnalysisResult(data) {
        if (data.error) {
            return `<div class="bg-amber-50 border border-amber-200 rounded-2xl p-4"><strong class="text-amber-800">AI 분석 실패</strong><br><span class="text-amber-700">${data.error}</span></div>`;
        }

        let html = `<h2 class="text-xl font-bold text-slate-900 mb-6">${data.summary}</h2>`;

        // Metrics
        html += '<h3 class="text-lg font-bold text-slate-900 mb-4">주요 지표</h3><div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">';
        const metrics = data.metrics;

        const createMetricCard = (title, metric) => {
            const metricValue = (metric && metric.value !== undefined) ? metric.value : 0;
            return `
                <div class="bg-slate-50 rounded-2xl p-4 text-center border border-slate-200">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">${title}</h4>
                    <div class="text-2xl font-black text-slate-900">${metricValue}</div>
                </div>
            `;
        };
        
        const createRateMetricCard = (title, metric) => {
            const metricValue = (metric && metric.value !== undefined) ? metric.value : 0;
            return `
                <div class="bg-slate-50 rounded-2xl p-4 text-center border border-slate-200">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">${title}</h4>
                    <div class="text-2xl font-black text-slate-900">${(metricValue).toFixed(0)}%</div>
                </div>
            `;
        };

        html += createMetricCard('계획', metrics.planned_count);
        html += createMetricCard('실행', metrics.done_count);
        html += createRateMetricCard('완료율', metrics.completion_rate);
        html += createMetricCard('이월', metrics.carryover_count);
        html += createMetricCard('증빙부족', metrics.missing_evidence_count);
        html += '</div>';

        // Mismatches
        if (data.mismatches && data.mismatches.length > 0) {
            html += '<h3 class="text-lg font-bold text-slate-900 mb-4">계획-실적 불일치</h3><div class="space-y-3 mb-8">';
            data.mismatches.forEach(item => {
                html += `<div class="bg-rose-50 border border-rose-200 rounded-2xl p-4"><strong class="text-rose-800">${formatMonthWeek(item.week)}:</strong> <span class="text-rose-700">${item.plan_item}</span><br><span class="text-rose-600 text-sm">→ ${item.issue}</span></div>`;
            });
            html += '</div>';
        }

        // Risks
        if (data.risks && data.risks.length > 0) {
            html += '<h3 class="text-lg font-bold text-slate-900 mb-4">리스크 및 우려사항</h3><div class="overflow-x-auto mb-8"><table class="w-full text-left border-collapse bg-white rounded-2xl border border-slate-200 overflow-hidden"><thead class="bg-slate-50"><tr><th class="py-3 px-4 text-xs font-bold text-slate-400 uppercase">내용</th><th class="py-3 px-4 text-xs font-bold text-slate-400 uppercase">상태</th><th class="py-3 px-4 text-xs font-bold text-slate-400 uppercase">담당</th><th class="py-3 px-4 text-xs font-bold text-slate-400 uppercase">조치</th><th class="py-3 px-4 text-xs font-bold text-slate-400 uppercase">기한</th></tr></thead><tbody class="divide-y divide-slate-100">';
            data.risks.forEach(risk => {
                html += `<tr><td class="py-3 px-4 text-sm text-slate-700">${risk.description}</td><td class="py-3 px-4 text-sm text-slate-700">${risk.status}</td><td class="py-3 px-4 text-sm text-slate-700">${risk.owner}</td><td class="py-3 px-4 text-sm text-slate-700">${risk.next_action}</td><td class="py-3 px-4 text-sm text-slate-700">${risk.due}</td></tr>`;
            });
            html += '</tbody></table></div>';
        }

        // Recommendations
        if (data.recommendations && data.recommendations.length > 0) {
            html += '<h3 class="text-lg font-bold text-slate-900 mb-4">개선 권고 사항</h3><div class="space-y-3">';
            data.recommendations.forEach(rec => {
                html += `<div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 text-blue-800">${rec}</div>`;
            });
            html += '</div>';
        }

        return html;
    }
});
</script>

<style>
    /* Custom Markdown Styles */
    .markdown-content ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5em 0; }
    .markdown-content ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5em 0; }
    .markdown-content blockquote { border-left: 4px solid #e2e8f0; padding-left: 1rem; color: #64748b; font-style: italic; }
    .markdown-content code { background-color: #f1f5f9; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875em; color: #0f172a; }
    .markdown-content pre { background-color: #1e293b; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1em 0; }
    .markdown-content pre code { background-color: transparent; padding: 0; color: inherit; }
    .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: 700; color: #0f172a; margin-top: 1.5em; margin-bottom: 0.5em; }
    .markdown-content h1 { font-size: 1.5em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
    .markdown-content h2 { font-size: 1.25em; }
    .markdown-content a { color: #3b82f6; text-decoration: underline; }
    .markdown-content table { width: 100%; border-collapse: collapse; margin: 1em 0; }
    .markdown-content th, .markdown-content td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; }
    .markdown-content th { background-color: #f8fafc; font-weight: 600; }
</style>
{% endblock %}