{% extends 'basic.html' %}
{% load static %}

{% block title %}비밀번호 변경 - 첫 로그인{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[70vh] pb-20">
    <!-- Main Card -->
    <div class="w-full max-w-lg bg-surface-light rounded-2xl border border-slate-100 shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
        <!-- Header Section -->
        <div class="bg-primary/5 p-8 border-b border-slate-100 flex flex-col items-center text-center">
            <div class="size-16 bg-white text-primary rounded-full flex items-center justify-center mb-4 shadow-sm ring-4 ring-primary/5">
                <span class="material-symbols-outlined text-4xl">lock_reset</span>
            </div>
            <h1 class="text-2xl font-bold text-slate-900 mb-2">비밀번호 변경</h1>
            <p class="text-slate-500 text-sm">
                최초 로그인입니다. 안전한 서비스 이용을 위해<br>새로운 비밀번호를 설정해주세요.
            </p>
        </div>

        <div class="p-8 space-y-8">
            <!-- User Info Badge -->
            <div class="flex items-center gap-4 p-4 rounded-xl bg-slate-50 border border-slate-100">
                <div class="size-12 bg-white rounded-full flex items-center justify-center text-primary font-bold border border-slate-200 text-lg shadow-sm">
                    {{ user.profile.get_korean_name|first|default:user.username|first|upper }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-slate-900 font-bold truncate">{{ user.profile.display_name }}</p>
                    <p class="text-slate-500 text-xs truncate">{{ user.username }}</p>
                </div>
            </div>

            <!-- Form Error/Success Messages -->
            {% if messages %}
                <div class="space-y-2">
                    {% for message in messages %}
                        <div class="p-4 rounded-xl text-sm font-medium flex items-start gap-3 {% if message.tags == 'error' %}bg-red-50 text-red-700{% else %}bg-green-50 text-green-700{% endif %}">
                            <span class="material-symbols-outlined text-[20px] mt-0.5">
                                {% if message.tags == 'error' %}error{% else %}check_circle{% endif %}
                            </span>
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Password Form -->
            <form method="post" id="passwordChangeForm" class="space-y-6">
                {% csrf_token %}
                
                <!-- Current Password -->
                <div class="space-y-1.5">
                    <label for="{{ form.old_password.id_for_label }}" class="text-sm font-bold text-slate-700 ml-1">현재 비밀번호</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400">key</span>
                        <input type="password" name="{{ form.old_password.name }}" id="{{ form.old_password.id_for_label }}"
                               class="w-full pl-12 pr-4 py-3 bg-slate-50 border-slate-200 focus:bg-white focus:ring-2 focus:ring-primary/20 focus:border-primary rounded-xl text-slate-900 transition-all outline-none"
                               placeholder="임시 비밀번호를 입력하세요" required>
                    </div>
                    {% if form.old_password.errors %}
                        <p class="text-red-500 text-xs mt-1 font-medium">{{ form.old_password.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- New Password -->
                <div class="space-y-1.5">
                    <label for="{{ form.new_password1.id_for_label }}" class="text-sm font-bold text-slate-700 ml-1">새 비밀번호</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400">lock</span>
                        <input type="password" name="{{ form.new_password1.name }}" id="{{ form.new_password1.id_for_label }}"
                               class="w-full pl-12 pr-4 py-3 bg-slate-50 border-slate-200 focus:bg-white focus:ring-2 focus:ring-primary/20 focus:border-primary rounded-xl text-slate-900 transition-all outline-none"
                               placeholder="8자 이상, 대소문자/숫자 조합" required>
                    </div>
                    
                    <!-- Password Strength UI -->
                    <div id="passwordStrength" class="hidden mt-3 space-y-1.5 p-3 rounded-lg bg-slate-50 border border-slate-100">
                        <div class="flex items-center justify-between text-[11px] font-bold uppercase tracking-wider text-slate-400 h-4">
                            <span>보안 강도</span>
                            <span id="strengthText">매우 약함</span>
                        </div>
                        <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                            <div id="strengthBar" class="h-full w-0 bg-red-500 transition-all duration-500"></div>
                        </div>
                    </div>

                    {% if form.new_password1.errors %}
                        <p class="text-red-500 text-xs mt-1 font-medium">{{ form.new_password1.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Confirm Password -->
                <div class="space-y-1.5">
                    <label for="{{ form.new_password2.id_for_label }}" class="text-sm font-bold text-slate-700 ml-1">새 비밀번호 확인</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400">verified_user</span>
                        <input type="password" name="{{ form.new_password2.name }}" id="{{ form.new_password2.id_for_label }}"
                               class="w-full pl-12 pr-4 py-3 bg-slate-50 border-slate-200 focus:bg-white focus:ring-2 focus:ring-primary/20 focus:border-primary rounded-xl text-slate-900 transition-all outline-none"
                               placeholder="비밀번호를 한번 더 입력하세요" required>
                    </div>
                    
                    <!-- Match Indicator -->
                    <div id="passwordMatch" class="hidden mt-1.5 flex items-center gap-1.5 ml-1">
                        <span id="matchIcon" class="material-symbols-outlined text-[16px]">cancel</span>
                        <span id="matchText" class="text-xs font-medium">비밀번호가 일치하지 않습니다</span>
                    </div>

                    {% if form.new_password2.errors %}
                        <p class="text-red-500 text-xs mt-1 font-medium">{{ form.new_password2.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" 
                        class="w-full h-14 bg-primary hover:bg-primary/90 text-white font-bold rounded-xl shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-2 group mt-4">
                    <span class="material-symbols-outlined group-hover:rotate-12 transition-transform">security</span>
                    비밀번호 변경 완료
                </button>
            </form>

            <!-- Guide Note -->
            <div class="p-4 rounded-xl bg-amber-50 border border-amber-100">
                <h4 class="text-xs font-bold text-amber-800 mb-2 flex items-center gap-1">
                    <span class="material-symbols-outlined text-[16px]">info</span>
                    비밀번호 보안 가이드
                </h4>
                <ul class="text-[11px] text-amber-700/80 space-y-1 list-disc pl-4 font-medium">
                    <li>최소 8자 이상의 길이로 설정해야 합니다.</li>
                    <li>영문 대소문자, 숫자, 특수문자를 혼용하는 것을 권장합니다.</li>
                    <li>아이디나 생년월일이 포함된 비밀번호는 피하십시오.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pw1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const pw2 = document.getElementById('{{ form.new_password2.id_for_label }}');
    const strengthIndicator = document.getElementById('passwordStrength');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const matchIndicator = document.getElementById('passwordMatch');
    const matchIcon = document.getElementById('matchIcon');
    const matchText = document.getElementById('matchText');
    const submitBtn = document.getElementById('submitBtn');
    
    function checkStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength += 1;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;
        if (/[0-9]/.test(password)) strength += 1;
        if (/[^A-Za-z0-9]/.test(password)) strength += 1;
        return strength;
    }
    
    pw1.addEventListener('input', function() {
        const val = this.value;
        if (val.length === 0) {
            strengthIndicator.classList.add('hidden');
            return;
        }
        
        strengthIndicator.classList.remove('hidden');
        const score = checkStrength(val);
        const widths = ['25%', '50%', '75%', '100%'];
        const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];
        const texts = ['약함 (8자 이상 필요)', '보통 (대소문자 혼용 권장)', '좋음', '매우 강력함'];
        
        strengthBar.style.width = widths[score-1] || '10%';
        strengthBar.className = 'h-full transition-all duration-500 ' + (colors[score-1] || 'bg-red-500');
        strengthText.textContent = texts[score-1] || '매우 약함';
        strengthText.className = 'transition-colors ' + (score >= 3 ? 'text-green-600' : 'text-slate-400');
        
        checkMatch();
    });
    
    function checkMatch() {
        const v1 = pw1.value;
        const v2 = pw2.value;
        
        if (v2.length === 0) {
            matchIndicator.classList.add('hidden');
            return;
        }
        
        matchIndicator.classList.remove('hidden');
        if (v1 === v2) {
            matchIcon.textContent = 'check_circle';
            matchIcon.className = 'material-symbols-outlined text-[16px] text-green-500';
            matchText.textContent = '비밀번호가 일치합니다';
            matchText.className = 'text-xs font-medium text-green-600';
        } else {
            matchIcon.textContent = 'cancel';
            matchIcon.className = 'material-symbols-outlined text-[16px] text-red-500';
            matchText.textContent = '비밀번호가 일치하지 않습니다';
            matchText.className = 'text-xs font-medium text-red-600';
        }
    }
    
    pw2.addEventListener('input', checkMatch);
    
    document.getElementById('passwordChangeForm').addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[20px]">sync</span> 처리 중...';
        submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
    });
});
</script>
{% endblock %}
