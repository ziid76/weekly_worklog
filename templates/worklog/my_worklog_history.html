{% extends "basic.html" %}
{% load static %}
{% load markdown_extras %}

{% block page_name %}주간업무 모아보기{% endblock %}

{% block content %}
<div class="max-w-[1600px] mx-auto space-y-6 pb-12">
    <!-- Filter Section -->
    <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm p-6">
        <form method="get" action="{% url 'my_worklog_history' %}" class="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">date_range</span>
                    <label class="text-sm font-bold text-slate-500 whitespace-nowrap">조회 기간:</label>
                </div>
                
                <div class="flex items-center gap-2 flex-wrap">
                    <div class="flex items-center gap-2 bg-slate-50 rounded-xl p-1 border border-slate-200">
                        <select name="start_year" id="start_year" class="bg-transparent border-0 text-sm font-bold text-slate-700 focus:ring-0 cursor-pointer py-1 pl-3 pr-8">
                            {% for year in year_choices %}
                            <option value="{{ year }}" {% if start_year|stringformat:"s" == year|stringformat:"s" %}selected{% endif %}>{{ year }}년</option>
                            {% endfor %}
                        </select>
                        <select name="start_week" id="start_week" class="bg-white rounded-lg border-0 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 cursor-pointer py-1 pl-3 pr-8 shadow-sm">
                            {# Options populated by JS #}
                        </select>
                    </div>

                    <span class="text-slate-300 font-bold">~</span>

                    <div class="flex items-center gap-2 bg-slate-50 rounded-xl p-1 border border-slate-200">
                        <select name="end_year" id="end_year" class="bg-transparent border-0 text-sm font-bold text-slate-700 focus:ring-0 cursor-pointer py-1 pl-3 pr-8">
                            {% for year in year_choices %}
                            <option value="{{ year }}" {% if end_year|stringformat:"s" == year|stringformat:"s" %}selected{% endif %}>{{ year }}년</option>
                            {% endfor %}
                        </select>
                        <select name="end_week" id="end_week" class="bg-white rounded-lg border-0 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 cursor-pointer py-1 pl-3 pr-8 shadow-sm">
                            {# Options populated by JS #}
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button type="submit" class="h-10 px-6 flex items-center justify-center gap-2 rounded-xl bg-slate-900 text-white font-bold text-sm hover:bg-slate-800 transition-all shadow-lg shadow-slate-200">
                    <span class="material-symbols-outlined text-[18px]">search</span>
                    조회
                </button>
                <button type="button" id="ai-analysis-btn" class="h-10 px-6 flex items-center justify-center gap-2 rounded-xl bg-indigo-600 text-white font-bold text-sm hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 group" {% if not worklogs_data %}disabled{% endif %}>
                    <span class="material-symbols-outlined text-[18px] group-hover:rotate-12 transition-transform">auto_awesome</span>
                    AI 분석
                </button>
            </div>
        </form>
    </div>

    {% if worklogs_data %}
    <!-- Results Section -->
    <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden min-h-[500px]">
        <div class="px-8 py-6 border-b border-slate-50 bg-slate-50/50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-primary text-[24px]">view_timeline</span>
                <h3 class="text-lg font-extrabold text-slate-900 tracking-tight">주간업무 히스토리</h3>
                <span class="px-2.5 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[11px] font-bold border border-slate-200">
                    {{ worklogs_data|length }}건 조회됨
                </span>
            </div>
            
            <!-- View Toggle -->
            <div class="flex bg-slate-100 p-1 rounded-xl">
                <button id="btn-format1" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-900 shadow-sm">
                    금주 / 차주
                </button>
                <button id="btn-format2" class="px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all">
                    전주 / 금주
                </button>
            </div>
        </div>

        <div class="p-8">
            <!-- Format 1: This Week / Next Week -->
            <div id="format1-table" class="space-y-4">
                <!-- Header -->
                <div class="hidden md:grid grid-cols-12 gap-6 bg-slate-50 rounded-2xl p-4 border border-slate-100/50 mb-2">
                    <div class="col-span-2 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">주차</div>
                    <div class="col-span-5 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">금주 실적</div>
                    <div class="col-span-5 text-center text-xs font-bold text-indigo-500 uppercase tracking-wider">차주 계획</div>
                </div>

                {% for data in worklogs_data %}
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 p-6 rounded-3xl border border-slate-100 hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5 transition-all bg-white group">
                    <!-- Week Info -->
                    <div class="md:col-span-2 flex md:flex-col items-center md:justify-center md:text-center gap-2 border-b md:border-b-0 border-slate-50 pb-4 md:pb-0">
                        <div class="size-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-primary/10 group-hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">calendar_month</span>
                        </div>
                        <div>
                            <div class="text-base font-extrabold text-slate-800">{{ data.worklog.week_number }}주차</div>
                            <div class="text-[10px] font-bold text-slate-400">{{ data.worklog.year }}년</div>
                            <div class="text-[9px] text-slate-400 mt-1 bg-slate-50 px-2 py-0.5 rounded-full inline-block">
                                {{ data.worklog.week_start_date|date:"m.d" }}~{{ data.worklog.week_end_date|date:"m.d" }}
                            </div>
                        </div>
                    </div>

                    <!-- This Week -->
                    <div class="md:col-span-5 relative">
                        <div class="md:hidden text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">금주 실적</div>
                        <div class="prose prose-sm prose-slate max-w-none prose-p:my-1 prose-headings:my-2 text-sm leading-relaxed bg-slate-50/50 rounded-2xl p-5 border border-slate-100 min-h-full">
                            {% if data.worklog.this_week_work %}
                                {{ data.worklog.this_week_work|markdown }}
                            {% else %}
                                <p class="text-slate-400 italic text-xs">작성된 내용이 없습니다.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Next Week -->
                    <div class="md:col-span-5 relative">
                        <div class="md:hidden text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-2 mt-4">차주 계획</div>
                        <div class="prose prose-sm prose-indigo max-w-none prose-p:my-1 prose-headings:my-2 text-sm leading-relaxed bg-indigo-50/30 rounded-2xl p-5 border border-indigo-50 min-h-full">
                            {% if data.worklog.next_week_plan %}
                                {{ data.worklog.next_week_plan|markdown }}
                            {% else %}
                                <p class="text-slate-400 italic text-xs">작성된 계획이 없습니다.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Format 2: Previous Week / This Week -->
            <div id="format2-table" class="space-y-4 hidden">
                <!-- Header -->
                <div class="hidden md:grid grid-cols-12 gap-6 bg-slate-50 rounded-2xl p-4 border border-slate-100/50 mb-2">
                    <div class="col-span-2 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">주차</div>
                    <div class="col-span-5 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">전주 계획 (회고)</div>
                    <div class="col-span-5 text-center text-xs font-bold text-primary uppercase tracking-wider">금주 실적 (결과)</div>
                </div>

                {% for data in worklogs_data %}
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 p-6 rounded-3xl border border-slate-100 hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5 transition-all bg-white group">
                    <!-- Week Info -->
                    <div class="md:col-span-2 flex md:flex-col items-center md:justify-center md:text-center gap-2 border-b md:border-b-0 border-slate-50 pb-4 md:pb-0">
                        <div class="size-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-primary/10 group-hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">history</span>
                        </div>
                        <div>
                            <div class="text-base font-extrabold text-slate-800">{{ data.worklog.week_number }}주차</div>
                            <div class="text-[10px] font-bold text-slate-400">{{ data.worklog.year }}년</div>
                        </div>
                    </div>

                    <!-- Previous Week Plan -->
                    <div class="md:col-span-5 relative">
                        <div class="md:hidden text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">전주 계획</div>
                        <div class="prose prose-sm prose-slate max-w-none prose-p:my-1 prose-headings:my-2 text-sm leading-relaxed bg-slate-50/50 rounded-2xl p-5 border border-slate-100 min-h-full opacity-75">
                            {% if data.previous_week_plan %}
                                {{ data.previous_week_plan|markdown }}
                            {% else %}
                                <p class="text-slate-400 italic text-xs">작성된 내용이 없습니다.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- This Week Work -->
                    <div class="md:col-span-5 relative">
                        <div class="md:hidden text-[10px] font-bold text-primary uppercase tracking-widest mb-2 mt-4">금주 실적</div>
                        <div class="prose prose-sm prose-slate max-w-none prose-p:my-1 prose-headings:my-2 text-sm leading-relaxed bg-white rounded-2xl p-5 border border-primary/20 shadow-sm ring-1 ring-primary/5 min-h-full">
                            {% if data.worklog.this_week_work %}
                                {{ data.worklog.this_week_work|markdown }}
                            {% else %}
                                <p class="text-slate-400 italic text-xs">작성된 내용이 없습니다.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="flex flex-col items-center justify-center py-20 bg-white rounded-[2.5rem] border border-slate-200 border-dashed">
        <div class="size-20 rounded-full bg-slate-50 flex items-center justify-center mb-6">
            <span class="material-symbols-outlined text-slate-300 text-[40px]">search_off</span>
        </div>
        <p class="text-slate-500 font-bold mb-2">검색 결과가 없습니다</p>
        <p class="text-slate-400 text-sm">기간을 변경하여 다시 조회해보세요.</p>
    </div>
    {% endif %}
</div>

<!-- AI Analysis Modal -->
<div id="ai-analysis-modal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeAiModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <div class="inline-block align-bottom bg-white rounded-[2rem] text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full border border-slate-200">
            <!-- Header -->
            <div class="px-8 py-6 border-b border-indigo-50 bg-indigo-50/30 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600">
                        <span class="material-symbols-outlined">auto_awesome</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-extrabold text-slate-900 tracking-tight">AI 주간업무 분석</h3>
                        <p class="text-xs font-semibold text-indigo-400">Gemini Pro Analysis</p>
                    </div>
                </div>
                <button onclick="closeAiModal()" class="size-9 flex items-center justify-center rounded-lg hover:bg-slate-100 text-slate-400 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="p-8 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Loading State -->
                <div id="ai-analysis-loading" class="flex flex-col items-center justify-center py-12 space-y-6">
                    <div class="relative size-16">
                        <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    <div class="text-center">
                        <p class="text-sm font-bold text-slate-800">Gemini가 주간업무를 분석 중입니다</p>
                        <p class="text-xs text-slate-400 mt-1">데이터 양에 따라 10~30초 정도 소요될 수 있습니다...</p>
                    </div>
                </div>

                <!-- Result Content -->
                <div id="ai-analysis-result" class="hidden space-y-8">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                <button onclick="closeAiModal()" class="h-10 px-6 rounded-xl bg-white border border-slate-200 text-slate-600 font-bold text-xs hover:bg-slate-50 transition-all shadow-sm">
                    닫기
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function closeAiModal() {
        document.getElementById('ai-analysis-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Format toggle
        const btnFormat1 = document.getElementById('btn-format1');
        const btnFormat2 = document.getElementById('btn-format2');
        const tableFormat1 = document.getElementById('format1-table');
        const tableFormat2 = document.getElementById('format2-table');

        if (btnFormat1 && btnFormat2) {
            btnFormat1.addEventListener('click', function() {
                tableFormat1.classList.remove('hidden');
                tableFormat2.classList.add('hidden');
                
                btnFormat1.className = 'px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-900 shadow-sm';
                btnFormat2.className = 'px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all';
            });

            btnFormat2.addEventListener('click', function() {
                tableFormat1.classList.add('hidden');
                tableFormat2.classList.remove('hidden');

                btnFormat2.className = 'px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-900 shadow-sm';
                btnFormat1.className = 'px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all';
            });
        }

        // Dynamic week dropdowns
        const weekData = JSON.parse('{{ week_data_json|escapejs }}');
        
        function updateWeekOptions(yearSelectId, weekSelectId, selectedWeek) {
            const yearSelect = document.getElementById(yearSelectId);
            const weekSelect = document.getElementById(weekSelectId);
            const selectedYear = yearSelect.value;
            const weeks = weekData[selectedYear] || [];
            
            weekSelect.innerHTML = '';
            weeks.forEach(function(weekInfo) {
                const option = document.createElement('option');
                option.value = weekInfo.week;
                option.textContent = weekInfo.display;
                if (String(weekInfo.week) === selectedWeek) {
                    option.selected = true;
                }
                weekSelect.appendChild(option);
            });
        }

        const startYearSelect = document.getElementById('start_year');
        const endYearSelect = document.getElementById('end_year');

        startYearSelect.addEventListener('change', () => updateWeekOptions('start_year', 'start_week', null));
        endYearSelect.addEventListener('change', () => updateWeekOptions('end_year', 'end_week', null));

        updateWeekOptions('start_year', 'start_week', '{{ start_week }}');
        updateWeekOptions('end_year', 'end_week', '{{ end_week }}');

        // AI Analysis
        const aiAnalysisBtn = document.getElementById('ai-analysis-btn');
        const modal = document.getElementById('ai-analysis-modal');
        const loadingDiv = document.getElementById('ai-analysis-loading');
        const resultDiv = document.getElementById('ai-analysis-result');

        // Date Helper
        function getIsoWeekDate(y, w, d) {
            var simple = new Date(Date.UTC(y, 0, 1 + (w - 1) * 7));
            var dow = simple.getUTCDay();
            var ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
            else
                ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
            ISOweekStart.setUTCDate(ISOweekStart.getUTCDate() + d - 1);
            return ISOweekStart;
        }

        if (aiAnalysisBtn) {
            aiAnalysisBtn.addEventListener('click', function() {
                const endYear = document.getElementById('end_year').value;
                const endWeek = document.getElementById('end_week').value;

                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                loadingDiv.classList.remove('hidden');
                resultDiv.classList.add('hidden');

                const asOfDate = getIsoWeekDate(parseInt(endYear), parseInt(endWeek), 7);
                const asOfDateString = asOfDate.toISOString().split('T')[0];

                fetch(`/me/review?as_of=${asOfDateString}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingDiv.classList.add('hidden');
                        resultDiv.classList.remove('hidden');
                        resultDiv.innerHTML = formatAnalysisResult(data);
                        
                        // Tooltips for new content
                        // Note: Tailwind/CSS tooltips or custom simple implementation preferred over Bootstrap JS dependency
                    })
                    .catch(error => {
                        loadingDiv.classList.add('hidden');
                        resultDiv.classList.remove('hidden');
                        resultDiv.innerHTML = `
                            <div class="bg-rose-50 border border-rose-100 rounded-2xl p-6 text-center">
                                <span class="material-symbols-outlined text-rose-500 text-[32px] mb-2">error</span>
                                <p class="text-sm font-bold text-rose-700">분석 중 오류가 발생했습니다</p>
                                <p class="text-xs text-rose-500 mt-1">${error.message}</p>
                            </div>
                        `;
                    });
            });
        }

        function formatMonthWeek(isoDate) {
            if (!isoDate) return '';
            try {
                const d = new Date(isoDate);
                const month = d.getUTCMonth() + 1;
                const date = d.getUTCDate();
                const weekOfMonth = Math.ceil(date / 7);
                return `${month}월 ${weekOfMonth}주차`;
            } catch (e) {
                return isoDate;
            }
        }

        function formatAnalysisResult(data) {
            if (data.error) {
                return `
                    <div class="bg-amber-50 border border-amber-100 rounded-2xl p-6 text-center">
                        <span class="material-symbols-outlined text-amber-500 text-[32px] mb-2">warning</span>
                        <p class="text-sm font-bold text-amber-700">AI 분석 실패</p>
                        <p class="text-xs text-amber-600 mt- mt-1">${data.error}</p>
                    </div>`;
            }

            let html = `
                <div class="bg-indigo-50/50 rounded-2xl p-6 border border-indigo-100">
                    <h4 class="text-base font-extrabold text-indigo-900 leading-relaxed word-keep-all">
                        <span class="material-symbols-outlined text-[20px] align-text-bottom mr-1 text-indigo-500">format_quote</span>
                        ${data.summary}
                    </h4>
                </div>
            `;

            // Metrics Grid
            html += `<h5 class="text-sm font-bold text-slate-500 uppercase tracking-widest mt-8 mb-4">주요 성과 지표</h5>`;
            html += `<div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-4">`;

            const createMetricCard = (title, metric, isRate = false) => {
                const value = (metric && metric.value !== undefined) ? metric.value : 0;
                const displayValue = isRate ? `${value.toFixed(0)}%` : value;
                // Add conditional color for good/bad metrics if needed
                
                return `
                    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 text-center group hover:bg-white hover:shadow-md hover:border-primary/20 transition-all">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">${title}</div>
                        <div class="text-2xl font-black text-slate-800 group-hover:text-primary transition-colors">${displayValue}</div>
                    </div>
                `;
            };

            const m = data.metrics;
            html += createMetricCard('계획', m.planned_count);
            html += createMetricCard('실행', m.done_count);
            html += createMetricCard('완료율', m.completion_rate, true);
            html += createMetricCard('이월', m.carryover_count);
            html += createMetricCard('증빙부족', m.missing_evidence_count);
            html += `</div>`;

            // Mismatches
            if (data.mismatches && data.mismatches.length > 0) {
                html += `<h5 class="text-sm font-bold text-slate-500 uppercase tracking-widest mt-8 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">sync_problem</span> 계획-실적 불일치
                </h5>`;
                html += `<div class="space-y-2">`;
                data.mismatches.forEach(item => {
                    html += `
                        <div class="bg-rose-50 border border-rose-100 rounded-xl p-4 flex flex-col sm:flex-row gap-3">
                             <div class="min-w-[80px] text-xs font-bold text-rose-500">${formatMonthWeek(item.week)}</div>
                             <div class="flex-1">
                                <div class="text-sm font-bold text-slate-800">${item.plan_item}</div>
                                <div class="flex items-center gap-2 mt-1 text-xs font-medium text-rose-600">
                                    <span class="material-symbols-outlined text-[14px]">arrow_forward</span>
                                    ${item.issue}
                                </div>
                             </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Risks
            if (data.risks && data.risks.length > 0) {
                html += `<h5 class="text-sm font-bold text-slate-500 uppercase tracking-widest mt-8 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">warning</span> 리스크 및 우려사항
                </h5>`;
                
                html += `<div class="overflow-x-auto rounded-2xl border border-slate-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase">
                            <tr>
                                <th class="px-4 py-3">내용</th>
                                <th class="px-4 py-3 w-20">상태</th>
                                <th class="px-4 py-3 w-24">담당</th>
                                <th class="px-4 py-3">조치계획</th>
                                <th class="px-4 py-3 w-24">기한</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">`;
                
                data.risks.forEach(risk => {
                    html += `
                        <tr class="hover:bg-slate-50/50">
                            <td class="px-4 py-3 font-medium text-slate-800">${risk.description}</td>
                            <td class="px-4 py-3"><span class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 text-[10px] font-bold border border-slate-200">${risk.status}</span></td>
                            <td class="px-4 py-3 text-slate-600 font-medium">${risk.owner}</td>
                            <td class="px-4 py-3 text-slate-600">${risk.next_action || '-'}</td>
                            <td class="px-4 py-3 text-slate-500 text-xs">${risk.due || '-'}</td>
                        </tr>
                    `;
                });
                html += `</tbody></table></div>`;
            }

            // Recommendations
            if (data.recommendations && data.recommendations.length > 0) {
                html += `<h5 class="text-sm font-bold text-slate-500 uppercase tracking-widest mt-8 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">lightbulb</span> 개선 권고 사항
                </h5>`;
                html += `<div class="grid grid-cols-1 gap-3">`;
                data.recommendations.forEach(rec => {
                    html += `
                        <div class="flex gap-3 p-4 bg-emerald-50/50 border border-emerald-100 rounded-xl">
                            <span class="material-symbols-outlined text-emerald-500 shrink-0">check_circle</span>
                            <span class="text-sm font-medium text-slate-700 leading-relaxed">${rec}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            return html;
        }
    });
</script>
{% endblock %}

