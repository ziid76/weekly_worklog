{% extends 'basic.html' %}
{% load markdown_extras %}

{% block page_name %}주간업무 상세{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">
    <!-- Top Action Bar -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-white/80 backdrop-blur-md  top-0 z-10 py-4 px-2 -mx-2 rounded-2xl">
        <div class="flex items-center gap-3">
            <a href="{% url 'worklog_list' %}" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 transition-all" title="목록으로">
                <span class="material-symbols-outlined text-[20px]">arrow_back</span>
            </a>
            <div>
                <h2 class="text-xl font-extrabold text-slate-900 tracking-tight">{{ worklog.month_week_display }}</h2>
                <div class="flex items-center gap-2 text-sm font-semibold text-slate-500">
                    <span>{{ worklog.year }}년 {{ worklog.week_number }}주차</span>
                    <span class="text-sm text-slate-300">|</span>
                    <span>{{ worklog.week_start_date|date:"m-d" }} ~ {{ worklog.week_end_date|date:"m-d" }}</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2">
            {% if editable %}
            <div class="h-6 w-px bg-slate-200 mx-1"></div>
            <a href="{% url 'worklog_update' worklog.pk %}" class="h-10 px-4 flex items-center justify-center gap-2 rounded-xl bg-slate-900 text-white font-bold text-xs hover:bg-slate-800 transition-all shadow-lg shadow-slate-200">
                <span class="material-symbols-outlined text-[18px]">edit</span>
                수정
            </a>
            <a href="{% url 'worklog_delete' worklog.pk %}" class="h-10 px-4 flex items-center justify-center gap-2 rounded-xl bg-white border border-rose-100 text-rose-500 font-bold text-xs hover:bg-rose-50 transition-all" onclick="return confirm('정말로 삭제하시겠습니까?')">
                <span class="material-symbols-outlined text-[18px]">delete</span>
                삭제
            </a>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Main Content (Left/Center) -->
        <div class="lg:col-span-8 space-y-6">
            <!-- This Week Results -->
            <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <div class="px-8 py-6 border-b border-slate-50 bg-slate-50/50 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[24px]">task_alt</span>
                        <h3 class="text-lg font-extrabold text-slate-900 tracking-tight">금주 실적</h3>
                        <span class="text-xs font-semibold text-slate-400">({{ worklog.week_start_date|date:"m월 d일" }} ~ {{ worklog.week_end_date|date:"m월 d일" }})</span>
                    </div>
                </div>
                <div class="p-8 prose prose-slate max-w-none prose-pre:bg-slate-900 prose-pre:rounded-2xl">
                    {% if worklog.this_week_work %}
                        {{ worklog.this_week_work|markdown }}
                    {% else %}
                        <p class="text-slate-400 italic">작성된 내용이 없습니다.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Next Week Plan -->
            <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <div class="px-8 py-6 border-b border-slate-50 bg-slate-50/50 flex items-center gap-3">
                    <span class="material-symbols-outlined text-indigo-500 text-[24px]">upcoming</span>
                    <h3 class="text-lg font-extrabold text-slate-900 tracking-tight">차주 계획</h3>
                </div>
                <div class="p-8 prose prose-slate max-w-none prose-indigo prose-pre:bg-slate-900 prose-pre:rounded-2xl">
                    {% if worklog.next_week_plan %}
                        {{ worklog.next_week_plan|markdown }}
                    {% else %}
                        <p class="text-slate-400 italic">작성된 계획이 없습니다.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar (Right) -->
        <div class="lg:col-span-4 space-y-6">
            <!-- Info Card -->
            <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden p-8">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-6 ml-1 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[16px]">info</span>
                    기본 정보
                </h4>
                
                <div class="space-y-6">
                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">작성자</label>
                        <div class="flex items-center gap-3 p-3 bg-slate-50 border border-slate-100 rounded-2xl">
                            <div class="size-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold border border-white shadow-sm overflow-hidden">
                                {% if worklog.author.profile.avatar %}
                                <img src="{{ worklog.author.profile.avatar.url }}" alt="" class="size-full object-cover">
                                {% else %}
                                {{ worklog.author.profile.display_name|default:worklog.author.username|first|upper }}
                                {% endif %}
                            </div>
                            <span class="text-sm font-bold text-slate-700">{{ worklog.author.profile.display_name|default:worklog.author.username }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div class="flex flex-col gap-1.5 ml-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">최초 생성</label>
                            <span class="text-xs font-semibold text-slate-700 flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-[14px]">history</span>
                                {{ worklog.created_at|date:"Y-m-d H:i" }}
                                <span class="text-[10px] text-slate-400">({{ worklog.created_at|timesince }} 전)</span>
                            </span>
                        </div>
                        <div class="flex flex-col gap-1.5 ml-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">최종 수정</label>
                            <span class="text-xs font-semibold text-slate-700 flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-[14px]">update</span>
                                {{ worklog.updated_at|date:"Y-m-d H:i" }}
                                <span class="text-[10px] text-slate-400">({{ worklog.updated_at|timesince }} 전)</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attachments Card -->
            <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden p-8">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-6 ml-1 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[16px]">attach_file</span>
                    첨부파일
                </h4>
                
                <div class="space-y-3">
                    {% if files %}
                        {% for file in files %}
                        <div class="flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-2xl group hover:border-primary/30 transition-all">
                            <div class="flex items-center gap-3 min-w-0">
                                <span class="material-symbols-outlined text-primary/40 text-[20px]">description</span>
                                <div class="min-w-0">
                                    <p class="text-[11px] font-bold text-slate-700 truncate" title="{{ file.original_name }}">{{ file.original_name }}</p>
                                    <p class="text-[10px] text-slate-400">{{ file.uploaded_at|date:"m/d H:i" }}</p>
                                </div>
                            </div>
                            <a href="{% url 'download_worklog_file' file.id %}" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-primary hover:bg-white transition-all">
                                <span class="material-symbols-outlined text-[18px]">download</span>
                            </a>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-[11px] text-slate-400 italic">첨부파일이 없습니다.</p>
                    {% endif %}

                    {% if editable %}
                    <form method="post" action="{% url 'upload_worklog_file' worklog.id %}" enctype="multipart/form-data" class="mt-6 pt-6 border-t border-slate-100">
                        {% csrf_token %}
                        <div class="flex flex-col gap-4">
                            <label class="cursor-pointer group">
                                <div class="flex flex-col items-center justify-center py-4 px-2 border-2 border-dashed border-slate-200 rounded-2xl group-hover:bg-slate-50 group-hover:border-primary/30 transition-all">
                                    <span class="material-symbols-outlined text-slate-300 group-hover:text-primary transition-colors text-[24px]">upload_file</span>
                                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-primary mt-1" id="file-label">파일 선택</span>
                                </div>
                                <input type="file" name="file" class="hidden" required onchange="this.closest('label').querySelector('#file-label').textContent = this.files[0].name.substring(0, 15) + (this.files[0].name.length > 15 ? '...' : '')">
                            </label>
                            <button type="submit" class="w-full h-10 flex items-center justify-center gap-2 rounded-xl bg-slate-100 text-slate-600 font-bold text-xs hover:bg-slate-200 transition-all">
                                <span class="material-symbols-outlined text-[18px]">cloud_upload</span>
                                업로드
                            </button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="worklog-data">
{
    "year": {{ worklog.year }},
    "weekNumber": {{ worklog.week_number }},
    "startDate": "{{ worklog.week_start_date|date:'Y년 m월 d일' }}",
    "endDate": "{{ worklog.week_end_date|date:'Y년 m월 d일' }}",
    "author": "{{ worklog.author.profile.display_name|default:worklog.author.username|escapejs }}",
    "createdAt": "{{ worklog.created_at|date:'Y-m-d H:i' }}",
    "thisWeek": "{{ worklog.this_week_work|default:''|escapejs }}",
    "nextWeek": "{{ worklog.next_week_plan|default:''|escapejs }}"
}
</script>

{% endblock %}
