{% extends 'basic.html' %}
{% load markdown_extras %}

{% block page_name %}
    {% if object %}{{ object.month_week_display }} 주간업무 수정{% else %}새 주간업무 작성{% endif %}
{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Main Form Column -->
        <div class="lg:col-span-8 space-y-8">
            <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-8 py-6 border-b border-slate-50 bg-slate-50/50 flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary text-[24px]">edit_note</span>
                    <h2 class="text-xl font-extrabold text-slate-900 tracking-tight">주간업무 정보</h2>
                </div>

                <div class="p-8 space-y-8">
                    {% if previous_personal_comments %}
                    <!-- Previous Week Comments -->
                    <div class="bg-amber-50 border border-amber-100 rounded-3xl p-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <span class="material-symbols-outlined text-[64px] text-amber-900">comment</span>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-amber-600">forum</span>
                                    <span class="font-extrabold text-amber-900 tracking-tight">지난주 업무 코멘트</span>
                                    {% if previous_comment_report %}
                                        <span class="px-2 py-0.5 rounded-full bg-amber-200/50 text-amber-700 text-[10px] font-bold uppercase tracking-wider ml-1">
                                            {{ previous_comment_report.month_week_display_with_year }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="space-y-4">
                                {% for comment in previous_personal_comments %}
                                <div class="bg-white/50 rounded-2xl p-4 border border-white/60 shadow-sm">
                                    <div class="flex justify-between items-center mb-1 text-[10px] font-bold text-amber-800/60 uppercase tracking-widest">
                                        <span>{{ comment.created_by.profile.display_name|default:comment.created_by.username }}</span>
                                        <span>{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                                    </div>
                                    <div class="text-xs font-semibold text-amber-900 leading-relaxed">{{ comment.content|linebreaksbr }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" class="space-y-8" id="worklog-form">
                        {% csrf_token %}

                        <!-- Copy Recent Worklog -->
                        {% if not object %}
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 ml-1">
                                <span class="material-symbols-outlined text-slate-400 text-[20px]">content_copy</span>
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">최근 주간업무 복사</label>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                {% for recent_worklog in recent_worklogs|slice:":3" %}
                                <button type="button" 
                                        onclick="copyWorklog('{{ recent_worklog.id }}', '{{ recent_worklog.month_week_display|escapejs }}')"
                                        class="text-left bg-slate-50 border border-slate-100 rounded-3xl p-5 group hover:bg-white hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5 transition-all">
                                    <h4 class="text-sm font-extrabold text-slate-800 group-hover:text-primary transition-colors">{{ recent_worklog.month_week_display }}</h4>
                                    {% if recent_worklog.this_week_work %}
                                    <p class="text-[11px] text-slate-400 font-medium mt-2 line-clamp-2 leading-relaxed">
                                        {{ recent_worklog.this_week_work|striptags|truncatewords:15 }}
                                    </p>
                                    {% endif %}
                                    <div class="mt-4 flex items-center gap-1.5 text-[10px] font-bold text-primary opacity-0 group-hover:opacity-100 transition-opacity">
                                        <span class="material-symbols-outlined text-[14px]">file_copy</span>
                                        내용 복사하기
                                    </div>
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- This Week's Work -->
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 ml-1">
                                    <span class="material-symbols-outlined text-slate-400 text-[20px]">task_alt</span>
                                    <label for="{{ form.this_week_work.id_for_label }}" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ form.this_week_work.label }}</label>
                                </div>
                                <button type="button" onclick="showTaskSelector('this_week')" class="h-8 px-4 flex items-center gap-1.5 rounded-full bg-slate-100 text-slate-600 font-bold text-[11px] hover:bg-slate-200 transition-all">
                                    <span class="material-symbols-outlined text-[14px]">add</span>
                                    업무 추가
                                </button>
                            </div>
                            <div class="bg-slate-50 rounded-md border border-slate-200 overflow-hidden focus-within:border-primary/30 focus-within:ring-4 focus-within:ring-primary/5 transition-all">
                                {{ form.this_week_work }}
                            </div>
                            {% if form.this_week_work.errors %}
                                <p class="text-[11px] font-bold text-rose-500 ml-1">{{ form.this_week_work.errors.0 }}</p>
                            {% endif %}
                            <p class="text-[10px] text-slate-400 font-medium ml-1 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[12px]">lightbulb</span>
                                우측 "업무 추가" 버튼으로 진행 중인 업무를 선택하여 자동으로 텍스트를 추가할 수 있습니다.
                            </p>
                        </div>

                        <!-- Next Week's Plan -->
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 ml-1">
                                    <span class="material-symbols-outlined text-slate-400 text-[20px]">upcoming</span>
                                    <label for="{{ form.next_week_plan.id_for_label }}" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ form.next_week_plan.label }}</label>
                                </div>
                                <button type="button" onclick="showTaskSelector('next_week')" class="h-8 px-4 flex items-center gap-1.5 rounded-full bg-slate-100 text-slate-600 font-bold text-[11px] hover:bg-slate-200 transition-all">
                                    <span class="material-symbols-outlined text-[14px]">add</span>
                                    업무 추가
                                </button>
                            </div>
                            <div class="bg-slate-50 rounded-md border border-slate-200 overflow-hidden focus-within:border-primary/30 focus-within:ring-4 focus-within:ring-primary/5 transition-all focus-within:bg-white text-slate-900">
                                {{ form.next_week_plan }}
                            </div>
                            {% if form.next_week_plan.errors %}
                                <p class="text-[11px] font-bold text-rose-500 ml-1">{{ form.next_week_plan.errors.0 }}</p>
                            {% endif %}
                        </div>

                        {{ form.display_order }}

                        <!-- Actions -->
                        <div class="flex items-center gap-4 pt-6">
                            <button type="submit" class="flex-1 h-14 flex items-center justify-center gap-2 rounded-2xl bg-slate-900 text-white font-bold text-base hover:bg-slate-800 transition-all shadow-lg shadow-slate-200">
                                <span class="material-symbols-outlined text-[20px]">save</span>
                                {% if object %}수정하기{% else %}저장하기{% endif %}
                            </button>
                            <a href="{% url 'worklog_list' %}" class="flex-1 h-14 flex items-center justify-center gap-2 rounded-2xl bg-slate-100 text-slate-500 font-bold text-base hover:bg-slate-200 transition-all">
                                <span class="material-symbols-outlined text-[20px]">close</span>
                                취소
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar Column -->
        <div class="lg:col-span-4 space-y-6">
            <!-- AI Guide Card -->
            <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden p-8 space-y-6">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-500">
                        <span class="material-symbols-outlined text-[24px]">smart_toy</span>
                    </div>
                    <h3 class="text-base font-extrabold text-slate-900 tracking-tight">AI 작성 가이드</h3>
                </div>
                
                <p class="text-xs font-semibold text-slate-500 leading-relaxed">
                    최근 4개의 주간보고를 기반으로 작성할 내용을 추천받을 수 있습니다.
                </p>

                <button type="button" id="ai-guide-btn" class="w-full h-12 flex items-center justify-center gap-2 rounded-2xl bg-indigo-600 text-white font-bold text-sm hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100 group">
                    <span class="material-symbols-outlined text-[20px] group-hover:rotate-12 transition-transform">magic_button</span>
                    AI 추천받기
                </button>

                <!-- Loading State -->
                <div id="ai-guide-loading" class="hidden py-8 flex flex-col items-center justify-center gap-4">
                    <div class="relative size-12">
                        <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    <p class="text-[11px] font-bold text-slate-400">AI가 데이터를 분석 중입니다...</p>
                </div>

                <!-- Results -->
                <div id="ai-guide-result" class="space-y-6"></div>
            </div>
            <!-- Attachments Card -->
            <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden p-8">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-6 ml-1 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[16px]">attach_file</span>
                    첨부파일
                </h4>
                
                <div class="space-y-3">
                    {% if files %}
                        {% for file in files %}
                        <div class="flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-2xl group hover:border-primary/30 transition-all">
                            <div class="flex items-center gap-3 min-w-0">
                                <span class="material-symbols-outlined text-primary/40 text-[20px]">description</span>
                                <div class="min-w-0">
                                    <p class="text-[11px] font-bold text-slate-700 truncate" title="{{ file.original_name }}">{{ file.original_name }}</p>
                                    <p class="text-[10px] text-slate-400">{{ file.uploaded_at|date:"m/d H:i" }}</p>
                                </div>
                            </div>
                            <a href="{% url 'download_worklog_file' file.id %}" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-primary hover:bg-white transition-all">
                                <span class="material-symbols-outlined text-[18px]">download</span>
                            </a>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-[11px] text-slate-400 italic">첨부파일이 없습니다.</p>
                    {% endif %}

                    {% if editable %}
                    <form method="post" action="{% url 'upload_worklog_file' worklog.id %}" enctype="multipart/form-data" class="mt-6 pt-6 border-t border-slate-100">
                        {% csrf_token %}
                        <div class="flex flex-col gap-4">
                            <label class="cursor-pointer group">
                                <div class="flex flex-col items-center justify-center py-4 px-2 border-2 border-dashed border-slate-200 rounded-2xl group-hover:bg-slate-50 group-hover:border-primary/30 transition-all">
                                    <span class="material-symbols-outlined text-slate-300 group-hover:text-primary transition-colors text-[24px]">upload_file</span>
                                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-primary mt-1" id="file-label">파일 선택</span>
                                </div>
                                <input type="file" name="file" class="hidden" required onchange="this.closest('label').querySelector('#file-label').textContent = this.files[0].name.substring(0, 15) + (this.files[0].name.length > 15 ? '...' : '')">
                            </label>
                            <button type="submit" class="w-full h-10 flex items-center justify-center gap-2 rounded-xl bg-slate-100 text-slate-600 font-bold text-xs hover:bg-slate-200 transition-all">
                                <span class="material-symbols-outlined text-[18px]">cloud_upload</span>
                                업로드
                            </button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
            <!-- Recent Worklogs Card -->
            {% if recent_worklogs %}
            <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden p-8 space-y-6">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-400">
                        <span class="material-symbols-outlined text-[24px]">history</span>
                    </div>
                    <h3 class="text-base font-extrabold text-slate-900 tracking-tight">최근 주간업무</h3>
                </div>

                <div class="space-y-3">
                    {% for worklog in recent_worklogs %}
                    <div class="flex items-center justify-between p-4 bg-slate-50 border border-slate-100 rounded-2xl group hover:border-primary/30 transition-all">
                        <div class="min-w-0">
                            <a href="{% url 'worklog_detail' worklog.pk %}" class="text-xs font-bold text-slate-800 hover:text-primary transition-colors block truncate">{{ worklog.month_week_display }}</a>
                            <span class="text-[10px] font-semibold text-slate-400">{{ worklog.created_at|date:"m/d H:i" }}</span>
                        </div>
                        <a href="{% url 'worklog_detail' worklog.pk %}" class="size-8 flex items-center justify-center rounded-lg bg-white text-slate-400 hover:text-primary hover:shadow-sm transition-all shadow-slate-100">
                            <span class="material-symbols-outlined text-[18px]">open_in_new</span>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Task Selector Modal -->
<div id="taskSelectorModal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeTaskModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <div class="inline-block align-bottom bg-white rounded-[2.5rem] text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full border border-slate-200">
            <div class="px-8 py-6 border-b border-slate-50 bg-slate-50/50 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary text-[24px]">assignment</span>
                    <h3 class="text-xl font-extrabold text-slate-900 tracking-tight" id="modal-title">업무 선택</h3>
                </div>
                <button onclick="closeTaskModal()" class="size-10 flex items-center justify-center rounded-xl bg-slate-100 text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-all">
                    <span class="material-symbols-outlined text-[20px]">close</span>
                </button>
            </div>
            
            <div class="p-8 space-y-6">
                <div class="relative group">
                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors text-[20px]">search</span>
                    <input type="text" id="taskSearchInput" placeholder="업무 제목으로 검색..." 
                           class="w-full h-12 pl-12 pr-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-bold text-slate-700 placeholder:text-slate-400 focus:bg-white focus:ring-4 focus:ring-primary/10 transition-all outline-none">
                </div>

                <div id="taskList" class="max-h-[400px] overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>

            <div class="px-8 py-6 bg-slate-50/50 border-t border-slate-50 flex justify-end">
                <button onclick="closeTaskModal()" class="h-12 px-8 flex items-center justify-center rounded-2xl bg-white border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-100 transition-all">
                    닫기
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentTargetField = '';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function showTaskSelector(targetField) {
        currentTargetField = targetField;
        const modal = document.getElementById('taskSelectorModal');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loadUserTasks();
    }

    function closeTaskModal() {
        const modal = document.getElementById('taskSelectorModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function loadUserTasks(search = '') {
        const taskList = document.getElementById('taskList');
        taskList.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin size-8 border-4 border-primary/20 border-t-primary rounded-full"></div></div>';
        
        fetch(`{% url 'get_user_tasks_api' %}?search=${encodeURIComponent(search)}`)
            .then(response => response.json())
            .then(data => {
                taskList.innerHTML = '';
                if (data.tasks && data.tasks.length > 0) {
                    data.tasks.forEach(task => {
                        const item = document.createElement('div');
                        item.className = 'group p-4 bg-white border border-slate-100 rounded-[1.5rem] flex items-center justify-between hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5 transition-all';
                        
                        const priorityClass = task.priority === '긴급' ? 'bg-rose-500' : 
                                            task.priority === '높음' ? 'bg-orange-500' : 
                                            task.priority === '낮음' ? 'bg-emerald-500' : 'bg-blue-500';
                        
                        item.innerHTML = `
                            <div class="min-w-0 pr-4">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="px-1.5 py-0.5 rounded text-[9px] font-black text-white uppercase tracking-tighter ${priorityClass}">${task.priority}</span>
                                    <h4 class="text-sm font-bold text-slate-800 truncate">${task.title}</h4>
                                </div>
                                <div class="flex items-center gap-3 text-[10px] font-bold text-slate-400">
                                    <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[12px]">flag</span>${task.status}</span>
                                    ${task.category ? `<span class="flex items-center gap-1"><span class="material-symbols-outlined text-[12px]">label</span>${task.category}</span>` : ''}
                                    ${task.due_date ? `<span class="flex items-center gap-1"><span class="material-symbols-outlined text-[12px]">event</span>${task.due_date}</span>` : ''}
                                </div>
                            </div>
                            <button onclick="addTaskToText('${task.id}', '${task.title.replace(/'/g, "\\'")}')" class="size-10 shrink-0 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 group-hover:bg-primary group-hover:text-white transition-all">
                                <span class="material-symbols-outlined text-[18px]">add</span>
                            </button>
                        `;
                        taskList.appendChild(item);
                    });
                } else {
                    taskList.innerHTML = '<div class="py-12 text-center text-xs font-bold text-slate-400 italic">검색된 업무가 없습니다.</div>';
                }
            });
    }

    function addTaskToText(taskId, title) {
        const editorId = currentTargetField === 'this_week' ? '{{ form.this_week_work.id_for_label }}' : '{{ form.next_week_plan.id_for_label }}';
        const taskHtml = `<strong>◆ ${title}</strong>`;
        $(`#${editorId}`).summernote('pasteHTML', taskHtml);
        closeTaskModal();
    }

    function copyWorklog(worklogId, weekDisplay) {
        if (confirm(`"${weekDisplay}" 워크로그 내용을 복사하시겠습니까?\n작성 중인 내용은 덮어쓰여집니다.`)) {
            fetch(`/worklog/api/copy/${worklogId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.this_week_work) $('#{{ form.this_week_work.id_for_label }}').summernote('code', data.this_week_work);
                        if (data.next_week_plan) $('#{{ form.next_week_plan.id_for_label }}').summernote('code', data.next_week_plan);
                    }
                });
        }
    }

    // AI Writing Guide
    document.addEventListener('DOMContentLoaded', function() {
        const guideBtn = document.getElementById('ai-guide-btn');
        const loadingDiv = document.getElementById('ai-guide-loading');
        const resultDiv = document.getElementById('ai-guide-result');

        if (guideBtn) {
            guideBtn.addEventListener('click', function() {
                loadingDiv.classList.remove('hidden');
                resultDiv.innerHTML = '';
                guideBtn.disabled = true;

                fetch("{% url 'writing_guide' %}")
                    .then(response => response.json())
                    .then(data => {
                        loadingDiv.classList.add('hidden');
                        guideBtn.disabled = false;
                        
                        if (data.error) {
                            resultDiv.innerHTML = `<div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-[11px] font-bold text-amber-700">${data.error}</div>`;
                            return;
                        }

                        renderGuideSection('금주 실적 추천', data.suggested_this_week_work, 'this_week_work', 'task_alt');
                        renderGuideSection('차주 계획 추천', data.suggested_next_week_plan, 'next_week_plan', 'upcoming');
                        
                        if (!data.suggested_this_week_work?.length && !data.suggested_next_week_plan?.length) {
                            resultDiv.innerHTML = '<div class="p-8 text-center text-[11px] font-bold text-slate-400 italic">추천할 내용이 없습니다.</div>';
                        }
                    });
            });
        }

        function renderGuideSection(title, items, editorKey, icon) {
            if (!items?.length) return;
            
            const section = document.createElement('div');
            section.className = 'space-y-4';
            section.innerHTML = `
                <div class="flex items-center gap-2 ml-1">
                    <span class="material-symbols-outlined text-[16px] text-slate-400">${icon}</span>
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${title}</h4>
                </div>
                <div class="space-y-2"></div>
            `;
            
            const container = section.querySelector('.space-y-2');
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'group p-4 bg-slate-50 border border-slate-100 rounded-2xl hover:bg-white hover:border-indigo-100 hover:shadow-lg transition-all';
                card.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <div>
                            <p class="text-[11px] font-bold text-slate-800 line-clamp-1">◆ ${item.title}</p>
                            <p class="text-[10px] text-slate-400 font-medium leading-relaxed mt-1 line-clamp-2">${item.content}</p>
                        </div>
                        <button class="h-8 w-full flex items-center justify-center gap-1.5 rounded-xl bg-white border border-slate-100 text-[10px] font-black tracking-tighter text-indigo-500 hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                            <span class="material-symbols-outlined text-[14px]">add</span>
                            본문에 추가
                        </button>
                    </div>
                `;
                card.querySelector('button').onclick = () => {
                   const editorId = (editorKey === 'this_week_work') ? '{{ form.this_week_work.id_for_label }}' : '{{ form.next_week_plan.id_for_label }}';
                   const html = `<strong>◆ ${item.title}</strong><br>${item.content}<br><br>`;
                   $(`#${editorId}`).summernote('pasteHTML', html);
                };
                container.appendChild(card);
            });
            resultDiv.appendChild(section);
        }
    });

    // Summernote Init
    $(document).ready(function() {
        const summernoteOptions = {
            height: 300,
            lang: "ko-KR",
            toolbar: [
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol']],
                ['table', ['table', 'codeview']]
            ],
            styleTags: ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
            callbacks: {
                onInit: function() {
                    $('.note-editor').addClass('!border-0 !rounded-0');
                    $('.note-toolbar').addClass('!bg-slate-50 !border-b-slate-100 !px-6 !py-4');
                    $('.note-editable').addClass('!px-8 !py-6 !text-sm !text-slate-700 !leading-relaxed custom-scrollbar prose prose-slate max-w-none');
                }
            }
        };

        $('#{{ form.this_week_work.id_for_label }}').summernote({
            ...summernoteOptions,
            placeholder: '금주 실적을 입력해주세요.'
        });
        $('#{{ form.next_week_plan.id_for_label }}').summernote({
            ...summernoteOptions,
            placeholder: '차주 계획을 입력해주세요.'
        });

        // Search Timeout
        const searchInput = document.getElementById('taskSearchInput');
        let searchTimeout;
        searchInput?.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadUserTasks(this.value), 300);
        });
    });
</script>
{% endblock %}
