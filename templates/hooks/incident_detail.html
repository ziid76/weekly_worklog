{% extends 'basic.html' %}
{% load static %}

{% block title %}인시던트 상세 - ITMS{% endblock %}

{% block content %}
<main class="flex-1 flex flex-col min-w-0 overflow-y-auto pb-12">
    <div class="flex flex-col gap-8 max-w-[1400px] mx-auto w-full px-4 md:px-8 py-8">
        
        <!-- Back Button & Status Badge -->
        <div class="flex items-center justify-between">
            <a href="{% url 'hooks:incident_list' %}" class="flex items-center gap-2 text-slate-500 hover:text-slate-900 transition-colors font-bold text-sm">
                <span class="material-symbols-outlined text-lg">arrow_back</span>
                목록으로 돌아가기
            </a>
            <div class="flex items-center gap-3">
                 <span class="px-3 py-1 rounded-full text-xs font-black uppercase
                    {% if incident.status == 'open' %}bg-rose-100 text-rose-600
                    {% elif incident.status == 'acknowledged' %}bg-amber-100 text-amber-600
                    {% elif incident.status == 'resolved' %}bg-emerald-100 text-emerald-600
                    {% else %}bg-slate-100 text-slate-600{% endif %}">
                    {{ incident.get_status_display }}
                </span>
                <span class="px-3 py-1 rounded-full text-xs font-black uppercase
                    {% if incident.level == 'fatal' or incident.level == 'critical' %}bg-rose-500 text-white
                    {% elif incident.level == 'warning' %}bg-amber-400 text-white
                    {% else %}bg-blue-400 text-white{% endif %}">
                    {{ incident.get_level_display }}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Info Panel -->
            <div class="lg:col-span-2 flex flex-col gap-8">
                <!-- Title & Description -->
                <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100">
                    <h2 class="text-2xl font-black text-slate-900 mb-4">{{ incident.title }}</h2>
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100 mb-6">
                        <p class="text-sm text-slate-600 whitespace-pre-wrap leading-relaxed font-medium">{{ incident.description }}</p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6 pt-6 border-t border-slate-50">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Project</span>
                            <span class="text-sm font-bold text-slate-800">{{ incident.projectName }}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Object</span>
                            <span class="text-sm font-bold text-slate-800">{{ incident.oname }}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Metric</span>
                            <span class="text-sm font-bold text-slate-800">{{ incident.metricName }}</span>
                        </div>
                         <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Source</span>
                            <span class="text-sm font-bold text-slate-800">{{ incident.source.name }}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Created At</span>
                            <span class="text-sm font-bold text-slate-800">{{ incident.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Resolved At</span>
                            <span class="text-sm font-bold text-slate-800">{{ incident.resolved_at|date:"Y-m-d H:i"|default:"-" }}</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline / Events -->
                <div class="flex flex-col gap-4">
                    <h3 class="text-lg font-black text-slate-900 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">history</span>
                        Incident Timeline
                    </h3>
                    <div class="relative pl-8 space-y-6 before:absolute before:left-3 before:top-2 before:bottom-2 before:w-[2px] before:bg-slate-100">
                        {% for event in events %}
                        <div class="relative">
                            <!-- Timeline Dot -->
                            <div class="absolute -left-[26px] top-1 size-4 rounded-full bg-white border-2 
                                {% if event.event_type == 'created' %}border-rose-400
                                {% elif event.event_type == 'status_changed' %}border-amber-400
                                {% elif event.event_type == 'commented' %}border-blue-400
                                {% else %}border-slate-300{% endif %} z-10"></div>
                            
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-black text-slate-900">
                                            {% if event.user %}{{ event.user.profile.display_name }}{% else %}System{% endif %}
                                        </span>
                                        <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-50 text-slate-500 uppercase">{{ event.event_type }}</span>
                                    </div>
                                    <span class="text-[10px] font-medium text-slate-400">{{ event.created_at|date:"Y-m-d H:i" }}</span>
                                </div>
                                <p class="text-xs text-slate-600 font-medium leading-normal">{{ event.message }}</p>
                                
                                {% if event.raw_event %}
                                <div class="mt-3 pt-3 border-t border-slate-50">
                                    <details class="group">
                                        <summary class="text-[10px] font-bold text-primary cursor-pointer hover:underline list-none flex items-center gap-1">
                                            <span class="material-symbols-outlined text-sm group-open:rotate-180 transition-transform">expand_more</span>
                                            Raw Webhook Payload 보기
                                        </summary>
                                        <pre class="mt-2 p-3 bg-slate-900 text-emerald-400 rounded-lg text-[9px] overflow-x-auto font-mono">{{ event.raw_event.payload|json_script:"raw-payload" }}<script>document.write(JSON.stringify(JSON.parse(document.getElementById('raw-payload').textContent), null, 2))</script></pre>
                                    </details>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Right Actions Panel -->
            <div class="flex flex-col gap-6">
                <!-- Status Management -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h4 class="text-sm font-black text-slate-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-slate-400">tune</span>
                        Status Actions
                    </h4>
                    <form method="POST" class="flex flex-col gap-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_status">
                        <div class="grid grid-cols-2 gap-2">
                            <button type="submit" name="status" value="open" class="py-2.5 rounded-xl border {% if incident.status == 'open' %}bg-rose-50 border-rose-200 text-rose-600{% else %}bg-white border-slate-200 text-slate-400 hover:bg-slate-50{% endif %} text-[11px] font-black uppercase transition-all">Open</button>
                            <button type="submit" name="status" value="acknowledged" class="py-2.5 rounded-xl border {% if incident.status == 'acknowledged' %}bg-amber-50 border-amber-200 text-amber-600{% else %}bg-white border-slate-200 text-slate-400 hover:bg-slate-50{% endif %} text-[11px] font-black uppercase transition-all">Ack</button>
                            <button type="submit" name="status" value="resolved" class="py-2.5 rounded-xl border {% if incident.status == 'resolved' %}bg-emerald-50 border-emerald-200 text-emerald-600{% else %}bg-white border-slate-200 text-slate-400 hover:bg-slate-50{% endif %} text-[11px] font-black uppercase transition-all">Resolve</button>
                            <button type="submit" name="status" value="closed" class="py-2.5 rounded-xl border {% if incident.status == 'closed' %}bg-slate-900 border-slate-900 text-white{% else %}bg-white border-slate-200 text-slate-400 hover:bg-slate-50{% endif %} text-[11px] font-black uppercase transition-all">Close</button>
                        </div>
                    </form>
                </div>

                <!-- Add Comment -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h4 class="text-sm font-black text-slate-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-slate-400">add_comment</span>
                        Add Comment
                    </h4>
                    <form method="POST" class="flex flex-col gap-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_comment">
                        <textarea name="comment" rows="4" class="w-full p-4 rounded-xl border border-slate-100 bg-slate-50/50 text-xs font-medium focus:ring-2 focus:ring-primary/20 transition-all outline-none resize-none" placeholder="인시던트에 대한 의견을 남겨주세요..."></textarea>
                        <button type="submit" class="w-full py-3 bg-primary text-white rounded-xl text-xs font-black uppercase shadow-lg shadow-primary/20 hover:shadow-primary/30 transition-all">댓글 등록</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}
