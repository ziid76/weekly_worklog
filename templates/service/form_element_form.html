{% extends "basic.html" %}

{% block page_name %}
{% if action == 'create' %}신청항목 추가{% else %}신청항목 수정{% endif %}
{% endblock %}

{% block content %}
<main class="flex-1 flex flex-col min-w-0 overflow-y-auto pb-12">
    <div class="max-w-[1400px] mx-auto w-full px-4 md:px-8 py-8 flex flex-col gap-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
            <div class="flex flex-col gap-1">
                <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">
                    {% if action == 'create' %}신청항목 추가{% else %}신청항목 수정{% endif %}
                </h1>
                <p class="text-slate-500 font-medium">서비스 요청 폼의 항목을 관리합니다.</p>
            </div>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-8 md:p-12">
                <form method="post" id="elementForm" class="flex flex-col gap-8">
                    {% csrf_token %}
                    
                    <!-- Dataset Info -->
                    <div class="flex flex-col gap-6">
                        <h3 class="text-lg font-bold text-slate-900">데이터셋 정보</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex flex-col gap-2">
                                <label for="dataset_name" class="text-xs font-bold uppercase tracking-wider text-slate-400">
                                    데이터셋 이름 <span class="text-rose-500">*</span>
                                </label>
                                <input type="text" 
                                       class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium" 
                                       id="dataset_name" 
                                       name="dataset_name" 
                                       value="{% if element %}{{ element.dataset.name }}{% endif %}" 
                                       required>
                            </div>
                            <div class="flex flex-col gap-2">
                                <label for="dataset_code" class="text-xs font-bold uppercase tracking-wider text-slate-400">
                                    데이터셋 코드 <span class="text-rose-500">*</span>
                                </label>
                                <input type="text" 
                                       class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium" 
                                       id="dataset_code" 
                                       name="dataset_code" 
                                       value="{% if element %}{{ element.dataset.code }}{% endif %}" 
                                       required>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Elements Section -->
                    <div class="border-t border-slate-100 pt-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-slate-900">폼 요소 목록</h3>
                            <button type="button" 
                                    class="rounded-full bg-emerald-500 text-white font-bold px-6 py-2.5 hover:bg-emerald-600 transition-all shadow-lg shadow-emerald-500/20 flex items-center gap-2" 
                                    onclick="addElement()">
                                <span class="material-symbols-outlined text-lg">add</span>
                                요소 추가
                            </button>
                        </div>
                        
                        <div id="elementsContainer" class="flex flex-col gap-6">
                            {% if action == 'edit' %}
                                <!-- Single element edit mode -->
                                <div class="element-row bg-slate-50 rounded-[1.5rem] p-6 border border-slate-100">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                        <div class="flex flex-col gap-2">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-400">
                                                요소 이름 <span class="text-rose-500">*</span>
                                            </label>
                                            <input type="text" 
                                                   class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                                                   name="elements[0][element_name]" 
                                                   value="{{ element.element_name }}" 
                                                   required>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-400">
                                                요소 코드 <span class="text-rose-500">*</span>
                                            </label>
                                            <input type="text" 
                                                   class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                                                   name="elements[0][element_code]" 
                                                   value="{{ element.element_code }}" 
                                                   required>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-400">
                                                요소 유형 <span class="text-rose-500">*</span>
                                            </label>
                                            <select class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                                                    name="elements[0][element_type]" 
                                                    required>
                                                <option value="text" {% if element.element_type == 'text' %}selected{% endif %}>텍스트</option>
                                                <option value="textarea" {% if element.element_type == 'textarea' %}selected{% endif %}>텍스트영역</option>
                                                <option value="select" {% if element.element_type == 'select' %}selected{% endif %}>선택박스</option>
                                                <option value="checkbox" {% if element.element_type == 'checkbox' %}selected{% endif %}>체크박스</option>
                                                <option value="radio" {% if element.element_type == 'radio' %}selected{% endif %}>라디오버튼</option>
                                                <option value="number" {% if element.element_type == 'number' %}selected{% endif %}>숫자</option>
                                                <option value="date" {% if element.element_type == 'date' %}selected{% endif %}>날짜</option>
                                                <option value="email" {% if element.element_type == 'email' %}selected{% endif %}>이메일</option>
                                            </select>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-400">순서</label>
                                            <input type="number" 
                                                   class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                                                   name="elements[0][order]" 
                                                   value="{{ element.order|default:0 }}">
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-400">필수</label>
                                            <div class="flex items-center h-12">
                                                <input class="size-5 rounded border-slate-300 text-primary focus:ring-primary/20" 
                                                       type="checkbox" 
                                                       name="elements[0][is_required]" 
                                                       {% if element.is_required %}checked{% endif %}>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-xs font-bold uppercase tracking-wider text-slate-400">플레이스홀더</label>
                                        <input type="text" 
                                               class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                                               name="elements[0][placeholder]" 
                                               value="{{ element.placeholder|default:'' }}">
                                    </div>
                                </div>
                            {% else %}
                                <!-- Create mode starts empty -->
                            {% endif %}
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-8 border-t border-slate-100">
                        <a href="{% url 'form_element_list' %}" 
                           class="rounded-full bg-slate-50 text-slate-600 font-bold px-6 py-3 hover:bg-slate-100 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">arrow_back</span>
                            취소
                        </a>
                        <button type="submit" 
                                class="rounded-full bg-primary text-white font-bold px-6 py-3 hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">save</span>
                            {% if action == 'create' %}추가{% else %}수정{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<script>
let elementIndex = {% if action == 'edit' %}1{% else %}0{% endif %};

function addElement() {
    const container = document.getElementById('elementsContainer');
    const elementHtml = `
        <div class="element-row bg-slate-50 rounded-[1.5rem] p-6 border border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs font-bold uppercase tracking-wider text-slate-400">요소 #${elementIndex + 1}</span>
                <button type="button" class="size-8 rounded-lg bg-rose-50 text-rose-500 hover:bg-rose-100 transition-all flex items-center justify-center" onclick="removeElement(this)">
                    <span class="material-symbols-outlined text-lg">delete</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400">
                        요소 이름 <span class="text-rose-500">*</span>
                    </label>
                    <input type="text" 
                           class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                           name="elements[${elementIndex}][element_name]" 
                           required>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400">
                        요소 코드 <span class="text-rose-500">*</span>
                    </label>
                    <input type="text" 
                           class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                           name="elements[${elementIndex}][element_code]" 
                           required>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400">
                        요소 유형 <span class="text-rose-500">*</span>
                    </label>
                    <select class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                            name="elements[${elementIndex}][element_type]" 
                            required>
                        <option value="text">텍스트</option>
                        <option value="textarea">텍스트영역</option>
                        <option value="select">선택박스</option>
                        <option value="checkbox">체크박스</option>
                        <option value="radio">라디오버튼</option>
                        <option value="number">숫자</option>
                        <option value="date">날짜</option>
                        <option value="email">이메일</option>
                    </select>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400">순서</label>
                    <input type="number" 
                           class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                           name="elements[${elementIndex}][order]" 
                           value="${elementIndex}">
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400">필수</label>
                    <div class="flex items-center h-12">
                        <input class="size-5 rounded border-slate-300 text-primary focus:ring-primary/20" 
                               type="checkbox" 
                               name="elements[${elementIndex}][is_required]">
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-xs font-bold uppercase tracking-wider text-slate-400">플레이스홀더</label>
                <input type="text" 
                       class="w-full px-4 py-3 rounded-md border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm font-medium bg-white" 
                       name="elements[${elementIndex}][placeholder]">
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', elementHtml);
    elementIndex++;
}

function removeElement(button) {
    button.closest('.element-row').remove();
}

// Add first element on create mode
{% if action == 'create' %}
document.addEventListener('DOMContentLoaded', function() {
    addElement();
});
{% endif %}
</script>
{% endblock %}
