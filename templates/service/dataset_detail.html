{% extends "base.html" %}

{% block page_name %}
데이터셋 관리 - {{ dataset.name }}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">데이터셋 관리</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="datasetForm">
                        {% csrf_token %}
                        
                        <!-- Dataset Info -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dataset_name" class="form-label">데이터셋 이름 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="dataset_name" name="dataset_name" 
                                           value="{{ dataset.name }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dataset_code" class="form-label">데이터셋 코드 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="dataset_code" name="dataset_code" 
                                           value="{{ dataset.code }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dataset_description" class="form-label">설명</label>
                                    <input type="text" class="form-control" id="dataset_description" name="dataset_description" 
                                           value="{{ dataset.description }}">
                                </div>
                            </div>
                        </div>

                        <!-- Elements Section -->
                        <div class="border-top pt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>폼 요소 목록</h6>
                                <button type="button" class="btn btn-success btn-sm" onclick="addElement()">
                                    <i class="fas fa-plus"></i> 요소 추가
                                </button>
                            </div>
                            
                            <div id="elementsContainer">
                                {% for element in elements %}
                                    <div class="element-row border rounded p-3 mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">요소 #{{ forloop.counter }}</small>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeElement(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <label class="form-label">요소 이름 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" name="elements[{{ forloop.counter0 }}][element_name]" 
                                                       value="{{ element.element_name }}" required>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">요소 코드 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" name="elements[{{ forloop.counter0 }}][element_code]" 
                                                       value="{{ element.element_code }}" required>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">요소 유형 <span class="text-danger">*</span></label>
                                                <select class="form-control" name="elements[{{ forloop.counter0 }}][element_type]" required>
                                                    <option value="text" {% if element.element_type == 'text' %}selected{% endif %}>텍스트</option>
                                                    <option value="textarea" {% if element.element_type == 'textarea' %}selected{% endif %}>텍스트영역</option>
                                                    <option value="select" {% if element.element_type == 'select' %}selected{% endif %}>선택박스</option>
                                                    <option value="checkbox" {% if element.element_type == 'checkbox' %}selected{% endif %}>체크박스</option>
                                                    <option value="radio" {% if element.element_type == 'radio' %}selected{% endif %}>라디오버튼</option>
                                                    <option value="number" {% if element.element_type == 'number' %}selected{% endif %}>숫자</option>
                                                    <option value="date" {% if element.element_type == 'date' %}selected{% endif %}>날짜</option>
                                                    <option value="email" {% if element.element_type == 'email' %}selected{% endif %}>이메일</option>
                                                </select>
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label">순서</label>
                                                <input type="number" class="form-control" name="elements[{{ forloop.counter0 }}][order]" 
                                                       value="{{ element.order }}">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">행 그룹</label>
                                                <input type="text" class="form-control" name="elements[{{ forloop.counter0 }}][row_group]" 
                                                       value="{{ element.row_group }}" placeholder="예: row1">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">열 너비</label>
                                                <select class="form-control" name="elements[{{ forloop.counter0 }}][col_width]">
                                                    <option value="12" {% if element.col_width == 12 %}selected{% endif %}>전체 (12/12)</option>
                                                    <option value="6" {% if element.col_width == 6 %}selected{% endif %}>절반 (6/12)</option>
                                                    <option value="4" {% if element.col_width == 4 %}selected{% endif %}>1/3 (4/12)</option>
                                                    <option value="3" {% if element.col_width == 3 %}selected{% endif %}>1/4 (3/12)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label">필수</label>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" name="elements[{{ forloop.counter0 }}][is_required]" 
                                                           {% if element.is_required %}checked{% endif %}>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-md-12">
                                                <label class="form-label">플레이스홀더</label>
                                                <input type="text" class="form-control" name="elements[{{ forloop.counter0 }}][placeholder]" 
                                                       value="{{ element.placeholder }}">
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'form_element_list' %}" class="btn btn-secondary">목록으로</a>
                            <button type="submit" class="btn btn-primary">저장</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let elementIndex = {{ elements|length }};

function addElement() {
    const container = document.getElementById('elementsContainer');
    const elementHtml = `
        <div class="element-row border rounded p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">요소 #${elementIndex + 1}</small>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeElement(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">요소 이름 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="elements[${elementIndex}][element_name]" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">요소 코드 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="elements[${elementIndex}][element_code]" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">요소 유형 <span class="text-danger">*</span></label>
                    <select class="form-control" name="elements[${elementIndex}][element_type]" required>
                        <option value="text">텍스트</option>
                        <option value="textarea">텍스트영역</option>
                        <option value="select">선택박스</option>
                        <option value="checkbox">체크박스</option>
                        <option value="radio">라디오버튼</option>
                        <option value="number">숫자</option>
                        <option value="date">날짜</option>
                        <option value="email">이메일</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">순서</label>
                    <input type="number" class="form-control" name="elements[${elementIndex}][order]" value="${elementIndex}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">행 그룹</label>
                    <input type="text" class="form-control" name="elements[${elementIndex}][row_group]" placeholder="예: row1">
                </div>
                <div class="col-md-2">
                    <label class="form-label">열 너비</label>
                    <select class="form-control" name="elements[${elementIndex}][col_width]">
                        <option value="12">전체 (12/12)</option>
                        <option value="6">절반 (6/12)</option>
                        <option value="4">1/3 (4/12)</option>
                        <option value="3">1/4 (3/12)</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">필수</label>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" name="elements[${elementIndex}][is_required]">
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="form-label">플레이스홀더</label>
                    <input type="text" class="form-control" name="elements[${elementIndex}][placeholder]">
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', elementHtml);
    elementIndex++;
}

function removeElement(button) {
    button.closest('.element-row').remove();
}
</script>
{% endblock %}
