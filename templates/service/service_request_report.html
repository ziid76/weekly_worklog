{% extends 'basic.html' %}
{% load static %}

{% block page_name %}SR 리포트{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex flex-col gap-1">
            <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">SR 통계 리포트</h1>
            <p class="text-slate-500 font-medium text-sm">기간별 SR 처리 현황 및 통계 데이터를 시각화하여 제공합니다.</p>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6 overflow-hidden">
        <form class="flex flex-wrap items-end gap-6">
            <div class="flex flex-col gap-2">
                <label for="start_date" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">시작일</label>
                <div class="relative group">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 group-focus-within:text-primary transition-colors">calendar_today</span>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" 
                           class="pl-12 pr-4 py-2.5 bg-slate-50 border-slate-200 focus:bg-white focus:ring-4 focus:ring-primary/10 focus:border-primary rounded-xl text-sm font-bold text-slate-700 transition-all outline-none">
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <label for="end_date" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">종료일</label>
                <div class="relative group">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 group-focus-within:text-primary transition-colors">event</span>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" 
                           class="pl-12 pr-4 py-2.5 bg-slate-50 border-slate-200 focus:bg-white focus:ring-4 focus:ring-primary/10 focus:border-primary rounded-xl text-sm font-bold text-slate-700 transition-all outline-none">
                </div>
            </div>
            <button type="submit" class="h-[46px] px-8 rounded-xl bg-slate-900 text-white font-bold text-sm shadow-lg shadow-slate-200 hover:bg-slate-800 transition-all flex items-center gap-2">
                <span class="material-symbols-outlined text-[20px]">search</span>
                조회하기
            </button>
        </form>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Chart 1: SR Count -->
        <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm p-8 flex flex-col gap-6">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center">
                    <span class="material-symbols-outlined">bar_chart</span>
                </div>
                <div>
                    <h3 class="text-base font-bold text-slate-900">담당자별 SR 총 건수</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Total SR Count by Assignee</p>
                </div>
            </div>
            <div class="h-[400px] w-full">
                <canvas id="srCountChart"></canvas>
            </div>
        </div>

        <!-- Chart 4: System Distribution -->
        <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm p-8 flex flex-col gap-6">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center">
                    <span class="material-symbols-outlined">pie_chart</span>
                </div>
                <div>
                    <h3 class="text-base font-bold text-slate-900">시스템별 SR 현황</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">SR Distribution by System</p>
                </div>
            </div>
            <div class="h-[400px] w-full">
                <canvas id="systemPieChart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Effort -->
        <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm p-8 flex flex-col gap-6 lg:col-span-2">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                    <span class="material-symbols-outlined">timeline</span>
                </div>
                <div>
                    <h3 class="text-base font-bold text-slate-900">월별 담당자별 투입공수</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Monthly Effort by Assignee</p>
                </div>
            </div>
            <div class="h-[400px] w-full">
                <canvas id="effortChart"></canvas>
            </div>
        </div>

        <!-- Chart 3: Delay -->
        <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm p-8 flex flex-col gap-6 lg:col-span-2">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-rose-50 text-rose-600 flex items-center justify-center">
                    <span class="material-symbols-outlined">running_with_errors</span>
                </div>
                <div>
                    <h3 class="text-base font-bold text-slate-900">월별 담당자별 지연 건수</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Monthly Delay by Assignee</p>
                </div>
            </div>
            <div class="h-[400px] w-full">
                <canvas id="delayChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>  
{{ months|json_script:"months-data" }}
{{ count_data|json_script:"count-data" }}
{{ effort_data|json_script:"effort-data" }}
{{ delay_data|json_script:"delay-data" }}
{{ system_counts|json_script:"system-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const months = JSON.parse(document.getElementById('months-data').textContent);
    const countData = JSON.parse(document.getElementById('count-data').textContent);
    const effortData = JSON.parse(document.getElementById('effort-data').textContent);
    const delayData = JSON.parse(document.getElementById('delay-data').textContent);
    const systemData = JSON.parse(document.getElementById('system-data').textContent);

    const assignees = Object.keys(countData);
    const colors = ['#0077C8', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4', '#64748B'];

    // Common options function
    function commonOptions(titleText) {
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            family: 'Manrope',
                            size: 11,
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#1e293b',
                    padding: 12,
                    titleFont: { size: 13, weight: '700', family: 'Manrope' },
                    bodyFont: { size: 12, family: 'Manrope' },
                    cornerRadius: 12,
                    displayColors: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#f1f5f9' },
                    ticks: {
                        font: { family: 'Manrope', size: 11, weight: '500' },
                        color: '#64748b'
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { family: 'Manrope', size: 11, weight: '500' },
                        color: '#64748b'
                    }
                }
            }
        };
    }

    function createDatasets(dataObj) {
        return assignees.map((a, idx) => ({
            label: a,
            backgroundColor: colors[idx % colors.length],
            borderColor: colors[idx % colors.length],
            borderRadius: 6,
            data: months.map(m => dataObj[a][m] || 0)
        }));
    }

    // Chart 1 - SR Count
    new Chart(document.getElementById('srCountChart'), {
        type: 'bar',
        data: {
            labels: assignees,
            datasets: [{
                label: 'SR 건수',
                backgroundColor: '#0077C8',
                borderRadius: 8,
                data: assignees.map(a => {
                    return months.reduce((sum, m) => sum + (countData[a][m] || 0), 0);
                })
            }]
        },
        options: {
            ...commonOptions(''),
            indexAxis: 'y',
            plugins: {
                ...commonOptions('').plugins,
                legend: { display: false }
            }
        }
    });

    // Chart 2 - Effort
    new Chart(document.getElementById('effortChart'), {
        type: 'bar',
        data: {
            labels: months,
            datasets: createDatasets(effortData)
        },
        options: commonOptions('')
    });

    // Chart 3 - Delay
    new Chart(document.getElementById('delayChart'), {
        type: 'bar',
        data: {
            labels: months,
            datasets: createDatasets(delayData)
        },
        options: commonOptions('')
    });

    // Chart 4 - Pie Chart
    const sysLabels = systemData.map(i => i.req_system || '미정');
    const sysCounts = systemData.map(i => i.count);

    new Chart(document.getElementById('systemPieChart'), {
        type: 'doughnut',
        data: {
            labels: sysLabels,
            datasets: [{
                data: sysCounts,
                backgroundColor: colors,
                borderWidth: 0,
                hoverOffset: 20
            }]
        },
        options: {
            ...commonOptions(''),
            cutout: '70%',
            plugins: {
                ...commonOptions('').plugins,
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 12, family: 'Manrope' },
                    formatter: (value, ctx) => {
                        let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                        let percentage = (value * 100 / sum).toFixed(0) + "%";
                        return value > 0 ? percentage : '';
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
});
</script>

<style>
    input[type="date"]::-webkit-calendar-picker-indicator {
        background: transparent;
        bottom: 0;
        color: transparent;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        width: auto;
        height: auto;
    }
</style>
{% endblock %}

