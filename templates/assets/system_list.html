{% extends 'basic.html' %}

{% block page_name %}시스템 관리{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
    <!-- Header Section -->
    <div class="flex flex-wrap justify-between items-end gap-4">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">시스템 관리</h1>
            <p class="text-slate-500">전체 IT 시스템 자산을 조회하고 관리합니다.</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'assets:system_export' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}" class="flex items-center gap-2 px-6 py-2.5 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200 transition-all font-bold">
                <span class="material-symbols-outlined text-[20px]">download</span>
                다운로드
            </a>
            <button onclick="document.getElementById('excelModal').showModal()" class="flex items-center gap-2 px-6 py-2.5 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200 transition-all font-bold">
                <span class="material-symbols-outlined text-[20px]">upload_file</span>
                일괄 업데이트
            </button>
            <a href="{% url 'assets:system_create' %}" class="flex items-center gap-2 px-6 py-2.5 rounded-full bg-primary text-white hover:bg-primary/90 transition-all font-bold shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined text-[20px]">add</span>
                시스템 등록
            </a>
        </div>
    </div>

    <!-- Excel Bulk Update Modal -->
    <dialog id="excelModal" class="p-0 rounded-2xl border-none shadow-2xl bg-white w-full max-w-md overflow-hidden backdrop:bg-slate-900/50">
        <div class="flex flex-col">
            <div class="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                    <span class="material-symbols-outlined">upload_file</span>
                    시스템 일괄 업데이트
                </h3>
                <button onclick="document.getElementById('excelModal').close()" class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form action="{% url 'assets:system_bulk_update' %}" method="post" enctype="multipart/form-data" class="p-6">
                {% csrf_token %}
                <div class="mb-6">
                    <p class="text-sm text-slate-500 mb-4">
                        엑셀 파일을 업로드하여 시스템 정보를 일괄 등록하거나 수정합니다.<br>
                        <strong>시스템코드</strong>를 기준으로 기존 데이터는 업데이트 되고, 신규 코드는 등록됩니다.
                    </p>
                    <div class="p-4 bg-primary/5 rounded-xl border border-primary/10 text-xs text-primary mb-4">
                        <p class="font-bold mb-1">엑셀 컬럼:</p>
                        <p>시스템명(필수), 시스템코드(선택), 구분(선택), 설명(선택), 상태(선택), 담당자(선택)</p>
                        <p class="mt-2 text-slate-500">* <strong>시스템코드</strong>: 미입력 시 구분(SAM/SEC)에 따라 자동 생성됩니다.</p>
                        <p class="mt-1 text-slate-500">* <strong>구분</strong>: 일반(SAM) 또는 보안(SEC) 중 입력 (기본값: 일반)</p>
                        <p class="mt-1 text-slate-400">* 상태: 개발중, 운영중, 중단, 폐기</p>
                        <p class="mt-1 text-slate-400">* 담당자: 로그인 ID 또는 이름(성+이름)</p>
                    </div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">파일 선택</label>
                    <input type="file" name="excel_file" accept=".xlsx, .xls" required
                           class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-primary file:text-white hover:file:bg-primary/90 cursor-pointer">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('excelModal').close()" class="px-6 py-2 rounded-xl text-slate-600 font-bold hover:bg-slate-100 transition-all">취소</button>
                    <button type="submit" class="px-6 py-2 rounded-xl bg-primary text-white font-bold hover:bg-primary/90 transition-all">업로드 실행</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- Table Section -->
    <div class="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
        <div class="p-4 bg-slate-50/50 border-b border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <form method="get" class="flex flex-wrap items-center gap-4 w-full md:w-auto">
                <div class="relative flex-1 md:min-w-[300px]">
                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]">search</span>
                    <input type="text" name="q" value="{{ request.GET.q }}" 
                           class="w-full bg-white border border-slate-200 rounded-2xl py-2.5 pl-11 pr-4 text-sm text-slate-900 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" 
                           placeholder="시스템명, 코드, 설명 검색...">
                </div>

                <!-- Status Filter (Task Planner Style) -->
                <div class="flex items-center gap-1 p-1 bg-slate-100 rounded-2xl border border-slate-200 shadow-inner h-[46px]">
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if not current_statuses %}bg-white shadow-sm text-slate-900{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="" class="hidden" onchange="toggleAllStatuses(this)" {% if not current_statuses %}checked{% endif %}>
                        <span class="text-[11px] font-black uppercase">전체</span>
                    </label>
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if 'OPER' in current_statuses %}bg-white shadow-sm text-emerald-600{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="OPER" class="hidden" onchange="this.form.submit()" {% if 'OPER' in current_statuses %}checked{% endif %}>
                        <div class="size-2 rounded-full bg-emerald-500"></div>
                        <span class="text-[11px] font-black uppercase">운영중</span>
                    </label>
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if 'DEV' in current_statuses %}bg-white shadow-sm text-blue-600{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="DEV" class="hidden" onchange="this.form.submit()" {% if 'DEV' in current_statuses %}checked{% endif %}>
                        <div class="size-2 rounded-full bg-blue-500"></div>
                        <span class="text-[11px] font-black uppercase">개발중</span>
                    </label>
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if 'SUSP' in current_statuses %}bg-white shadow-sm text-amber-500{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="SUSP" class="hidden" onchange="this.form.submit()" {% if 'SUSP' in current_statuses %}checked{% endif %}>
                        <div class="size-2 rounded-full bg-amber-400"></div>
                        <span class="text-[11px] font-black uppercase">중단</span>
                    </label>
                    <label class="px-4 py-1.5 rounded-xl cursor-pointer transition-all flex items-center gap-2 {% if 'DISC' in current_statuses %}bg-white shadow-sm text-rose-600{% else %}text-slate-500 hover:text-slate-700{% endif %}">
                        <input type="checkbox" name="status" value="DISC" class="hidden" onchange="this.form.submit()" {% if 'DISC' in current_statuses %}checked{% endif %}>
                        <div class="size-2 rounded-full bg-rose-500"></div>
                        <span class="text-[11px] font-black uppercase">폐기</span>
                    </label>
                </div>
                
                <div class="flex items-center gap-3 px-4 py-2.5 bg-white border border-slate-200 rounded-2xl h-[46px]">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" name="my_system" value="true" onchange="this.form.submit()" {% if my_system %}checked{% endif %} 
                               class="rounded border-slate-300 text-primary focus:ring-primary size-4">
                        <span class="text-sm font-bold text-slate-600 group-hover:text-primary transition-colors">My System</span>
                    </label>
                </div>

                <div class="flex items-center gap-2">
                    <button type="submit" class="px-6 py-2.5 rounded-2xl bg-slate-900 text-white font-bold text-sm hover:bg-slate-800 transition-all flex items-center gap-2 shadow-sm">
                        검색
                    </button>
                    {% if request.GET.q or my_system or current_statuses and current_statuses != 'OPER'|make_list and request.GET.status %}
                    <a href="{% url 'assets:system_list' %}" class="px-6 py-2.5 rounded-2xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-all">
                        초기화
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
        <div class="overflow-x-auto p-4">
            <table class="w-full text-left border-collapse" id="systemTable">
                <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider border-b border-slate-200">
                    <tr>
                        <th class="px-4 py-4 text-center ">시스템 정보</th>
<th class="px-4 py-4 text-center ">설명</th>
                        <th class="px-4 py-4 text-center ">구분</th>
                        <th class="px-4 py-4 text-center ">코드</th>
                        <th class="px-4 py-4 text-center ">담당자</th>
                        <th class="px-4 py-4 text-center ">상태</th>
                        <th class="px-4 py-4 text-center ">오픈일</th>
                        
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 text-sm text-slate-700 ">
                    {% for system in systems %}
                    <tr class="hover:bg-slate-50/80 transition-colors group cursor-pointer" onclick="window.location='{% url 'assets:system_detail' system.pk %}'">
                        <td class="text-center py-4">
                            <div class="flex flex-col">
                                <span class="font-bold group-hover:text-primary transition-colors">{{ system.name }}</span>
                            </div>
                        </td>
                        <td class="">
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500">{{ system.description|truncatechars:50|default:"설명 없음" }}</span>
                            </div>
                        </td>
                        <td class="text-center ">
                            <span class="text-xs text-slate-600">{{ system.get_system_type_display }}</span>
                        </td>
                        <td class="text-center ">
                            <span class="inline-flex px-2 py-1 bg-slate-100 rounded text-xs font-mono text-slate-600">{{ system.code }}</span>
                        </td>
                        <td class="text-center ">{{ system.manager.profile.display_name|default:system.manager.username }}</td>
                        <td class="text-center ">
                            {% if system.status == 'OPER' %}
                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-xl text-[11px] font-bold bg-green-50 text-green-600 border border-green-100 uppercase tracking-wider">
                                    <span class="size-1.5 rounded-full bg-green-500"></span> 운영중
                                </span>
                            {% elif system.status == 'DEV' %}
                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-xl text-[11px] font-bold bg-blue-50 text-blue-600 border border-blue-100 uppercase tracking-wider">
                                    <span class="size-1.5 rounded-full bg-blue-500"></span> 개발중
                                </span>
                            {% elif system.status == 'SUSP' %}
                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-xl text-[11px] font-bold bg-amber-50 text-amber-600 border border-amber-100 uppercase tracking-wider">
                                    <span class="size-1.5 rounded-full bg-amber-500"></span> 중단
                                </span>
                            {% else %}
                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-xl text-[11px] font-bold bg-red-50 text-red-600 border border-red-100 uppercase tracking-wider">
                                    <span class="size-1.5 rounded-full bg-red-500"></span> 폐기
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-center text-slate-500">{{ system.launch_date|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center gap-2 text-slate-400">
                                <span class="material-symbols-outlined text-4xl">inventory_2</span>
                                <p>등록된 시스템이 없습니다.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables Script -->
<script src="https://cdn.datatables.net/v/dt/dt-1.11.3/datatables.min.js"></script>
<script>
    function toggleAllStatuses(allCheckbox) {
        const checkboxes = document.querySelectorAll('input[name="status"]');
        if (allCheckbox.checked) {
            checkboxes.forEach(cb => {
                if (cb !== allCheckbox) cb.checked = false;
            });
        } else {
            allCheckbox.checked = true;
            return;
        }
        allCheckbox.form.submit();
    }

    $(document).ready(function () {
        $('#systemTable').DataTable({
            "searching": false,
            "paging": true,
            "info": true,
            "ordering": true,
            "lengthChange": false,
            "pageLength": 30,
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.11.3/i18n/ko.json"
            },
            "columnDefs": [
                { "orderable": false, "targets": [5] }
            ]
        });
    });
</script>
{% endblock %}
