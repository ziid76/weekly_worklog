{% extends 'basic.html' %}
{% load humanize %}

{% block page_name %}계약 관리{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
    <!-- Header Section -->
    <div class="flex flex-wrap justify-between items-end gap-4">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">계약 관리</h1>
            <p class="text-slate-500">시스템 및 자산 유지보수 계약을 조회하고 관리합니다.</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'assets:contract_create' %}" class="flex items-center gap-2 px-6 py-2.5 rounded-full bg-primary text-white hover:bg-primary/90 transition-all font-bold shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined text-[20px]">add</span>
                계약 등록
            </a>
        </div>
    </div>


    <!-- Table Section -->
    <div class="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
        <div class="p-4 bg-slate-50/50 border-b border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <form method="get" class="flex flex-wrap items-center gap-4 w-full md:w-auto">
                <div class="relative flex-1 md:min-w-[400px]">
                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]">search</span>
                    <input type="text" name="q" value="{{ request.GET.q }}" 
                           class="w-full bg-white border border-slate-200 rounded-2xl py-2.5 pl-11 pr-4 text-sm text-slate-900 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" 
                           placeholder="계약명, 계약업체, 계약 내용 검색...">
                </div>
                
                <div class="flex items-center gap-3 px-4 py-2.5 bg-white  h-[46px]">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" name="my_contract" value="true" onchange="this.form.submit()" {% if my_contract %}checked{% endif %} 
                               class="rounded border-slate-300 text-primary focus:ring-primary size-4">
                        <span class="text-sm font-bold text-slate-600 group-hover:text-primary transition-colors">My Contract</span>
                    </label>
                </div>

                <div class="relative w-40 h-[46px]">
                    <select name="year" onchange="this.form.submit()" class="w-full h-full bg-white border border-slate-200 rounded-2xl py-2.5 pl-11 pr-4 text-sm text-slate-900 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all appearance-none cursor-pointer">
                        <option value="">계약 연도</option>
                        {% for year in year_range %}
                        <option value="{{ year }}" {% if request.GET.year == year|stringformat:"s" %}selected{% endif %}>{{ year }}년</option>
                        {% endfor %}
                    </select>
                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-[20px]">calendar_today</span>
                </div>

                <div class="flex items-center gap-2">
                    <button type="submit" class="px-6 py-2.5 rounded-2xl bg-slate-900 text-white font-bold text-sm hover:bg-slate-800 transition-all flex items-center gap-2 shadow-sm">
                        검색
                    </button>
                    {% if request.GET.q or request.GET.year or my_contract %}
                    <a href="{% url 'assets:contract_list' %}" class="px-6 py-2.5 rounded-2xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-all">
                        초기화
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
        <div class="overflow-x-auto p-4">
            <table class="w-full text-left border-collapse" id="contractTable">
                <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider border-b border-slate-200">
                    <tr>
                        <th class="px-4 py-4 text-center ">계약 정보</th>
                        <th class="px-4 py-4 text-center ">유형</th>
                        <th class="px-4 py-4 text-center ">업체</th>
                        <th class="px-4 py-4 text-center ">담당자</th>
                        <th class="px-4 py-4 text-center ">기간</th>
                        <th class="px-4 py-4 text-center ">금액</th>
                        <th class="px-4 py-4 text-center ">관련시스템</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 text-sm text-slate-700">
                    {% for contract in contracts %}
                    <tr class="hover:bg-slate-50/80 transition-colors group cursor-pointer" onclick="window.location='{% url 'assets:contract_detail' contract.pk %}'">
                        <td class="text-center py-4 ">
                            <div class="flex flex-col items-center">
                                <span class="font-bold group-hover:text-primary transition-colors">{{ contract.name }}</span>
                            </div>
                        </td>
                        <td class="text-center ">
                            <span class="inline-flex px-2.5 py-1 rounded-xl bg-red-50 border border-red-100 text-[11px] font-bold text-red-600 hover:bg-red-100 hover:text-red-700 transition-all">{{ contract.get_contract_type_display }}</span>
                        </td>
                        <td class="text-center ">{{ contract.contractor }}</td>
                        <td class="text-center ">
                            <span class="text-xs font-bold text-slate-600">
                                {{ contract.manager.profile.display_name|default:contract.manager.username|default:"-" }}
                            </span>
                        </td>
                        <td class="text-center ">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-xs font-mono text-slate-600 bg-slate-50 px-2 py-0.5 rounded">{{ contract.start_date|date:"Y-m-d" }} ~ {{ contract.end_date|date:"Y-m-d"}}</span>
                            </div>
                        </td>
                        <td class="text-right md:text-right font-bold text-slate-900 whitespace-nowrap">{{ contract.amount|intcomma }}원</td>
                        <td class="text-center">
                            <div class="flex flex-wrap gap-1.5 justify-center">
                                {% with systems=contract.systems.all system_count=contract.systems.count %}
                                    {% if system_count <= 3 %}
                                        {% for system in systems %}
                                        <a href="{% url 'assets:system_detail' system.pk %}" onclick="event.stopPropagation()"
                                           class="px-2.5 py-1 rounded-full bg-blue-50 border border-blue-100 text-[11px] font-bold text-blue-600 hover:bg-blue-100 hover:text-blue-700 transition-all">
                                            {{ system.name }}
                                        </a>
                                        {% empty %}
                                        <span class="text-slate-300 text-xs">-</span>
                                        {% endfor %}
                                    {% else %}
                                        <a href="{% url 'assets:contract_detail' contract.pk %}" onclick="event.stopPropagation()"
                                           class="px-2.5 py-1 rounded-full bg-blue-50 border border-blue-100 text-[11px] font-bold text-blue-600 hover:bg-blue-100 hover:text-blue-700 transition-all">
                                            {{ systems.first.name }} 외 {{ system_count|add:"-1" }}개
                                        </a>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center gap-2 text-slate-400">
                                <span class="material-symbols-outlined text-4xl">description</span>
                                <p>등록된 계약 정보가 없습니다.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<!-- DataTables Script -->
<script src="https://cdn.datatables.net/v/dt/dt-1.11.3/datatables.min.js"></script>
<script>
    $(document).ready(function () {
        $('#contractTable').DataTable({
            "searching": false, // 상단 커스텀 검색바 사용
            "paging": true,
            "info": true,
            "ordering": true,
            "lengthChange": false, // 페이지 당 항목 수 변경 숨김 (깔끔한 UI 유지)
            "pageLength": 30,
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.11.3/i18n/ko.json"
            },
            "columnDefs": [
                { "orderable": false, "targets": [5] } // 관련시스템 컬럼 정렬 제외
            ]
        });
    });
</script>


{% endblock %}
