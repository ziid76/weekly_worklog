<!-- Related Contracts Selector Modal -->
<div id="relatedContractsModal" class="hidden relative z-50" aria-labelledby="relatedContractsModalLabel" role="dialog" aria-modal="true" data-contract-id="{{ contract.id }}">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity" onclick="closeRelatedContractsModal()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-md bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-5xl border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                    <h3 class="text-lg font-bold text-slate-900" id="relatedContractsModalLabel">연관 계약 선택</h3>
                    <button type="button" class="text-slate-400 hover:text-slate-500 transition-colors" onclick="closeRelatedContractsModal()">
                        <span class="material-symbols-outlined text-[24px]">close</span>
                    </button>
                </div>
                
                <div class="p-6">
                    <!-- Search Input -->
                    <div class="mb-6">
                        <div class="relative group">
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">search</span>
                            <input type="text" id="contractSearchInput" 
                                   class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3 pl-12 pr-4 text-sm text-slate-900 focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-slate-400 outline-none transition-all shadow-sm" 
                                   placeholder="계약명, 업체명, 시스템명 검색...">
                        </div>
                    </div>

                    <!-- Contracts Table -->
                    <div class="bg-white rounded-md border border-slate-200 overflow-hidden shadow-sm min-h-[300px]">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-slate-500 text-sm uppercase font-bold tracking-wider border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 text-center">선택</th>
                                        <th class="px-6 py-3">계약명</th>
                                        <th class="px-6 py-3">계약업체</th>
                                        <th class="px-6 py-3">관련 시스템</th>
                                        <th class="px-6 py-3 text-center">계약기간</th>
                                    </tr>
                                </thead>
                                <tbody id="contractSearchResults" class="divide-y divide-slate-100 text-sm text-slate-700">
                                    <tr>
                                        <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                                            <div class="flex flex-col items-center gap-2">
                                                <span class="material-symbols-outlined animate-spin text-primary">loading</span>
                                                <p>검색하려면 키워드를 입력하거나 '검색'을 시작하세요.</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        let selectedContracts = [];
        const modal = document.getElementById('relatedContractsModal');
        // contractId might be empty if we are in create mode, but this modal is only included in edit mode per contract_form.html logic
        const contractId = modal.dataset.contractId;
        const searchInput = document.getElementById('contractSearchInput');
        const searchResults = document.getElementById('contractSearchResults');

        // Open Modal Function
        window.openRelatedContractsModal = function() {
            if (!contractId) {
                alert('계약 정보가 없습니다.');
                return;
            }
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            searchInput.value = '';
            loadContracts();
        };

        // Close Modal Function
        window.closeRelatedContractsModal = function() {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        };

        let searchTimeout;
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function () {
                loadContracts();
            }, 300);
        });

        function loadContracts() {
            const searchQuery = searchInput.value.trim();
            searchResults.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400"><div class="flex flex-col items-center gap-2"><span class="material-symbols-outlined animate-spin text-primary">loading</span><p>데이터를 가져오는 중...</p></div></td></tr>`;
            
            const url = `/assets/contracts/${contractId}/search-related/?q=${encodeURIComponent(searchQuery)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    renderContracts(data.contracts);
                })
                .catch(error => {
                    searchResults.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-red-500">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
                });
        }

        function renderContracts(contracts) {
            if (contracts.length === 0) {
                searchResults.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 font-medium">검색 결과가 없습니다.</td></tr>';
                return;
            }

            searchResults.innerHTML = contracts.map(contract => `
                <tr class="hover:bg-slate-50 transition-colors group cursor-pointer" onclick="selectContractFromRow('${contract.id}', '${contract.name.replace(/'/g, "\\'")}', '${contract.contractor.replace(/'/g, "\\'")}')">
                    <td class="px-6 py-4 text-center">
                        <button type="button" class="p-2 text-slate-300 group-hover:text-primary transition-all">
                            <span class="material-symbols-outlined">add_circle</span>
                        </button>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-900">${contract.name}</td>
                    <td class="px-6 py-4 text-slate-600">${contract.contractor}</td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${(contract.system_names || '').split(',').map(s => s.trim() ? `<span class="px-2 py-0.5 rounded bg-slate-100 text-[10px] font-medium text-slate-500">${s.trim()}</span>` : '').join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center text-slate-500 font-mono text-xs">${contract.start_date} ~ ${contract.end_date}</td>
                </tr>
            `).join('');
        }

        window.selectContractFromRow = function(id, name, contractor) {
            selectContract({ id, name, contractor });
        };

        function selectContract(contractData) {
            if (selectedContracts.find(c => c.id === contractData.id)) {
                alert('이미 선택된 계약입니다.');
                return;
            }

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/assets/contracts/${contractId}/add-related/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `related_id=${contractData.id}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    selectedContracts.push(contractData);
                    updateSelectedContractsDisplay();
                    closeRelatedContractsModal();
                } else {
                    alert(data.error || '계약 추가 중 오류가 발생했습니다.');
                }
            });
        }

        function updateSelectedContractsDisplay() {
            const displayContainer = document.getElementById('selectedContractsDisplay');
            if (displayContainer) {
                if (selectedContracts.length > 0) {
                    displayContainer.innerHTML = selectedContracts.map((c, index) => `
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-orange-500 text-white text-xs font-bold shadow-sm group">
                            <span>${c.name} (${c.contractor})</span>
                            <button type="button" onclick="removeRelatedContract('${c.id}', ${index})" class="text-white/50 hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-sm text-white">close</span>
                            </button>
                        </div>
                    `).join('');
                } else {
                    displayContainer.innerHTML = '<p class="text-[10px] text-orange-400 font-bold uppercase tracking-wider">연관 계약이 선택되지 않았습니다.</p>';
                }
            }
        }

        window.removeRelatedContract = function (relatedId, index) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/assets/contracts/${contractId}/remove-related/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `related_id=${relatedId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    selectedContracts.splice(index, 1);
                    updateSelectedContractsDisplay();
                } else {
                    alert(data.error || '계약 제거 중 오류가 발생했습니다.');
                }
            });
        };

        window.initializeRelatedContracts = function (initialContracts) {
            selectedContracts = initialContracts || [];
            updateSelectedContractsDisplay();
        };
    })();
</script>
