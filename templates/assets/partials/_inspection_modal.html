<!-- Inspection Registration Modal -->
<div id="inspectionModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeInspectionModal()"></div>

    <!-- Modal Panel -->
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-md bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-100">
                
                <!-- Header -->
                <div class="border-b border-slate-100 bg-slate-50/50 px-8 py-6 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-slate-900 tracking-tight" id="modal-title">
                        정기 점검결과 등록
                    </h3>
                    <button type="button" class="text-slate-400 hover:text-slate-500 transition-colors" onclick="closeInspectionModal()">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Form -->
                <form id="inspectionForm" class="inspection-form" method="post" enctype="multipart/form-data" action="{% url 'assets:inspection_create' %}">
                    {% csrf_token %}
                    <div class="p-8 space-y-6">
                        {# Render hidden fields #}
                        {% for field in inspection_form %}
                            {% if field.is_hidden %}
                                {{ field }}
                            {% endif %}
                        {% endfor %}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {# Context Field - Contract or System #}
                            {% if not inspection_form.contract.is_hidden %}
                            <div class="space-y-1.5">
                                <label class="text-sm font-bold text-slate-700">계약</label>
                                {{ inspection_form.contract }}
                            </div>
                            {% endif %}

                            {% if not inspection_form.system.is_hidden %}
                            <div class="space-y-1.5">
                                <label class="text-sm font-bold text-slate-700">시스템</label>
                                {{ inspection_form.system }}
                            </div>
                            {% endif %}

                            <div class="space-y-1.5">
                                <label class="text-sm font-bold text-slate-700">점검월</label>
                                {{ inspection_form.inspection_month }}
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-sm font-bold text-slate-700">점검일자</label>
                                {{ inspection_form.inspection_date }}
                            </div>

                            {# Result - Full width #}
                            <div class="md:col-span-2 space-y-1.5">
                                <label class="text-sm font-bold text-slate-700">점검결과</label>
                                {{ inspection_form.result }}
                            </div>

                            {# Attachments #}
                            <div class="md:col-span-2 space-y-3 pt-6 border-t border-slate-100">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-bold text-slate-700">첨부파일</label>
                                    <button type="button" id="addInspectionFileBtn" 
                                            class="flex items-center gap-2 px-3 py-1.5 rounded-md bg-slate-50 border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all">
                                        <span class="material-symbols-outlined text-[16px]">add</span>
                                        파일 추가
                                    </button>
                                </div>
                                <input type="file" id="inspectionFileInput" name="attachments" class="hidden" multiple>
                                <div id="inspectionFileList" class="flex flex-wrap gap-2">
                                    <!-- Selected files will appear here -->
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">PDF, Word, Excel, 이미지 등 파일을 여러 개 선택할 수 있습니다.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="border-t border-slate-100 bg-slate-50/50 px-8 py-5 flex justify-end gap-3">
                        <button type="button" class="px-6 py-2.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50 font-bold transition-all text-sm" onclick="closeInspectionModal()">취소</button>
                        <button type="submit" id="inspectionSubmitBtn" class="px-8 py-2.5 rounded-full bg-primary text-white hover:bg-primary/90 font-bold shadow-lg shadow-primary/20 transition-all text-sm">
                            저장하기
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedInspectionFiles = [];

    function openInspectionModal() {
        const modal = document.getElementById('inspectionModal');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        // Reset files when opening
        selectedInspectionFiles = [];
        renderInspectionFileList();
    }

    function closeInspectionModal() {
        const modal = document.getElementById('inspectionModal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    function renderInspectionFileList() {
        const fileListDisplay = document.getElementById('inspectionFileList');
        if (!fileListDisplay) return;
        
        fileListDisplay.innerHTML = selectedInspectionFiles.map((file, index) => `
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-md bg-slate-100 border border-slate-200 text-xs font-bold text-slate-600">
                <span class="max-w-[150px] truncate text-[11px]">${file.name}</span>
                <button type="button" class="remove-inspection-file text-slate-400 hover:text-rose-500 transition-colors" data-index="${index}">
                    <span class="material-symbols-outlined text-[16px]">close</span>
                </button>
            </div>
        `).join('');

        document.querySelectorAll('.remove-inspection-file').forEach(btn => {
            btn.onclick = function(e) {
                const idx = parseInt(this.dataset.index);
                selectedInspectionFiles.splice(idx, 1);
                renderInspectionFileList();
            };
        });
    }

    // Set max date/month and initialize file handling
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const maxDate = today.toISOString().split('T')[0]; // YYYY-MM-DD
        const maxMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
        
        // Set max for inspection_date
        const dateInput = document.querySelector('#id_inspection_date');
        if (dateInput) {
            dateInput.setAttribute('max', maxDate);
            if (!dateInput.value) dateInput.value = maxDate;
        }
        
        // Set max for inspection_month
        const monthInput = document.querySelector('#id_inspection_month');
        if (monthInput) {
            monthInput.setAttribute('max', maxMonth);
            if (!monthInput.value) monthInput.value = maxMonth;
        }

        // File handling
        const fileInput = document.getElementById('inspectionFileInput');
        const addFileBtn = document.getElementById('addInspectionFileBtn');
        const form = document.getElementById('inspectionForm');

        if (addFileBtn && fileInput) {
            addFileBtn.addEventListener('click', () => fileInput.click());
        }

        if (fileInput) {
            fileInput.addEventListener('change', () => {
                const files = Array.from(fileInput.files);
                files.forEach(file => {
                    if (selectedInspectionFiles.some(f => f.name === file.name && f.size === file.size)) {
                        return; // Skip duplicates
                    }
                    selectedInspectionFiles.push(file);
                });
                renderInspectionFileList();
                fileInput.value = ''; // Reset input to allow re-selection of same file
            });
        }

        // Handle Form Submission (AJAX)
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('inspectionSubmitBtn');
                const originalBtnContent = submitBtn ? submitBtn.innerHTML : '';
                
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">refresh</span> 저장 중...';
                }

                const formData = new FormData(this);
                // Append multiple files
                selectedInspectionFiles.forEach(file => {
                    formData.append('attachments', file);
                });

                // Submit via AJAX
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                    success: function(response) {
                        if (response.success) {
                            // Determine which tab to reactivate
                            if (window.location.href.includes('contract')) {
                                localStorage.setItem('activeContractTab', 'inspection');
                            } else if (window.location.href.includes('system')) {
                                localStorage.setItem('activeSystemTab', 'inspection');
                            }
                            location.reload();
                        } else {
                            alert('오류가 발생했습니다: ' + (response.error || '알 수 없는 오류'));
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnContent;
                            }
                        }
                    },
                    error: function() {
                        alert('서버와 통신 중 오류가 발생했습니다.');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnContent;
                        }
                    }
                });
            });
        }
        
        // Close on escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeInspectionModal();
            }
        });
    });
</script>
