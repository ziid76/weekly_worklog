<!-- 변경 이력 섹션 -->
<div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden mb-6">
    <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-200 flex items-center justify-between">
        <h2 class="text-sm font-bold text-slate-900 flex items-center gap-2">
            <span class="material-symbols-outlined text-slate-400 text-[20px]">history</span>
            변경 이력
        </h2>
    </div>

    <div class="p-6 space-y-6">


        <!-- 이력 테이블 -->
        <div class="overflow-x-auto rounded-md border border-slate-100 mb-4">
            <table id="historyTable" class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50/50 text-slate-500 text-[10px] uppercase font-bold tracking-wider border-b border-slate-100">
                        <th class="px-4 py-3 text-center">유형</th>
                        <th class="px-4 py-3">변경 내용</th>
                        <th class="px-4 py-3 text-center">작성자 / 일시</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 text-sm">
                    {% for history in histories %}
                    <tr class="hover:bg-slate-50/30 transition-colors">
                        <td class="px-4 py-4 text-center align-top">
                            {% if history.action == 'CREATE' %}
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-50 text-green-600 border border-green-100 uppercase tracking-tight">{{ history.get_action_display }}</span>
                            {% elif history.action == 'UPDATE' %}
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100 uppercase tracking-tight">{{ history.get_action_display }}</span>
                            {% elif 'ADD' in history.action %}
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-indigo-50 text-indigo-600 border border-indigo-100 uppercase tracking-tight">{{ history.get_action_display }}</span>
                            {% elif 'REMOVE' in history.action %}
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-50 text-red-600 border border-red-100 uppercase tracking-tight">{{ history.get_action_display }}</span>
                            {% elif history.action == 'USER_COMMENT' %}
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-orange-50 text-orange-600 border border-orange-100 uppercase tracking-tight">{{ history.get_action_display }}</span>
                            {% elif history.action == 'REGULAR_INSPECTION' %}
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-purple-50 text-purple-600 border border-purple-100 uppercase tracking-tight">{{ history.get_action_display }}</span>
                            {% else %}
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200 uppercase tracking-tight">{{ history.get_action_display }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4 align-top">
                            {% if history.comment %}
                            <div class="font-bold text-slate-800 mb-2 leading-relaxed">{{ history.comment }}</div>
                            {% endif %}

                            {% if history.changed_fields %}
                            <div class="bg-slate-50/50 rounded-xl border border-slate-100 p-3 space-y-2">
                                {% for field, changes in history.changed_fields.items %}
                                <div class="flex items-center flex-wrap gap-2 text-xs">
                                    <span class="font-bold text-slate-500 min-w-[60px]">{{ field }}</span>
                                    <span class="px-1.5 py-0.5 rounded bg-red-50 text-red-400 line-through">{{ changes.old|default:"(없음)" }}</span>
                                    <span class="material-symbols-outlined text-slate-300 text-[14px]">arrow_forward</span>
                                    <span class="px-1.5 py-0.5 rounded bg-green-50 text-green-600 font-bold">{{ changes.new|default:"(없음)" }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if history.related_contract or history.related_hardware or history.related_software %}
                            <div class="mt-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-[16px] text-slate-400">link</span>
                                {% if history.related_contract %}
                                <a href="{% url 'assets:contract_detail' history.related_contract.pk %}" class="text-xs font-bold text-primary hover:underline">{{ history.related_contract.name }} (계약)</a>
                                {% elif history.related_hardware %}
                                <a href="{% url 'assets:hardware_detail' history.related_hardware.pk %}" class="text-xs font-bold text-primary hover:underline">{{ history.related_hardware.name }} (HW)</a>
                                {% elif history.related_software %}
                                <a href="{% url 'assets:software_detail' history.related_software.pk %}" class="text-xs font-bold text-primary hover:underline">{{ history.related_software.name }} (SW)</a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4 text-center align-top whitespace-nowrap">
                            <div class="flex flex-col gap-0.5">
                                <span class="font-bold text-slate-700">{{ history.user.profile.display_name|default:history.user.username|default:"시스템" }}</span>
                                <span class="text-[10px] text-slate-400 font-medium whitespace-nowrap" data-order="{{ history.created_at|date:'U' }}">{{ history.created_at|date:"Y-m-d H:i" }}</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <style>
            #historyTable_wrapper .dataTables_length select {
                @apply bg-slate-50 border-slate-200 rounded-lg text-xs font-bold text-slate-600 focus:ring-0 focus:border-primary px-3 py-1 mr-2;
            }
            #historyTable_wrapper .dataTables_filter input {
                @apply bg-slate-50 border-slate-200 rounded-lg text-xs font-bold text-slate-600 focus:ring-0 focus:border-primary px-4 py-1.5 ml-2 w-48 transition-all h-8;
            }
            #historyTable_wrapper .dataTables_info {
                @apply text-[11px] font-bold text-slate-400 mt-4;
            }
            #historyTable_wrapper .dataTables_paginate {
                @apply mt-4 flex items-center gap-1;
            }
            #historyTable_wrapper .dataTables_paginate .paginate_button {
                @apply px-3 py-1.5 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 cursor-pointer transition-all bg-white !important;
            }
            #historyTable_wrapper .dataTables_paginate .paginate_button.current {
                @apply bg-primary text-white border-primary hover:bg-primary/90 !important;
            }
            #historyTable_wrapper .dataTables_paginate .paginate_button.disabled {
                @apply opacity-50 cursor-not-allowed !important;
            }
            /* Hidden by default empty message when using DataTables */
            .dataTables_empty {
                @apply py-12 text-center text-slate-400 font-medium !important;
            }
            /* Adjust table header sorting icons */
            #historyTable thead th.sorting::after, #historyTable thead th.sorting::before,
            #historyTable thead th.sorting_asc::after, #historyTable thead th.sorting_asc::before,
            #historyTable thead th.sorting_desc::after, #historyTable thead th.sorting_desc::before {
                @apply opacity-20 scale-75;
            }
        </style>

        <script>
            $(document).ready(function() {
                if ($.fn.DataTable.isDataTable('#historyTable')) {
                    $('#historyTable').DataTable().destroy();
                }
                
                $('#historyTable').DataTable({
                    language: {
                        search: "",
                        searchPlaceholder: "이력 검색...",
                        lengthMenu: "_MENU_",
                        info: "총 _TOTAL_개의 이력 중 _START_-_END_ 표시",
                        infoEmpty: "이력이 없습니다.",
                        infoFiltered: "(전체 _MAX_개 중 필터링됨)",
                        paginate: {
                            first: "처음",
                            last: "마지막",
                            next: '<span class="material-symbols-outlined text-sm">chevron_right</span>',
                            previous: '<span class="material-symbols-outlined text-sm">chevron_left</span>'
                        },
                        zeroRecords: "검색 결과가 없습니다."
                    },
                    pageLength: 5,
                    lengthMenu: [5, 10, 20, 50],
                    order: [[2, 'desc']], // Sort by date column descending
                    columnDefs: [
                        { orderable: false, targets: [1] } // Disable sorting on 'Content' column
                    ],
                    dom: '<"flex items-center justify-between mb-4"lf>t<"flex items-center justify-between"ip>',
                });
            });
        </script>
        <!-- 코멘트 추가 폼 -->
        <form id="historyForm" class="relative group">
            {% csrf_token %}
            <textarea name="comment" rows="3" 
                      class="w-full bg-slate-50 border border-slate-200 rounded-md py-4 pl-4 pr-16 text-sm text-slate-900 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder:text-slate-400 resize-none shadow-inner" 
                      placeholder="변경 사항이나 메모를 입력하세요..." required></textarea>
            <button type="submit" class="absolute right-3 bottom-3 p-2 rounded-xl bg-primary text-white hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 flex items-center justify-center">
                <span class="material-symbols-outlined">send</span>
            </button>
        </form>
    </div>
</div>
