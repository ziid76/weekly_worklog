{% extends 'basic.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* Force styling on Django widgets */
    #contractForm input[type="text"], 
    #contractForm input[type="date"], 
    #contractForm input[type="number"], 
    #contractForm select, 
    #contractForm textarea {
        width: 100%;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem; /* rounded-xl */
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #0f172a;
        transition: all 0.2s;
        outline: none;
    }
    #contractForm input[type="text"]:focus, 
    #contractForm input[type="date"]:focus, 
    #contractForm input[type="number"]:focus, 
    #contractForm select:focus, 
    #contractForm textarea:focus {
        border-color: #3b82f6; /* primary */
        box-shadow: 0 0 0 1px #3b82f6;
    }
    #contractForm textarea {
        min-height: 120px;
    }
</style>
{% endblock %}

{% block page_name %}계약 {% if form.instance.pk %}수정{% else %}등록{% endif %}{% endblock %}



{% block content %}
<div class="flex flex-col gap-6">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">계약 {% if form.instance.pk %}수정{% else %}등록{% endif %}</h1>
            <p class="text-slate-500">계약의 상세 정보를 입력하고 연관 시스템 및 문서를 관리합니다.</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'assets:contract_list' %}" class="px-6 py-2.5 rounded-2xl border border-slate-200 text-slate-600 hover:bg-slate-50 font-bold transition-all text-sm">
                취소
            </a>
            <button type="submit" form="contractForm" class="px-8 py-2.5 rounded-2xl bg-primary text-white font-bold text-sm hover:bg-[#0062a3] transition-all shadow-xl shadow-primary/25 flex items-center justify-center gap-2 transform hover:-translate-y-0.5 active:translate-y-0">
                <span class="material-symbols-outlined text-[18px]">save</span>
                {% if form.instance.pk %}수정사항 저장{% else %}계약 등록{% endif %}
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-200 flex items-center gap-2">
            <span class="material-symbols-outlined text-slate-400">description</span>
            <h3 class="font-bold text-slate-900 text-sm">계약 정보 입력</h3>
        </div>

        <form method="post" enctype="multipart/form-data" id="contractForm" class="p-8 space-y-8">
            {% csrf_token %}

            {% if form.errors %}
            <div class="p-4 mb-6 rounded-2xl bg-red-50 border border-red-100 flex items-start gap-3">
                <span class="material-symbols-outlined text-red-500 mt-0.5">error</span>
                <div class="flex flex-col gap-1">
                    <h4 class="text-sm font-bold text-red-700">입력 정보를 확인해 주세요</h4>
                    <ul class="text-xs text-red-600 font-medium list-disc list-inside">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <div class="space-y-1.5">
                <label for="{{ form.name.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">계약명</label>
                <div class="relative">
                    {{ form.name }}
                    {% if form.name.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.name.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-1.5">
                    <label for="{{ form.contract_type.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">계약유형</label>
                    <div class="relative">
                        {{ form.contract_type }}
                        {% if form.contract_type.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.contract_type.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label for="{{ form.contractor.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">계약업체</label>
                    <div class="relative">
                        {{ form.contractor }}
                        {% if form.contractor.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.contractor.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="space-y-1.5">
                <label for="{{ form.manager.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">담당자</label>
                <div class="relative">
                    {{ form.manager }}
                    {% if form.manager.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.manager.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-1.5">
                    <label for="{{ form.start_date.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">계약시작일</label>
                    <div class="relative">
                        {{ form.start_date }}
                        {% if form.start_date.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.start_date.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label for="{{ form.end_date.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">계약종료일</label>
                    <div class="relative">
                        {{ form.end_date }}
                        {% if form.end_date.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.end_date.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="space-y-1.5">
                <label for="{{ form.amount.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">계약금액</label>
                <div class="relative">
                    {{ form.amount }}
                    {% if form.amount.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.amount.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="space-y-1.5">
                <label for="{{ form.content.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">계약내용</label>
                <div class="relative">
                    {{ form.content }}
                    {% if form.content.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.content.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- 정기점검 설정 Section -->
            <div class="space-y-6 pt-6 border-t border-slate-100">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        {{ form.is_regular_inspection }}
                        <label for="{{ form.is_regular_inspection.id_for_label }}" class="text-sm font-bold text-slate-700 cursor-pointer">정기점검 대상 여부</label>
                    </div>
                </div>

                <div id="inspectionScheduleSection" class="{% if not form.is_regular_inspection.value %}hidden{% endif %} space-y-4 p-6 bg-slate-50 rounded-2xl border border-slate-100">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">정기점검 스케줄 (월 선택)</label>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-12 gap-3">
                        {% for choice in form.inspection_schedule_months %}
                        <label class="flex flex-col items-center gap-2 p-3 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-primary transition-all group has-[:checked]:border-primary has-[:checked]:bg-primary/5">
                            {{ choice.tag }}
                            <span class="text-xs font-bold text-slate-600 group-hover:text-primary">{{ choice.choice_label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    {{ form.inspection_schedule }}
                </div>
            </div>

            <!-- 첨부파일 Section -->
            <div class="space-y-4 pt-4 border-t border-slate-100">
                <div class="flex items-center justify-between">
                    <h6 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        첨부파일
                    </h6>
                    <button type="button" id="addFileBtn" 
                            class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all">
                        <span class="material-symbols-outlined text-[16px]">add</span>
                        파일 추가
                    </button>
                </div>
                {% if form.instance.pk %}
                <div class="space-y-2">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">기존 첨부파일</p>
                    {% if form.instance.attachments.exists %}
                    <div id="existingFileList" class="space-y-2">
                        {% for attachment in form.instance.attachments.all %}
                        <div class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-100 bg-slate-50" data-attachment-card>
                            <a href="{{ attachment.file.url }}" target="_blank" class="flex items-center gap-2 min-w-0 text-slate-700 hover:text-primary">
                                <span class="material-symbols-outlined text-[16px]">description</span>
                                <span class="text-xs font-medium truncate">{{ attachment.filename }}</span>
                            </a>
                            <button type="button"
                                    class="delete-attachment inline-flex items-center gap-1 px-2.5 py-1 rounded-lg border border-rose-200 text-rose-500 hover:bg-rose-50 text-xs font-bold"
                                    data-delete-url="{% url 'assets:contract_attachment_delete' form.instance.pk attachment.pk %}"
                                    data-filename="{{ attachment.filename }}">
                                <span class="material-symbols-outlined text-[14px]">delete</span>
                                삭제
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p id="noExistingAttachments" class="text-xs text-slate-400">기존 첨부파일이 없습니다.</p>
                    {% endif %}
                </div>
                {% endif %}
                <input type="file" id="fileInput" name="attachments" class="hidden">
                <div id="fileList" class="flex flex-wrap gap-2">
                    <!-- Dynamically added tags -->
                </div>
            </div>
            <!-- Related Systems -->
            <div class="space-y-4 pt-6 border-t border-slate-100">
                <div class="flex justify-between items-center">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">관련 시스템</label>
                        <p class="text-xs text-slate-400 font-medium">이 계약이 적용되는 시스템을 선택하세요.</p>
                    </div>
                    <button type="button" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition-all font-bold text-xs shadow-sm" 
                            onclick="openSystemSelectorModal()">
                        <span class="material-symbols-outlined text-sm text-white">add</span>
                        시스템 추가
                    </button>
                    <select id="id_systems" name="systems" multiple class="hidden">
                        {% if form.instance.pk %}
                        {% for system in form.instance.systems.all %}
                        <option value="{{ system.id }}" selected>{{ system.name }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div id="selectedSystemsDisplay" class="flex flex-wrap gap-2 min-h-[48px] p-4 rounded-xl bg-slate-50 border border-slate-100 border-dashed">
                    <!-- Dynamic -->
                </div>
                {% if form.systems.errors %}
                <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                    <span class="material-symbols-outlined text-[14px]">error</span>
                    {{ form.systems.errors.0 }}
                </p>
                {% endif %}
            </div>

            {% if form.instance.pk %}
            <!-- Related Contracts -->
            <div class="space-y-4 pt-6 border-t border-slate-100">
                <div class="flex justify-between items-center">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">연관 계약</label>
                        <p class="text-xs text-slate-400 font-medium">이 계약과 관련된 다른 계약을 연결하세요.</p>
                    </div>
                    <button type="button" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 transition-all font-bold text-xs shadow-sm" 
                            onclick="openRelatedContractsModal()">
                        <span class="material-symbols-outlined text-sm">link</span>
                        계약 선택
                    </button>
                </div>
                <div id="selectedContractsDisplay" class="flex flex-wrap gap-2 min-h-[48px] p-4 rounded-xl bg-slate-50 border border-slate-100 border-dashed">
                    <!-- Dynamic -->
                </div>
            </div>
            {% endif %}

        </form>
    </div>
</div>


<!-- Include System Selector Modal -->
{% include 'assets/partials/system_selector_modal.html' with multi_select=True contract=form.instance %}

<!-- Include Related Contracts Modal (only in edit mode) -->
{% if form.instance.pk %}
{% include 'assets/partials/related_contracts_modal.html' with contract=form.instance %}
{% endif %}



{% endblock %}

{% block extra_js %}

<script id="systems-data" type="application/json">
[
    {% if form.instance.pk %}
    {% for system in form.instance.systems.all %}
    {
        "id": "{{ system.id }}",
        "name": "{{ system.name }}",
        "code": "{{ system.code }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
    {% endif %}
]
</script>

{% if form.instance.pk %}
<script id="related-contracts-data" type="application/json">
[
    {% for related in form.instance.related_contracts.all %}
    {
        "id": "{{ related.id }}",
        "name": "{{ related.name }}",
        "contractor": "{{ related.contractor }}",
        "system_names": "{% for sys in related.systems.all %}{{ sys.name }}{% if not forloop.last %}, {% endif %}{% endfor %}",
        "start_date": "{{ related.start_date|date:"Y-m-d" }}",
        "end_date": "{{ related.end_date|date:"Y-m-d" }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>
<script id="contract-metadata" type="application/json">
{
    "id": "{{ form.instance.pk }}"
}
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Selectors
        const systemsDataElement = document.getElementById('systems-data');
        if (systemsDataElement && typeof initializeSystemSelector === 'function') {
            initializeSystemSelector(JSON.parse(systemsDataElement.textContent));
        }

        const relatedContractsDataElement = document.getElementById('related-contracts-data');
        if (relatedContractsDataElement && typeof initializeRelatedContracts === 'function') {
            initializeRelatedContracts(JSON.parse(relatedContractsDataElement.textContent));
        }

        // File Attachment Handling
        const fileInput = document.getElementById('fileInput');
        const fileListDisplay = document.getElementById('fileList');
        const addFileBtn = document.getElementById('addFileBtn');
        const form = document.getElementById('contractForm');
        let selectedFiles = [];

        if (addFileBtn && fileInput) {
            addFileBtn.addEventListener('click', () => fileInput.click());
        }

        // Toggle inspection schedule visibility
        const isRegularInspectionCheckbox = document.getElementById('{{ form.is_regular_inspection.id_for_label }}');
        const inspectionScheduleSection = document.getElementById('inspectionScheduleSection');
        if (isRegularInspectionCheckbox && inspectionScheduleSection) {
            isRegularInspectionCheckbox.addEventListener('change', () => {
                if (isRegularInspectionCheckbox.checked) {
                    inspectionScheduleSection.classList.remove('hidden');
                } else {
                    inspectionScheduleSection.classList.add('hidden');
                }
            });
        }

        if (fileInput) {
            fileInput.addEventListener('change', () => {
                const files = Array.from(fileInput.files);
                files.forEach(file => {
                    if (selectedFiles.some(f => f.name === file.name)) {
                        alert(`${file.name}은(는) 이미 추가되었습니다.`);
                        return;
                    }
                    selectedFiles.push(file);
                    renderFileList();
                });
                fileInput.value = '';
            });
        }

        function renderFileList() {
            if (!fileListDisplay) return;
            fileListDisplay.innerHTML = selectedFiles.map((file, index) => `
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 border border-slate-200 text-xs font-bold text-slate-600">
                    <span class="max-w-[150px] truncate text-[11px]">${file.name}</span>
                    <button type="button" class="remove-file text-slate-400 hover:text-rose-500 transition-colors" data-index="${index}">
                        <span class="material-symbols-outlined text-[16px]">close</span>
                    </button>
                </div>
            `).join('');

            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = e.currentTarget.dataset.index;
                    selectedFiles.splice(idx, 1);
                    renderFileList();
                });
            });
        }

        if (form) {
            form.addEventListener('submit', (e) => {
                // Client-side validation for Systems (Required)
                const systemsSelect = document.getElementById('id_systems');
                if (!systemsSelect || systemsSelect.selectedOptions.length === 0) {
                    e.preventDefault();
                    alert('계약과 관련된 시스템을 최소 하나 이상 선택해야 합니다.');
                    
                    // Focus or scroll to the systems section
                    document.getElementById('selectedSystemsDisplay').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                // Check if there are dynamically added files to include
                if (selectedFiles.length > 0) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    
                    selectedFiles.forEach(file => {
                        formData.append('attachments', file);
                    });

                    // Submit via Fetch
                    let submitBtn = form.querySelector('button[type="submit"]');
                    if (!submitBtn) {
                        submitBtn = document.querySelector(`button[type="submit"][form="${form.id}"]`);
                    }
                    const originalBtnContent = submitBtn ? submitBtn.innerHTML : '';
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">refresh</span> 저장 중...';
                    }

                    fetch(form.action || window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else if (response.ok) {
                            window.location.reload();
                        } else {
                            return response.text().then(text => {
                                document.documentElement.innerHTML = text;
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Save error:', error);
                        alert("저장 중 오류가 발생했습니다.");
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnContent;
                        }
                    });
                }
            });
        }

        const deleteButtons = document.querySelectorAll('.delete-attachment');
        if (deleteButtons.length > 0) {
            const existingList = document.getElementById('existingFileList');
            let emptyMessage = document.getElementById('noExistingAttachments');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

            deleteButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const deleteUrl = btn.dataset.deleteUrl;
                    const filename = btn.dataset.filename || '첨부파일';
                    if (!deleteUrl) return;
                    if (!confirm(`${filename} 파일을 삭제할까요?`)) return;

                    fetch(deleteUrl, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': csrfToken || ''
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success) {
                            const card = btn.closest('[data-attachment-card]');
                            if (card) card.remove();
                            if (existingList && existingList.children.length === 0) {
                                if (!emptyMessage) {
                                    emptyMessage = document.createElement('p');
                                    emptyMessage.id = 'noExistingAttachments';
                                    emptyMessage.className = 'text-xs text-slate-400';
                                    emptyMessage.textContent = '기존 첨부파일이 없습니다.';
                                    existingList.parentElement.appendChild(emptyMessage);
                                }
                            }
                        } else {
                            alert('첨부파일 삭제에 실패했습니다.');
                        }
                    })
                    .catch(() => {
                        alert('첨부파일 삭제 중 오류가 발생했습니다.');
                    });
                });
            });
        }
    });

</script>
{% endblock %}
