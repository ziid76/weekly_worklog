{% extends 'basic.html' %}
{% load humanize %}

{% block page_name %}시스템 상세{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">
    <!-- Breadcrumbs & Title -->
    <div class="flex flex-col gap-4">
        <div class="flex items-center gap-2 text-sm text-slate-500">
            <a href="{% url 'assets:system_list' %}" class="hover:text-primary transition-colors">시스템 관리</a>
            <span class="material-symbols-outlined text-xs">chevron_right</span>
            <span class="text-slate-900 font-medium">{{ system.name }}</span>
        </div>
        <div class="flex flex-wrap justify-between items-end gap-4">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight mb-2">{{ system.name }}</h1>
                <p class="text-slate-500">시스템 코드: <span class="font-mono text-slate-700">{{ system.code }}</span></p>
            </div>

        </div>
    </div>

    <!-- Custom Tabs -->
    <div class="border-b border-slate-200">
        <nav class="flex gap-8" aria-label="Tabs">
            <button onclick="switchTab('basic-info')" id="basic-info-tab-btn" class="border-primary text-primary py-4 px-1 border-b-2 font-bold text-sm transition-all focus:outline-none">
                기본 정보
            </button>
            <button onclick="switchTab('inspection')" id="inspection-tab-btn" class="border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 py-4 px-1 border-b-2 font-bold text-sm transition-all focus:outline-none">
                정기점검
            </button>
        </nav>
    </div>

    <!-- Tab Contents -->
    <div id="basic-info-content" class="tab-pane flex flex-col gap-8">
        <!-- Basic Info Card -->
        <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 flex justify-between items-center border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-bold text-slate-900">기본 정보</h3>
                <div class="flex gap-3">
                    <a href="{% url 'assets:system_edit' system.pk %}" class="flex items-center gap-2 px-6 py-2.5 rounded-full border border-slate-200 bg-white text-slate-900 hover:bg-slate-50 transition-all font-bold shadow-sm">
                        <span class="material-symbols-outlined text-[20px]">edit</span>
                        수정하기
                    </a>
            </div>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">시스템명</span>
                    <span class="text-slate-900 font-medium">{{ system.name }}</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">시스템구분</span>
                    <span class="text-slate-900 font-medium">{{ system.get_system_type_display }}</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">코드</span>
                    <span class="font-mono text-slate-900">{{ system.code }}</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">담당자</span>
                    <span class="text-slate-900">{{ system.manager.profile.display_name|default:system.manager.username }}</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">상태</span>
                    <div>
                        {% if system.status == 'OPER' %}
                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-green-50 text-green-600 border border-green-100">
                                <span class="size-1.5 rounded-full bg-green-500"></span> 운영중
                            </span>
                        {% elif system.status == 'DEV' %}
                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-blue-50 text-blue-600 border border-blue-100">
                                <span class="size-1.5 rounded-full bg-blue-500"></span> 개발중
                            </span>
                        {% elif system.status == 'SUSP' %}
                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-amber-50 text-amber-600 border border-amber-100">
                                <span class="size-1.5 rounded-full bg-amber-500"></span> 중단
                            </span>
                        {% else %}
                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-red-50 text-red-600 border border-red-100">
                                <span class="size-1.5 rounded-full bg-red-500"></span> 폐기
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-col gap-1 md:col-span-2">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">오픈일</span>
                    <span class="text-slate-900">{{ system.launch_date|default:"-" }}</span>
                </div>
                <div class="flex flex-col gap-1 md:col-span-2">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">설명</span>
                    <div class="text-slate-700 leading-relaxed">{{ system.description|linebreaks|default:"-" }}</div>
                </div>
            </div>
        </div>

        <!-- Attachments Card -->
        <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-bold text-slate-900">첨부파일</h3>
            </div>
            <div class="p-6">
                {% if attachments %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for attachment in attachments %}
                    <a href="{{ attachment.file.url }}" target="_blank"
                       class="flex items-center gap-3 p-4 rounded-xl border border-slate-100 hover:border-primary/30 hover:bg-blue-50/30 transition-all group">
                        <div class="p-2 rounded-lg bg-slate-100 text-slate-400 group-hover:bg-primary group-hover:text-white transition-all">
                            <span class="material-symbols-outlined">description</span>
                        </div>
                        <div class="flex flex-col overflow-hidden text-slate-900">
                            <span class="font-bold truncate">{{ attachment.filename }}</span>
                            <span class="text-[10px] text-slate-400">{{ attachment.uploaded_at|date:"Y-m-d" }} / {{ attachment.uploaded_by.profile.display_name|default:attachment.uploaded_by.username|default:"-" }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="py-8 text-center text-slate-400 flex flex-col items-center gap-2">
                    <span class="material-symbols-outlined text-4xl">inventory_2</span>
                    <p>첨부파일이 없습니다.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Contracts Section -->
        {% url 'assets:contract_create' as contract_create_url %}
        {% include 'assets/partials/_related_contracts.html' with contracts=system.contracts.all show_amount=True title_action_url=contract_create_url|add:"?system="|add:system.pk|stringformat:"s" %}

        <!-- Hardware Section -->
        {% url 'assets:hardware_create' as hardware_create_url %}
        {% include 'assets/partials/_related_hardwares.html' with hardwares=system.hardwares.all title_action_url=hardware_create_url|add:"?system="|add:system.pk|stringformat:"s" %}

        <!-- Software Section -->
        {% url 'assets:software_create' as software_create_url %}
        {% include 'assets/partials/_related_softwares.html' with softwares=system.softwares.all title_action_url=software_create_url|add:"?system="|add:system.pk|stringformat:"s" %}

        {% include 'assets/partials/_history_section.html' %}
    </div>
<!-- 정기점검 탭 -->
{% include 'assets/partials/_inspection_history.html' %}

</div>

<!-- Modal -->
{% include 'assets/partials/_inspection_modal.html' %}

<div class="mt-8 flex justify-start">
    <a href="{% url 'assets:system_list' %}" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-slate-900 transition-colors">
        <span class="material-symbols-outlined text-sm">arrow_back</span>
        목록으로 돌아가기
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function switchTab(tabId) {
        const activeClasses = ['border-primary', 'text-primary'];
        const inactiveClasses = ['border-transparent', 'text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300'];

        // Hide all tabs
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
        // Show active tab
        document.getElementById(tabId + '-content').classList.remove('hidden');
        
        // Update tab buttons style
        document.querySelectorAll('nav[aria-label="Tabs"] button').forEach(btn => {
            btn.classList.remove(...activeClasses);
            btn.classList.add(...inactiveClasses);
        });
        
        const activeBtn = document.getElementById(tabId + '-tab-btn');
        activeBtn.classList.remove(...inactiveClasses);
        activeBtn.classList.add(...activeClasses);
    }

    $(document).ready(function() {
        // Restore active tab if exists
        var activeTab = localStorage.getItem('activeSystemTab');
        if (activeTab) {
            if (activeTab.includes('inspection')) {
                switchTab('inspection');
            } else {
                switchTab('basic-info');
            }
            localStorage.removeItem('activeSystemTab');
        }

        // Handle History Form Submission (AJAX)
        $('#historyForm').submit(function(e) {
            e.preventDefault();
            const comment = $(this).find('textarea[name="comment"]').val().trim();
            if (!comment) return;
            
            $.ajax({
                url: '{% url "assets:system_history_add" system.pk %}',
                method: 'POST',
                data: {
                    comment: comment,
                    action: 'USER_COMMENT',
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) location.reload();
                    else alert(response.error || '이력 추가에 실패했습니다.');
                }
            });
        });

        // Inspection form submission is now handled in the modal itself
    });
</script>
{% endblock %}
