{% extends 'basic.html' %}
{% load static %}

{% block page_name %}시스템 {% if form.instance.pk %}수정{% else %}등록{% endif %}{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">시스템 {% if form.instance.pk %}수정{% else %}등록{% endif %}</h1>
            <p class="text-slate-500">시스템의 기본 정보를 입력하고 관리합니다.</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'assets:system_list' %}" class="px-6 py-2.5 rounded-2xl border border-slate-200 text-slate-600 hover:bg-slate-50 font-bold transition-all text-sm">
                취소
            </a>
            <button type="submit" form="systemForm" class="px-8 py-2.5 rounded-2xl bg-slate-900 text-white hover:bg-slate-800 font-bold shadow-sm transition-all text-sm flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">save</span>
                {% if form.instance.pk %}수정사항 저장{% else %}시스템 등록{% endif %}
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 bg-slate-50/50 border-b border-slate-200 flex items-center gap-2">
            <span class="material-symbols-outlined text-slate-400">dns</span>
            <h3 class="font-bold text-slate-900 text-sm">시스템 정보 입력</h3>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="systemForm" class="p-8 space-y-6">
            {% csrf_token %}

            <div class="space-y-1.5">
                <label for="{{ form.name.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">시스템명</label>
                <div class="relative">
                    {{ form.name }}
                    {% if form.name.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.name.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-1.5">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">시스템 구분</label>
                    <div class="flex items-center gap-6 p-1">
                        {% for radio in form.system_type %}
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <div class="relative flex items-center justify-center">
                                    {{ radio.tag }}
                                </div>
                                <span class="text-sm font-medium text-slate-700 group-hover:text-primary transition-colors">{{ radio.choice_label }}</span>
                            </label>
                        {% endfor %}
                    </div>
                    {% if form.system_type.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.system_type.errors.0 }}
                    </p>
                    {% endif %}
                </div>
                <div class="space-y-1.5">
                    <label for="{{ form.code.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">시스템코드 (자동채번)</label>
                    <div class="relative">
                        {{ form.code }}
                        {% if form.code.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.code.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-1.5">
                    <label for="{{ form.manager.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">담당자</label>
                    <div class="relative">
                        {{ form.manager }}
                        {% if form.manager.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.manager.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label for="{{ form.status.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">상태</label>
                    <div class="relative">
                        {{ form.status }}
                        {% if form.status.errors %}
                        <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">error</span>
                            {{ form.status.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="space-y-1.5">
                <label for="{{ form.launch_date.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">오픈일</label>
                <div class="relative">
                    {{ form.launch_date }}
                    {% if form.launch_date.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.launch_date.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="space-y-1.5">
                <label for="{{ form.description.id_for_label }}" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">설명</label>
                <div class="relative">
                    {{ form.description }}
                    {% if form.description.errors %}
                    <p class="mt-1 text-xs text-red-500 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">error</span>
                        {{ form.description.errors.0 }}
                    </p>
                    {% endif %}
                </div>
            </div>
            <!-- File Attachment Section -->
            <div class="space-y-4 pt-4 border-t border-slate-100">
                <div class="flex items-center justify-between">
                    <h6 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        첨부파일
                    </h6>
                    <button type="button" id="addFileBtn"
                            class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all">
                        <span class="material-symbols-outlined text-[16px]">add</span>
                        파일 추가
                    </button>
                </div>
                <input type="file" id="fileInput" name="attachments" class="hidden">
                <div id="fileList" class="flex flex-wrap gap-2">
                    <!-- Dynamically added tags -->
                </div>
                {% if form.instance.pk %}
                <div class="space-y-3 pt-2" id="existingAttachmentsSection">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">기존 첨부파일</p>
                    {% if form.instance.attachments.exists %}
                    <div id="existingFileList" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {% for attachment in form.instance.attachments.all %}
                        <div class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-100 bg-slate-50" data-attachment-card>
                            <a href="{{ attachment.file.url }}" target="_blank" class="flex items-center gap-2 overflow-hidden text-slate-700 hover:text-primary transition-colors">
                                <span class="material-symbols-outlined text-[18px] text-slate-400">description</span>
                                <span class="truncate text-xs font-bold">{{ attachment.filename }}</span>
                            </a>
                            <button type="button"
                                    class="delete-attachment text-slate-400 hover:text-rose-500 transition-colors"
                                    data-delete-url="{% url 'assets:system_attachment_delete' form.instance.pk attachment.pk %}"
                                    data-filename="{{ attachment.filename }}">
                                <span class="material-symbols-outlined text-[18px]">delete</span>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p id="noExistingAttachments" class="text-xs text-slate-400">기존 첨부파일이 없습니다.</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('fileInput');
        const fileListDisplay = document.getElementById('fileList');
        const addFileBtn = document.getElementById('addFileBtn');
        const form = document.getElementById('systemForm');
        let selectedFiles = [];

        if (addFileBtn && fileInput) {
            addFileBtn.addEventListener('click', () => fileInput.click());
        }

        if (fileInput) {
            fileInput.addEventListener('change', () => {
                const files = Array.from(fileInput.files);
                files.forEach(file => {
                    if (selectedFiles.some(f => f.name === file.name)) {
                        alert(`${file.name}은(는) 이미 추가되었습니다.`);
                        return;
                    }
                    selectedFiles.push(file);
                    renderFileList();
                });
                fileInput.value = '';
            });
        }

        function renderFileList() {
            if (!fileListDisplay) return;
            fileListDisplay.innerHTML = selectedFiles.map((file, index) => `
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 border border-slate-200 text-xs font-bold text-slate-600">
                    <span class="max-w-[150px] truncate text-[11px]">${file.name}</span>
                    <button type="button" class="remove-file text-slate-400 hover:text-rose-500 transition-colors" data-index="${index}">
                        <span class="material-symbols-outlined text-[16px]">close</span>
                    </button>
                </div>
            `).join('');

            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = Number(e.currentTarget.dataset.index);
                    selectedFiles.splice(idx, 1);
                    renderFileList();
                });
            });
        }

        if (form) {
            form.addEventListener('submit', (e) => {
                if (selectedFiles.length > 0) {
                    e.preventDefault();
                    const formData = new FormData(form);

                    selectedFiles.forEach(file => {
                        formData.append('attachments', file);
                    });

                    let submitBtn = form.querySelector('button[type="submit"]');
                    if (!submitBtn) {
                        submitBtn = document.querySelector(`button[type="submit"][form="${form.id}"]`);
                    }
                    const originalBtnContent = submitBtn ? submitBtn.innerHTML : '';
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">refresh</span> 저장 중..';
                    }

                    fetch(form.action || window.location.href, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else if (response.ok) {
                            window.location.reload();
                        } else {
                            return response.text().then(text => {
                                document.documentElement.innerHTML = text;
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Save error:', error);
                        alert("저장 중 오류가 발생했습니다.");
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnContent;
                        }
                    });
                }
            });
        }

        const deleteButtons = document.querySelectorAll('.delete-attachment');
        if (deleteButtons.length > 0) {
            const existingList = document.getElementById('existingFileList');
            let emptyMessage = document.getElementById('noExistingAttachments');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

            deleteButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const deleteUrl = btn.dataset.deleteUrl;
                    const filename = btn.dataset.filename || '첨부파일';
                    if (!deleteUrl) return;
                    if (!confirm(`${filename}을(를) 삭제할까요?`)) return;

                    fetch(deleteUrl, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': csrfToken || ''
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success) {
                            const card = btn.closest('[data-attachment-card]');
                            if (card) card.remove();
                            if (existingList && existingList.children.length === 0) {
                                if (!emptyMessage) {
                                    emptyMessage = document.createElement('p');
                                    emptyMessage.id = 'noExistingAttachments';
                                    emptyMessage.className = 'text-xs text-slate-400';
                                    emptyMessage.textContent = '기존 첨부파일이 없습니다.';
                                    existingList.parentElement.appendChild(emptyMessage);
                                }
                            }
                        } else {
                            alert('첨부파일 삭제에 실패했습니다.');
                        }
                    })
                    .catch(() => {
                        alert('첨부파일 삭제 중 오류가 발생했습니다.');
                    });
                });
            });
        }
    });
</script>

<style>
    /* Force styling on Django widgets */
    #systemForm input[type="text"], 
    #systemForm input[type="date"], 
    #systemForm select, 
    #systemForm textarea {
        width: 100%;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem; /* rounded-xl */
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #0f172a;
        transition: all 0.2s;
        outline: none;
    }
    #systemForm input[type="text"]:focus, 
    #systemForm input[type="date"]:focus, 
    #systemForm select:focus, 
    #systemForm textarea:focus {
        border-color: #3b82f6; /* primary */
        box-shadow: 0 0 0 1px #3b82f6;
    }
    #systemForm textarea {
        min-height: 120px;
    }

    /* Radio button custom styling */
    #systemForm input[type="radio"] {
        width: 1.2rem;
        height: 1.2rem;
        cursor: pointer;
        accent-color: #3b82f6; /* primary color */
    }
</style>
{% endblock %}
