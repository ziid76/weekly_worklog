{% extends 'basic.html' %}
{% load static %}

{% block page_name %}자산 토폴로지{% endblock %}

{% block content %}
<div class="flex flex-col gap-8 h-[calc(100vh-200px)]">
    <!-- Header with Legend -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex flex-col gap-1">
            <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">자산 토폴로지</h1>
            <p class="text-slate-500 font-medium text-sm">시스템, 계약, 하드웨어, 소프트웨어 간의 연결 구조를 시각화합니다.</p>
        </div>
        
        <div class="flex flex-wrap items-center gap-4 bg-white px-6 py-3 rounded-2xl border border-slate-200 shadow-sm">
            <form method="get" class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-3 pr-4 border-r border-slate-100">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" name="hide_unconnected" value="true" onchange="this.form.submit()" {% if hide_unconnected %}checked{% endif %} 
                               class="rounded border-slate-300 text-primary focus:ring-primary size-4">
                        <span class="text-xs font-bold text-slate-600 group-hover:text-primary transition-colors">연결 없는 시스템 숨기기</span>
                    </label>
                </div>

                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">시스템 상태:</span>
                    <div class="flex flex-wrap gap-2">
                        {% for code, label in status_choices %}
                        <label class="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" name="status" value="{{ code }}" onchange="this.form.submit()" 
                                   {% if code in current_statuses %}checked{% endif %}
                                   class="rounded border-slate-300 text-primary focus:ring-primary size-3.5">
                            <span class="text-xs font-bold {% if code in current_statuses %}text-primary{% else %}text-slate-500{% endif %} hover:text-primary transition-colors">{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                {% if request.GET.status or request.GET.hide_unconnected %}
                <div class="pl-4 border-l border-slate-100">
                    <a href="{% url 'assets:topology' %}" class="text-xs font-bold text-slate-400 hover:text-primary transition-colors">초기화</a>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Graph Container -->
    <div class="flex-1 bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden relative">
        <div id="cy" class="w-full h-full"></div>
        
        <!-- Controls -->
        <div class="absolute bottom-8 left-8 flex flex-col gap-2">
            <button id="fit-btn" class="size-10 rounded-xl bg-white border border-slate-200 shadow-lg flex items-center justify-center text-slate-600 hover:text-primary transition-all" title="화면 맞춤">
                <span class="material-symbols-outlined">fullscreen</span>
            </button>
            <button id="layout-btn" class="size-10 rounded-xl bg-white border border-slate-200 shadow-lg flex items-center justify-center text-slate-600 hover:text-primary transition-all" title="레이아웃 재정렬">
                <span class="material-symbols-outlined">account_tree</span>
            </button>
        </div>

        <!-- Detail Panel (Hidden by default) -->
        <div id="detail-panel" class="absolute top-8 right-8 w-80 bg-white/80 backdrop-blur-md rounded-3xl border border-slate-200 shadow-2xl p-6 translate-x-[120%] transition-transform duration-300 z-10">
            <div class="flex items-center justify-between mb-4">
                <span id="node-type-badge" class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter">TYPE</span>
                <button onclick="hidePanel()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined text-base">close</span>
                </button>
            </div>
            <h3 id="node-label" class="text-lg font-black text-slate-900 mb-2">Node Name</h3>
            <div id="node-info" class="space-y-3 text-sm text-slate-600 font-medium">
                <!-- Dynamic Content -->
            </div>
            <div class="mt-6 pt-6 border-t border-slate-200">
                <a id="detail-link" href="#" class="flex items-center justify-center gap-2 w-full py-2.5 rounded-xl bg-primary text-white font-bold text-sm hover:bg-primary/90 transition-all">
                    자세히 보기
                    <span class="material-symbols-outlined text-base">arrow_forward</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const nodes = {{ nodes_json|safe }};
        const edges = {{ edges_json|safe }};

        // Base64 encode SVGs to prevent 404 warnings from path data being interpreted as URLs
        const getB64Svg = (fill) => {
            const systemPath = 'M320-240v-160q0-33 23.5-56.5T400-480h160q33 0 56.5 23.5T640-400v160q0 33-23.5 56.5T560-160H400q-33 0-56.5-23.5T320-240Zm80 0h160v-160H400v160Zm-80-320v-160q0-33 23.5-56.5T400-800h160q33 0 56.5 23.5T640-720v160q0 33-23.5 56.5T560-480H400q-33 0-56.5-23.5T320-560Zm80 0h160v-160H400v160ZM160-320q-33 0-56.5-23.5T80-400v-160q0-33 23.5-56.5T160-640h80v320h-80Zm640 0h-80v-320h80q33 0 56.5 23.5T880-560v160q0 33-23.5 56.5T800-320ZM240-640h480v-160q0-33-23.5-56.5T640-880H320q-33 0-56.5 23.5T240-800v160Zm0 480v160q0 33 23.5 56.5T320-80h320q33 0 56.5-23.5T720-160v-160H240Z';
            const contractPath = 'M312-360h240v-80H312v80Zm0-160h336v-80H312v80Zm-72 360q-33 0-56.5-23.5T160-240v-480q0-33 23.5-56.5T240-800h320l240 240v320q0 33-23.5 56.5T720-160H240Zm304-480v-160H240v480h480v-320H544Z';
            const hwPath = 'M320-80v-80H160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H640v80h-80v-80H400v80h-80ZM160-240h640v-480H160v480Zm0 0v-480 480Z';
            const swPath = 'M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-160q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm0-80q33 0 56.5-23.5T560-480q0-33-23.5-56.5T480-560q-33 0-56.5 23.5T400-480q0 33 23.5 56.5T480-400Z';
            
            let path = '';
            if (fill === '#3b82f6') path = systemPath;
            if (fill === '#f59e0b') path = contractPath;
            if (fill === '#10b981') path = hwPath;
            if (fill === '#a855f7') path = swPath;

            const svg = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="${fill}"><path d="${path}"/></svg>`;
            return 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svg)));
        };

        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: { nodes, edges },
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'font-size': '12px',
                        'font-weight': 'bold',
                        'text-valign': 'bottom',
                        'text-margin-y': '8px',
                        'color': '#334155',
                        'background-color': '#fff',
                        'border-width': '3px',
                        'width': '50px',
                        'height': '50px',
                        'transition-property': 'background-color, border-color, border-width',
                        'transition-duration': '0.2s'
                    }
                },
                {
                    selector: 'node[type="system"]',
                    style: {
                        'border-color': '#3b82f6',
                        'background-image': getB64Svg('#3b82f6'),
                        'background-width': '60%',
                        'background-height': '60%'
                    }
                },
                {
                    selector: 'node[type="contract"]',
                    style: {
                        'border-color': '#f59e0b',
                        'background-image': getB64Svg('#f59e0b'),
                        'background-width': '60%',
                        'background-height': '60%'
                    }
                },
                {
                    selector: 'node[type="hardware"]',
                    style: {
                        'border-color': '#10b981',
                        'background-image': getB64Svg('#10b981'),
                        'background-width': '60%',
                        'background-height': '60%'
                    }
                },
                {
                    selector: 'node[type="software"]',
                    style: {
                        'border-color': '#a855f7',
                        'background-image': getB64Svg('#a855f7'),
                        'background-width': '60%',
                        'background-height': '60%'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#cbd5e1',
                        'target-arrow-color': '#cbd5e1',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'opacity': 0.6
                    }
                },
                {
                    selector: 'edge[type="related_contract"]',
                    style: {
                        'line-style': 'dashed',
                        'line-color': '#f59e0b',
                        'target-arrow-shape': 'none'
                    }
                },
                {
                    selector: ':selected',
                    style: {
                        'border-width': '6px',
                        'border-color': '#0077C8',
                        'opacity': 1
                    }
                }
            ],
            layout: {
                name: 'cose',
                animated: true,
                padding: 100,
                nodeRepulsion: 10000,
                idealEdgeLength: 150
            }
        });

        // Events
        cy.on('tap', 'node', (evt) => showPanel(evt.target.data()));
        cy.on('tap', (evt) => { if(evt.target === cy) hidePanel(); });

        // Controls
        document.getElementById('fit-btn').onclick = () => cy.fit();
        document.getElementById('layout-btn').onclick = () => {
            cy.layout({ name: 'cose', animated: true, padding: 100 }).run();
        };

        function showPanel(data) {
            const panel = document.getElementById('detail-panel');
            const badge = document.getElementById('node-type-badge');
            const label = document.getElementById('node-label');
            const info = document.getElementById('node-info');
            const link = document.getElementById('detail-link');

            label.innerText = data.label;
            const displayStatus = data.display_status || data.status;
            
            let typeLabel = '';
            let typeColor = '';
            let baseUrl = '';
            let statusLabel = '상태';

            switch(data.type) {
                case 'system':
                    typeLabel = '시스템';
                    typeColor = 'bg-blue-50 text-blue-600 border border-blue-100';
                    baseUrl = '{% url "assets:system_detail" 0 %}'.replace('0', data.id.split('_')[1]);
                    break;
                case 'contract':
                    typeLabel = '계약';
                    typeColor = 'bg-amber-50 text-amber-600 border border-amber-100';
                    baseUrl = '{% url "assets:contract_detail" 0 %}'.replace('0', data.id.split('_')[1]);
                    statusLabel = '유형';
                    break;
                case 'hardware':
                    typeLabel = '하드웨어';
                    typeColor = 'bg-emerald-50 text-emerald-600 border border-emerald-100';
                    baseUrl = '{% url "assets:hardware_detail" 0 %}'.replace('0', data.id.split('_')[1]);
                    break;
                case 'software':
                    typeLabel = '소프트웨어';
                    typeColor = 'bg-purple-50 text-purple-600 border border-purple-100';
                    baseUrl = '{% url "assets:software_detail" 0 %}'.replace('0', data.id.split('_')[1]);
                    break;
            }

            badge.innerText = typeLabel;
            badge.className = `px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter ${typeColor}`;
            info.innerHTML = `<p>${statusLabel}: ${displayStatus}</p>`;
            link.href = baseUrl;
            panel.classList.remove('translate-x-[120%]');
        }

        window.hidePanel = function() {
            document.getElementById('detail-panel').classList.add('translate-x-[120%]');
            cy.nodes().unselect();
        };
    });
</script>

<style>
    #cy {
        background-color: #f8fafc;
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 30px 30px;
    }
</style>
{% endblock %}
