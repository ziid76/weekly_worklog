{% extends 'basic.html' %}
{% load humanize %}

{% block page_name %}계약 상세{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">
    <!-- Breadcrumbs & Title -->
    <div class="flex flex-col gap-4">
        <div class="flex items-center gap-2 text-sm text-slate-500">
            <a href="{% url 'assets:contract_list' %}" class="hover:text-primary transition-colors">계약 관리</a>
            <span class="material-symbols-outlined text-xs">chevron_right</span>
            <span class="text-slate-900 font-medium">{{ contract.name }}</span>
        </div>
        <div class="flex flex-wrap justify-between items-end gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">{{ contract.name }}</h1>
                <p class="text-slate-500">계약업체: <span class="font-bold text-slate-700">{{ contract.contractor }}</span></p>
            </div>
        </div>
    </div>

    <!-- Custom Tabs -->
    <div class="border-b border-slate-200">
        <nav class="flex gap-8" aria-label="Tabs">
            <button onclick="switchTab('basic-info')" id="basic-info-tab-btn" class="border-primary text-primary py-4 px-1 border-b-2 font-bold text-sm transition-all focus:outline-none">
                기본 정보
            </button>
            <button onclick="switchTab('inspection')" id="inspection-tab-btn" class="border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 py-4 px-1 border-b-2 font-bold text-sm transition-all focus:outline-none">
                정기점검
            </button>
        </nav>
    </div>

    <!-- Tab Contents -->
    <div id="basic-info-content" class="tab-pane flex flex-col gap-8">
        <!-- Basic Info Card -->
        <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="font-bold text-slate-900">기본 정보</h3>
                <div class="flex gap-3">
                    <a href="{% url 'assets:contract_edit' contract.pk %}" class="flex items-center gap-2 px-6 py-2.5 rounded-full border border-slate-200 bg-white text-slate-900 hover:bg-slate-50 transition-all font-bold shadow-sm">
                        <span class="material-symbols-outlined text-[20px]">edit</span>
                        수정하기
                    </a>
                </div>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">계약명</span>
                    <span class="text-slate-900 font-medium">{{ contract.name }}</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">유형</span>
                    <span class="text-slate-900">{{ contract.get_contract_type_display }}</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">계약업체</span>
                    <span class="text-slate-900">{{ contract.contractor }}</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">계약금액</span>
                    <span class="text-slate-900 font-bold">{{ contract.amount|intcomma }}원</span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">담당자</span>
                    <span class="text-slate-900">{{ contract.manager.profile.display_name|default:contract.manager.username|default:"-" }}</span>
                </div>
                <div class="flex flex-col gap-1 md:col-span-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">계약기간</span>
                    <span class="text-slate-900 font-mono">{{ contract.start_date|date:"Y-m-d" }} ~ {{ contract.end_date|date:"Y-m-d" }}</span>
                </div>
                <div class="flex flex-col gap-1 md:col-span-2">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">계약내용</span>
                    <div class="text-slate-700 leading-relaxed">{{ contract.content|default:"작성된 내용이 없습니다." }}</div>
                </div>
                <div class="flex flex-col gap-2 md:col-span-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">정기점검 대상</span>
                    <div>
                        {% if contract.is_regular_inspection %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-50 border border-emerald-100 text-xs font-bold text-emerald-600">
                                <span class="material-symbols-outlined text-[14px] icon-filled">check_circle</span>
                                점검 대상
                            </span>
                        {% else %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-slate-50 border border-slate-100 text-xs font-bold text-slate-400">
                            <span class="material-symbols-outlined text-[14px]">cancel</span>
                            대상 아님
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% if contract.is_regular_inspection %}
                <div class="flex flex-col gap-3 md:col-span-2 pt-2">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">정기점검 스케줄</span>
                    <div class="flex flex-wrap gap-2">
                        {% for m in "123456789"|make_list %}{% with m_int=m|add:0 %}
                        <div class="size-9 rounded-xl flex items-center justify-center text-xs font-bold transition-all
                            {% if m_int in contract.inspection_schedule %}
                            bg-primary text-white shadow-lg shadow-primary/20
                            {% else %}
                            bg-slate-50 text-slate-300 border border-slate-100
                            {% endif %}">
                            {{ m }}월
                        </div>
                        {% endwith %}{% endfor %}
                        {% for m in "10,11,12"|stringformat:"s"|slice:":"|make_list %}{% with m_int=forloop.counter|add:9 %}
                        {% if forloop.counter <= 3 %}
                        <div class="size-9 rounded-xl flex items-center justify-center text-xs font-bold transition-all
                            {% if m_int in contract.inspection_schedule %}
                            bg-primary text-white shadow-lg shadow-primary/20
                            {% else %}
                            bg-slate-50 text-slate-300 border border-slate-100
                            {% endif %}">
                            {{ m_int }}월
                        </div>
                        {% endif %}
                        {% endwith %}{% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Attachments Card -->
{% if attachments %}
        <div class="bg-white rounded-md border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-bold text-slate-900">첨부파일</h3>
            </div>
            <div class="p-6">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for attachment in attachments %}
                    <a href="{{ attachment.file.url }}" target="_blank" 
                       class="flex items-center gap-3 p-4 rounded-xl border border-slate-100 hover:border-primary/30 hover:bg-blue-50/30 transition-all group">
                        <div class="p-2 rounded-lg bg-slate-100 text-slate-400 group-hover:bg-primary group-hover:text-white transition-all">
                            <span class="material-symbols-outlined">description</span>
                        </div>
                        <div class="flex flex-col overflow-hidden text-slate-900">
                            <span class="font-bold truncate">{{ attachment.filename }}</span>
                            <span class="text-[10px] text-slate-400">{{ attachment.uploaded_at|date:"Y-m-d" }} • {{ attachment.uploaded_by.profile.display_name }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
               
            </div>
        </div>
{% endif %}
        <!-- Related Systems Section -->
        {% include 'assets/partials/_related_systems.html' with systems=contract.systems.all %}

        <!-- Related Contracts Section -->
        {% include 'assets/partials/_related_contracts.html' with contracts=contract.related_contracts.all show_systems=True %}

        {% include 'assets/partials/_history_section.html' %}
    </div>



<!-- 정기점검 탭 -->
{% include 'assets/partials/_inspection_history.html' %}


</div>

<!-- Modal -->
{% include 'assets/partials/_inspection_modal.html' %}

<div class="mt-8 flex justify-start">
    <a href="{% url 'assets:contract_list' %}" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-slate-900 transition-colors">
        <span class="material-symbols-outlined text-sm">arrow_back</span>
        목록으로 돌아가기
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function switchTab(tabId) {
        const activeClasses = ['border-primary', 'text-primary'];
        const inactiveClasses = ['border-transparent', 'text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300'];

        document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabId + '-content').classList.remove('hidden');
        
        document.querySelectorAll('nav[aria-label="Tabs"] button').forEach(btn => {
            btn.classList.remove(...activeClasses);
            btn.classList.add(...inactiveClasses);
        });
        
        const activeBtn = document.getElementById(tabId + '-tab-btn');
        activeBtn.classList.remove(...inactiveClasses);
        activeBtn.classList.add(...activeClasses);
    }

    $(document).ready(function() {
        var activeTab = localStorage.getItem('activeContractTab');
        if (activeTab) {
            if (activeTab.includes('inspection')) switchTab('inspection');
            else switchTab('basic-info');
            localStorage.removeItem('activeContractTab');
        }

        // Inspection form submission is now handled in the modal itself
    });
</script>
{% endblock %}


