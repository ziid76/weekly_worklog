{% extends 'base.html' %}
{% load humanize %}

{% block page_name %}계약 상세{% endblock %}

{% block content %}


<!-- Bootstrap Nav Tabs -->
<ul class="nav nav-tabs" id="contractTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab" style="color: #333 !important;">
            기본 정보
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="inspection-tab" data-bs-toggle="tab" data-bs-target="#inspection" type="button" role="tab" style="color: #333 !important;">
            정기점검
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="contractTabsContent">
    <!-- Basic Info Tab -->
    <div class="tab-pane fade show active" id="basic-info" role="tabpanel">
        <div class="border bg-white p-3 mb-3">
            <h6 class="section-title border-bottom pb-2 d-flex justify-content-between align-items-center">기본 정보
                <a href="{% url 'assets:contract_edit' contract.pk %}" class="tag tag-button tag-primary">
                    수정
                </a>
            </h6>
            <table class="table table-bordered table-sm">
                <tr>
                    <th class="bg-light" style="width: 20%;">계약명</th>
                    <td>{{ contract.name }}</td>
                    <th class="bg-light" style="width: 20%;">유형</th>
                    <td>{{ contract.get_contract_type_display }}</td>
                </tr>
                <tr>
                    <th class="bg-light">업체</th>
                    <td>{{ contract.contractor }}</td>
                    <th class="bg-light">금액</th>
                    <td>{{ contract.amount|intcomma }}원</td>
                </tr>
                <tr>
                    <th class="bg-light">계약기간</th>
                    <td colspan="3">{{ contract.start_date|date:"Y-m-d" }} ~ {{ contract.end_date|date:"Y-m-d" }}</td>
                </tr>
            </table>
        </div>

        <div class="border bg-white p-3 mb-3">
            <h6 class="section-title border-bottom pb-2">첨부파일</h6>
            {% if attachments %}
            <div class="list-group">
                {% for attachment in attachments %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-file me-2"></i>
                        <a href="{{ attachment.file.url }}" target="_blank" class="text-decoration-none">
                            {{ attachment.filename }}
                        </a>
                        <small class="text-muted ms-2">
                            ({{ attachment.uploaded_at|date:"Y-m-d" }} by {{ attachment.uploaded_by.profile.display_name }})
                        </small>
                    </div>

                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0">첨부파일이 없습니다.</p>
            {% endif %}
        </div>

        {% include 'assets/partials/_related_systems.html' with systems=contract.systems.all %}

        <div class="border bg-white p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="section-title border-bottom pb-2 mb-0">연관 계약</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr class="text-center">
                            <th>계약명</th>
                            <th>업체</th>
                            <th>관련시스템</th>
                            <th>계약기간</th>
                        </tr>
                    </thead>
                    <tbody id="relatedContractsTable">
                        {% for related in contract.related_contracts.all %}
                        <tr data-contract-id="{{ related.pk }}">
                            <td>
                                <a href="{% url 'assets:contract_detail' related.pk %}" class="text-decoration-none">
                                    {{ related.name }}
                                </a>
                            </td>
                            <td class="text-center">{{ related.contractor }}</td>
                            <td class="text-center">
                                {% for system in related.systems.all %}
                                    {{ system.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </td>
                            <td class="text-center">{{ related.start_date|date:"Y-m-d" }} ~ {{ related.end_date|date:"Y-m-d" }}</td>
                        </tr>
                        {% empty %}
                        <tr id="noRelatedContracts">
                            <td colspan="5" class="text-center py-3">연관된 계약이 없습니다.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% include 'assets/partials/_history_section.html' %}
    </div>

    <!-- Regular Inspection Tab -->
    <div class="tab-pane fade" id="inspection" role="tabpanel">
        <div class="border bg-white p-3 mb-3">
            <h6 class="section-title border-bottom pb-2 mb-3 d-flex justify-content-between align-items-center">점검 이력
            <button type="button" class="tag tag-button tag-primary" data-bs-toggle="modal" data-bs-target="#inspectionModal">
                점검 등록
            </button>
            </h6>
            <div class="table-responsive">
                <table class="table table-bordered">
                    {% if inspections %}
                    <thead>
                        <tr class="text-center">
                            <th>점검월</th>
                            <th>점검일자</th>
                            <th>시스템</th>
                            <th>점검결과</th>
                            <th>첨부파일</th>
                            <th>등록일</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inspection in inspections %}
                        <tr>
                            <td class="text-center">{{ inspection.inspection_month }}</td>
                            <td class="text-center">{{ inspection.inspection_date|date:"Y-m-d" }}</td>
                            <td class="text-center">
                                <a href="{% url 'assets:system_detail' inspection.system.pk %}" class="text-decoration-none">
                                    {{ inspection.system.name }}
                                </a>
                            </td>
                            <td>{{ inspection.result|truncatewords:10 }}</td>
                            <td class="text-start">
                                {% if inspection.attachments.exists %}
                                    {% for attachment in inspection.attachments.all %}
                                        <div><a href="{{ attachment.file.url }}" target="_blank" class="tag tag-button me-1 mb-1" title="{{ attachment.filename }}">
                                               <i class="fas fa-file"></i> {{ attachment.filename }}
                                        </a></div>
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-center">{{ inspection.created_at|date:"Y-m-d" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% else %}
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center py-3">등록된 점검 이력이 없습니다.</td>
                        </tr>
                    </tbody>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
</div>


<div class="mt-3">
    <a href="{% url 'assets:contract_list' %}" class="scl-btn scl-btn-outline scl-btn-sm">
        <i class="fas fa-arrow-left"></i> 목록으로
    </a>
</div>
{% include 'assets/partials/_inspection_modal.html' %}


{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Handle Inspection Form Submission
    $('#inspectionForm').submit(function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(response) {
                if (response.success) {
                    // Reload the page to refresh the list
                    // Store the active tab in localStorage to persist it
                    localStorage.setItem('activeContractTab', '#inspection-tab');
                    location.reload();
                } else {
                    // Handle errors
                    var errorMsg = '오류가 발생했습니다.\n';
                    if (response.errors) {
                        $.each(response.errors, function(field, errors) {
                            errorMsg += field + ': ' + errors.join(', ') + '\n';
                        });
                    }
                    alert(errorMsg);
                }
            },
            error: function() {
                alert('서버 통신 중 오류가 발생했습니다.');
            }
        });
    });

    // Restore active tab if exists
    var activeTab = localStorage.getItem('activeContractTab');
    if (activeTab) {
        var tabTrigger = new bootstrap.Tab($(activeTab));
        tabTrigger.show();
        localStorage.removeItem('activeContractTab'); // Clear after use
    }
});
</script>
{% endblock %}


