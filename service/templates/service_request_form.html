{% extends "base.html" %}

{% block page_name %}
    {{selected_type.name}}
{% endblock %}

{% block content %}
<div class="container border mt-3 mb-1 bg-white p-3">
    <form id="serviceRequestForm" action="{% url 'service_request_create' selected_type.code %}" method="post" enctype="multipart/form-data" class="needs-validation">
                                {% csrf_token %}

                                <div class="row g-3">
                                    <h6 class="mt-4 pb-2 section-title border-bottom">요청 시스템</h6>
                                    <div class="form-group row mt-4 align-items-center">
                                        <label for="req_system" class="form-label col-4 col-sm-2 text-end fw-bold">시스템</label>
                                        <div class="col-8 col-sm-4 col-md-4 mb-2">
                                            <select id="req_system" name="req_system" class="form-select" required>
                                                <option value="">선택</option>
                                                {% for system in systems %}
                                                    <option value="{{ system.name }}">{{ system.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <label for="req_module" class="form-label col-4 col-sm-2 text-end fw-bold">대상 모듈</label>
                                        <div class="col-8 col-sm-4 col-md-4">
                                            <select id="req_module" name="req_module" class="form-select" required>
                                                <option value="">선택</option>
                                                {% for module in modules %}
                                                    <option value="{{ module.name }}">{{ module.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                    </div>
                                    
                                    <h6 class="pb-2 section-title border-bottom">요청 내용</h6>
                                    <div class="form-group row align-items-center ">
                                        <label for="assignee" class="form-label col-sm-2 text-end fw-bold">요청자</label>
                                        <label for="req_depart" class="col-4 col-sm-1 ">부서</label>
                                        <div class="col-8 col-md-2 col-sm-2 mb-2">
                                            <input type="text" id="req_depart" name="req_depart" class="form-control" required>
                                        </div>
                                        <label for="req_name" class="col-4 col-sm-1 ">이름</label>
                                        <div class="col-8 col-sm-2 mb-2">
                                            <input type="text" id="req_name" name="req_name" class="form-control" required>
                                        </div>
                                        <label for="req_email" class="col-4 col-sm-1 ">e-mail</label>
                                        <div class="col-8 col-sm-3">
                                            <input type="email" id="req_email" name="req_email" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="form-group row mt-4">
                                        <label for="date_of_req" class="form-label col-4 col-sm-2 text-end fw-bold" >희망적용일자</label>
                                        <div class="col-8 col-md-2">
                                            <input type="date" id="date_of_req" name="date_of_req" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="form-group row mt-4">
                                        <label for="req_title" class="form-label col-4 col-sm-2 text-end fw-bold">요청제목</label>
                                        <div class="col-8 col-md-10">
                                            <input type="text" id="req_title" name="req_title" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="form-group row mt-4">
                                        <label for="req_reason" class="form-label col-sm-2 text-end fw-bold">요청사유</label>
                                        <div class="col-md-10">
                                            <textarea id="req_reason" name="req_reason" class="form-control" rows="4" style="resize: none;" required></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group row mt-4">
                                        <label for="req_details" class="form-label col-sm-2 text-end fw-bold">요청내용</label>
                                        <div class="col-md-10">
                                            <!--
                                                textarea id="req_details" name="req_details" class="form-control" rows="6" style="resize: none;" required></textarea>
                                            -->
                                            <textarea id="req_details" name="req_details" value="{{ form.req_details.value|default_if_none:'' }}">{{desc|safe}}</textarea>
                                        </div>
                                    </div>
                                    
                                    <h6 class="pb-2 section-title border-bottom">요청 접수</h6>
                                    <div class="form-group row mt-4">
                                        <label for="rcv_opinion" class="form-label col-sm-2 text-end fw-bold">담당부서의견</label>
                                        <div class="col-md-10">
                                            <textarea id="rcv_opinion" name="rcv_opinion" class="form-control" rows="4" required></textarea>

                                        </div>
                                    </div>
                                    <div class="form-group row mt-4 align-items-center">
                                        <label for="date_of_due" class="form-label col-4 col-sm-2 text-end fw-bold">완료예정일자</label>
                                        <div class="col-8 col-md-3 col-sm-4">
                                            <input type="date" id="date_of_due" name="date_of_due" class="form-control" required>
                                        </div>
                                        <label for="effort_expected" class="form-label col-4 col-sm-3 text-end fw-bold" >예상작업시간(M/H)</label>
                                        <div class="col-8 col-md-3 col-sm-3">
                                            <input type="number" id="effort_expected" name="effort_expected" class="form-control" step="0.1" min="0.1" required>
                                        </div>
                                    </div>
                                    <hr>

                                    <!-- 첨부파일 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">첨부파일</label>

                                        <!-- 실제 파일 입력 (숨김) -->
                                        <input type="file" id="fileInput" name="attachments" class="form-control d-none" multiple>

                                        <!-- 추가 버튼 -->
                                        <button type="button" class="scl-btn scl-btn-outline scl-btn-sm mb-2" id="addFileBtn">파일 추가</button>

                                        <!-- 파일 리스트 -->
                                        <ul class="list-group" id="fileList"></ul>
                                    </div>

                                </div>  <!-- End of row -->

                                
                            

    </div>
    <button type="submit" class="scl-btn mt-3">요청 접수</button>
    </form>

{% endblock %}

{% block extra_js %}


<script type="text/javascript">

        $(document).ready(function() {
                //var fontList = ['맑은 고딕','NotoSansKR'];
                $('#req_details').summernote({ 
                    height: 300,                 // 에디터 높이
                    //minHeight: null,             // 최소 높이
                    //maxHeight: null,             // 최대 높이
                    focus: false,                  // 에디터 로딩후 포커스를 맞출지 여부
                    lang: "ko-KR",                    // 한글 설정
                    placeholder: '요청내용을 입력해주세요.'   , //placeholder 설정
                    //fontNames: fontList,
                    //fontNamesIgnoreCheck: fontList,
                    toolbar: [
                    //['style', ['style']],
                    ['font', ['bold', 'underline', 'clear']],
                    //['fontname', ['fontname']], // Add fontname to toolbar
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture', 'video']],
                    //['view', ['fullscreen', 'codeview', 'help']],
                ],
                });
                $('p').css('margin-bottom','0')
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const fileInput = document.getElementById('fileInput');
            const fileList = document.getElementById('fileList');
            const addFileBtn = document.getElementById('addFileBtn');
            const form = document.getElementById('serviceRequestForm');
            let selectedFiles = []; // 사용자가 선택한 파일들을 저장할 배열

            addFileBtn.addEventListener('click', () => {
              fileInput.click();
            });

            fileInput.addEventListener('change', () => {
              const files = Array.from(fileInput.files);
              files.forEach(file => {
                if (selectedFiles.some(f => f.name === file.name)) {
                  alert(`${file.name} 은 이미 추가되었습니다.`);
                  return;
                }

                selectedFiles.push(file);

                const li = document.createElement('li');
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.textContent = file.name;

                const removeBtn = document.createElement('button');
                removeBtn.className = "scl-btn scl-btn-outline scl-btn-sm";
                removeBtn.textContent = "삭제";
                removeBtn.addEventListener('click', () => {
                    selectedFiles = selectedFiles.filter(f => f.name !== file.name);
                    updateFileList();
                  li.remove();
                });

                li.appendChild(removeBtn);
                fileList.appendChild(li);
              });
              fileInput.value = '';
            });
              function updateFileList() {
                fileList.innerHTML = ""; // 리스트 초기화
                selectedFiles.forEach(file => {
                  const li = document.createElement('li');
                  li.className = "list-group-item d-flex justify-content-between align-items-center";
                  li.textContent = file.name;

                  const removeBtn = document.createElement('button');
                  removeBtn.className = "scl-btn scl-btn-outline scl-btn-sm";
                  removeBtn.textContent = "삭제";
                  removeBtn.addEventListener('click', () => {
                      selectedFiles = selectedFiles.filter(f => f.name !== file.name);
                      updateFileList();
                    li.remove();
                  });

                  li.appendChild(removeBtn);
                  fileList.appendChild(li);
                });
              }

            form.addEventListener('submit', (e) => {
              e.preventDefault();

              const formData = new FormData(form);

              selectedFiles.forEach(file => {
                formData.append('attachments', file);
              });

              fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
              })
              .then(response => {
                if (response.redirected) {
                  window.location.href = response.url;
                } else {
                  return response.text();
                }
              })
              .catch(error => {
                console.error('업로드 실패:', error);
                alert("저장 중 오류가 발생했습니다.");
              });
            });
          });
    </script>

{% endblock %}
