{% extends "base.html" %}
{% load static %}
{% load markdown_extras %}


{% block page_name %}
    주간업무 개인별 조회
{% endblock %}
{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800"></h1>

    <!-- Filter Form -->
    <div class="container-fluid border bg-white p-3 mb-4">
        <form method="get" action="{% url 'personal_report_history' %}" class="row g-2 align-items-center w-100">
            <div class="col-md-2 d-flex align-items-center gap-2">
                <label for="user_id" class="fw-bold mb-0" style="white-space: nowrap; min-width: 50px;">팀원:</label>
                <select name="user_id" id="user_id" class="form-select">
                    <option value="">담당자선택</option>
                    {% for member in team_members %}
                    <option value="{{ member.id }}" {% if selected_user_id|stringformat:"s" == member.id|stringformat:"s" %}selected{% endif %}>
                        {{ member.profile.display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-7 d-flex align-items-center gap-2">
                <label for="start_year" class="fw-bold mb-0" style="white-space: nowrap; min-width: 50px;">기간:</label>
                <select name="start_year" id="start_year" class="form-select">
                    {% for year in year_choices %}
                    <option value="{{ year }}" {% if start_year|stringformat:"s" == year|stringformat:"s" %}selected{% endif %}>{{ year }}년</option>
                    {% endfor %}
                </select>
                <select name="start_week" id="start_week" class="form-select">
                </select>
                
                <span class="mx-1">~</span>
                
                <select name="end_year" id="end_year" class="form-select">
                    {% for year in year_choices %}
                    <option value="{{ year }}" {% if end_year|stringformat:"s" == year|stringformat:"s" %}selected{% endif %}>{{ year }}년</option>
                    {% endfor %}
                </select>
                <select name="end_week" id="end_week" class="form-select">
                </select>
            </div>

            <div class="col-md-3 d-flex justify-content-end gap-2">
                <button type="submit" class="scl-btn" style="min-width: 80px;">조회</button>
                <button type="button" id="ai-analysis-btn" class="scl-btn scl-btn--warning" style="min-width: 80px;" {% if not selected_user_id %}disabled{% endif %}>AI 분석</button>
            </div>
        </form>
    </div>

    {% if selected_user_id and worklogs_data %}
    <!-- Report Content -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">조회 결과</h6>
            <div>
                <button id="btn-format1" class="scl-btn scl-btn-sm active">금주/차주</button>
                <button id="btn-format2" class="scl-btn scl-btn-sm scl-btn-outline">전주/금주</button>
            </div>
        </div>
        <div class="card-body">
            <!-- Format 1: This Week / Next Week -->
            <div id="format1-table">
                <div class="table-3-wrapper">
                    <div class="cell cell-2 p-3 col-2 border bg-light text-center fw-bold">주차</div>
                    <div class="cell cell-5 p-3 col-5 border bg-light text-center fw-bold">금주 실적</div>
                    <div class="cell cell-default p-3 col-5 border bg-light text-center fw-bold">차주 계획</div>
                    {% for data in worklogs_data %}
                        <div class="cell cell-2 p-3 col-2 border">{{ data.worklog.year }}년 {{ data.worklog.week_number }}주차</div>
                        <div class="cell cell-5 p-3 col-5 border">
                            <div class="markdown-content">
                                {% if data.worklog.this_week_work %}
                                    {{ data.worklog.this_week_work|markdown }}
                                {% else %}
                                    <p class="text-muted">작성된 내용이 없습니다.</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="cell cell-default p-3 col-5 border">
                            <div class="markdown-content">
                                {% if data.worklog.next_week_plan %}
                                    {{ data.worklog.next_week_plan|markdown }}
                                {% else %}
                                    <p class="text-muted">작성된 계획이 없습니다.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Format 2: Previous Week Plan / This Week -->
            <div id="format2-table" style="display: none;">
                <div class="table-3-wrapper">
                    <div class="cell cell-2 p-3 col-2 border bg-light text-center fw-bold">주차</div>
                    <div class="cell cell-5 p-3 col-5 border bg-light text-center fw-bold">전주 계획</div>
                    <div class="cell cell-default p-3 col-5 border bg-light text-center fw-bold">금주 실적</div>
                     {% for data in worklogs_data %}
                        <div class="cell cell-2 p-3 col-2 border">{{ data.worklog.year }}년 {{ data.worklog.week_number }}주차</div>
                        <div class="cell cell-5 p-3 col-5 border">
                            <div class="markdown-content">
                                {% if data.previous_week_plan %}
                                    {{ data.previous_week_plan|markdown }}
                                {% else %}
                                    <p class="text-muted">작성된 내용이 없습니다.</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="cell cell-default p-3 col-5 border">
                            <div class="markdown-content">
                                {% if data.worklog.this_week_work %}
                                    {{ data.worklog.this_week_work|markdown }}
                                {% else %}
                                    <p class="text-muted">작성된 계획이 없습니다.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% elif selected_user_id %}
    <div class="alert alert-warning">선택된 기간에 해당하는 주간업무 데이터가 없습니다.</div>
    {% endif %}
</div>

<!-- AI Analysis Modal -->
<div class="modal fade" id="ai-analysis-modal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiAnalysisModalLabel">AI 주간업무 분석 결과</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="ai-analysis-loading" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Gemini가 주간업무를 분석하고 있습니다. 잠시만 기다려주세요...</p>
        </div>
        <div id="ai-analysis-result" style="display: none;">
            <!-- Results will be populated here by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="scl-btn scl-btn-sm scl-btn-outline" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Format toggle buttons
    const btnFormat1 = document.getElementById('btn-format1');
    const btnFormat2 = document.getElementById('btn-format2');
    const tableFormat1 = document.getElementById('format1-table');
    const tableFormat2 = document.getElementById('format2-table');

    if (btnFormat1 && btnFormat2 && tableFormat1 && tableFormat2) {
        btnFormat1.addEventListener('click', function() {
            tableFormat1.style.display = 'block';
            tableFormat2.style.display = 'none';
            btnFormat1.classList.add('active');
            btnFormat1.classList.remove('scl-btn-outline');
            btnFormat2.classList.remove('active');
            btnFormat2.classList.add('scl-btn-outline');
        });

        btnFormat2.addEventListener('click', function() {
            tableFormat1.style.display = 'none';
            tableFormat2.style.display = 'block';
            btnFormat2.classList.add('active');
            btnFormat2.classList.remove('scl-btn-outline');
            btnFormat1.classList.remove('active');
            btnFormat1.classList.add('scl-btn-outline');
        });
    }

    // Dynamic week dropdowns
    const weekData = JSON.parse('{{ week_data_json|escapejs }}');
    const startYearSelect = document.getElementById('start_year');
    const startWeekSelect = document.getElementById('start_week');
    const endYearSelect = document.getElementById('end_year');
    const endWeekSelect = document.getElementById('end_week');

    const selectedStartWeek = '{{ start_week }}';
    const selectedEndWeek = '{{ end_week }}';

    function updateWeekOptions(yearSelect, weekSelect, selectedWeek) {
        const selectedYear = yearSelect.value;
        const weeks = weekData[selectedYear] || [];
        
        weekSelect.innerHTML = '';

        weeks.forEach(function(weekInfo) {
            const option = document.createElement('option');
            option.value = weekInfo.week;
            option.textContent = weekInfo.display;
            if (String(weekInfo.week) === selectedWeek) {
                option.selected = true;
            }
            weekSelect.appendChild(option);
        });
    }

    startYearSelect.addEventListener('change', function() { updateWeekOptions(startYearSelect, startWeekSelect, null); });
    endYearSelect.addEventListener('change', function() { updateWeekOptions(endYearSelect, endWeekSelect, null); });

    updateWeekOptions(startYearSelect, startWeekSelect, selectedStartWeek);
    updateWeekOptions(endYearSelect, endWeekSelect, selectedEndWeek);

    // AI Analysis
    const aiAnalysisBtn = document.getElementById('ai-analysis-btn');
    const aiAnalysisModal = new bootstrap.Modal(document.getElementById('ai-analysis-modal'));
    const analysisResultDiv = document.getElementById('ai-analysis-result');
    const analysisLoadingDiv = document.getElementById('ai-analysis-loading');

    function getIsoWeekDate(y, w, d) {
        var simple = new Date(Date.UTC(y, 0, 1 + (w - 1) * 7));
        var dow = simple.getUTCDay();
        var ISOweekStart = simple;
        if (dow <= 4)
            ISOweekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
        else
            ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
        ISOweekStart.setUTCDate(ISOweekStart.getUTCDate() + d - 1);
        return ISOweekStart;
    }

    if (aiAnalysisBtn) {
        aiAnalysisBtn.addEventListener('click', function() {
            const selectedUserId = document.getElementById('user_id').value;
            if (!selectedUserId) {
                alert('분석할 팀원을 선택해주세요.');
                return;
            }

            const endYear = document.getElementById('end_year').value;
            const endWeek = document.getElementById('end_week').value;

            analysisResultDiv.style.display = 'none';
            analysisLoadingDiv.style.display = 'block';
            aiAnalysisModal.show();

            const asOfDate = getIsoWeekDate(parseInt(endYear), parseInt(endWeek), 7); // Get Sunday of the week
            const asOfDateString = asOfDate.toISOString().split('T')[0];

            fetch(`/me/review?user_id=${selectedUserId}&as_of=${asOfDateString}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                    }
                    return response.json();
                })
                .then(data => {
                    analysisLoadingDiv.style.display = 'none';
                    analysisResultDiv.innerHTML = formatAnalysisResult(data);
                    analysisResultDiv.style.display = 'block';

                    // Initialize tooltips for the new content
                    const tooltipTriggerList = analysisResultDiv.querySelectorAll('[data-bs-toggle="tooltip"]');
                    [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl, { html: true }));
                })
                .catch(error => {
                    analysisLoadingDiv.style.display = 'none';
                    analysisResultDiv.innerHTML = `<div class="alert alert-danger">분석 중 오류가 발생했습니다: ${error.message}</div>`;
                    analysisResultDiv.style.display = 'block';
                });
        });
    }

    function formatMonthWeek(isoDate) {
        if (!isoDate) return '';
        try {
            // AI가 반환하는 날짜 문자열(예: '2025-10-06')을 파싱합니다.
            const d = new Date(isoDate);
            // UTC 기준 월/일을 사용하여 시간대 문제를 방지합니다.
            const month = d.getUTCMonth() + 1;
            const date = d.getUTCDate();
            const weekOfMonth = Math.ceil(date / 7);
            return `${month}월 ${weekOfMonth}주차`;
        } catch (e) {
            return isoDate; // 오류 발생 시 원본 문자열 반환
        }
    }

    function formatAnalysisResult(data) {
        if (data.error) {
            return `<div class="alert alert-warning"><strong>AI 분석 실패</strong><br>${data.error}</div>`;
        }

        let html = `<h6 class="m-0 font-weight-bold text-primary">${data.summary}</h6><hr>`;

        // Metrics
        html += '<h5>주요 지표</h5><div class="row text-center mb-3">';
        const metrics = data.metrics;

        const createMetricCard = (title, metric) => {
            const detailsHtml = (metric && metric.details && metric.details.length > 0) ? `<ul class="list-unstyled mb-0 text-start">${metric.details.map(d => `<li>- ${d}</li>`).join('')}</ul>` : '상세 내역 없음';
            const metricValue = (metric && metric.value !== undefined) ? metric.value : 0;
            const safeDetailsHtml = detailsHtml.replace(/"/g, '&quot;');

            return `
                <div class="col">
                    <div class="card p-2" data-bs-toggle="tooltip" title="${safeDetailsHtml}">
                        <h6>${title}</h6>
                        <h3>${metricValue}</h3>
                    </div>
                </div>
            `;
        };
        
        const createRateMetricCard = (title, metric) => {
            const detailsHtml = (metric && metric.details && metric.details.length > 0) ? `<ul class="list-unstyled mb-0 text-start">${metric.details.map(d => `<li>- ${d}</li>`).join('')}</ul>` : '상세 내역 없음';
            const metricValue = (metric && metric.value !== undefined) ? metric.value : 0;
            const safeDetailsHtml = detailsHtml.replace(/"/g, '&quot;');

            return `
                <div class="col">
                    <div class="card p-2" data-bs-toggle="tooltip" title="${safeDetailsHtml}">
                        <h6>${title}</h6>
                        <h3>${(metricValue).toFixed(0)}%</h3>
                    </div>
                </div>
            `;
        };

        html += createMetricCard('계획', metrics.planned_count);
        html += createMetricCard('실행', metrics.done_count);
        html += createRateMetricCard('완료율', metrics.completion_rate);
        html += createMetricCard('이월', metrics.carryover_count);
        html += createMetricCard('증빙부족', metrics.missing_evidence_count);
        html += '</div><hr>';

        // Mismatches
        if (data.mismatches && data.mismatches.length > 0) {
            html += '<h5 class="mt-4">계획-실적 불일치</h5><ul class="list-group list-group-flush">';
            data.mismatches.forEach(item => {
                html += `<li class="list-group-item"><strong>${formatMonthWeek(item.week)}:</strong> ${item.plan_item} <br> <span class="ps-3 text-danger">-> ${item.issue}</span></li>`;
            });
            html += '</ul><hr>';
        }

        // Risks
        if (data.risks && data.risks.length > 0) {
            html += '<h5 class="mt-4">리스크 및 우려사항</h5><div class="table-responsive"><table class="table table-sm table-bordered"><thead><tr><th>내용</th><th>상태</th><th>담당</th><th>조치</th><th>기한</th></tr></thead><tbody>';
            data.risks.forEach(risk => {
                html += `<tr><td>${risk.description}</td><td>${risk.status}</td><td>${risk.owner}</td><td>${risk.next_action}</td><td>${risk.due}</td></tr>`;
            });
            html += '</tbody></table></div><hr>';
        }

        // Recommendations
        if (data.recommendations && data.recommendations.length > 0) {
            html += '<h5 class="mt-4">개선 권고 사항</h5><ul class="list-group">';
            data.recommendations.forEach(rec => {
                html += `<li class="list-group-item">${rec}</li>`;
            });
            html += '</ul>';
        }

        return html;
    }
});
</script>


{% endblock %}